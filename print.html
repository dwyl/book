<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>dwyl book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        <script defer data-domain="dwyl.github.io" src="https://plausible.io/js/script.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        
        <!-- additional languages -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/elixir.min.js"></script>
        
        <script>hljs.highlightAll();</script>

        <meta name="description" content="The @dwyl book on Web &amp; Mobile Application Development">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="auth/index.html"><strong aria-hidden="true">1.</strong> Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="auth/00-why.html"><strong aria-hidden="true">1.1.</strong> Why build Auth?</a></li><li class="chapter-item expanded "><a href="auth/01-what.html"><strong aria-hidden="true">1.2.</strong> What are we building?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="auth/02-database-schema-review.html"><strong aria-hidden="true">1.2.1.</strong> Quick Review of Old Database Schema</a></li></ol></li><li class="chapter-item expanded "><a href="auth/03-how.html"><strong aria-hidden="true">1.3.</strong> How?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="auth/04-prerequisites.html"><strong aria-hidden="true">1.3.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="auth/05-mix-phx-new.html"><strong aria-hidden="true">1.3.2.</strong> Create New Phoenix Project</a></li><li class="chapter-item expanded "><a href="auth/06-mix-gen-auth.html"><strong aria-hidden="true">1.3.3.</strong> Generate Auth Schema</a></li><li class="chapter-item expanded "><a href="auth/07-notes-on-naming.html"><strong aria-hidden="true">1.3.4.</strong> Notes on Naming</a></li><li class="chapter-item expanded "><a href="auth/08-modals-antipattern.html"><strong aria-hidden="true">1.3.5.</strong> Modals Are An Antipattern</a></li><li class="chapter-item expanded "><a href="auth/09-encrypt-data.html"><strong aria-hidden="true">1.3.6.</strong> Encrypt Personal Data</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="atm/index.html"><strong aria-hidden="true">2.</strong> ATM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="atm/01-browser-agent.html"><strong aria-hidden="true">2.1.</strong> Parse User Agent</a></li><li class="chapter-item expanded "><a href="atm/02-gen-schema-user_agents.html"><strong aria-hidden="true">2.2.</strong> User Agent Schema</a></li></ol></li><li class="chapter-item expanded "><a href="mvp/index.html"><strong aria-hidden="true">3.</strong> MVP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mvp/15-item-cid.html"><strong aria-hidden="true">3.1.</strong> Cids</a></li><li class="chapter-item expanded "><a href="mvp/16-lists.html"><strong aria-hidden="true">3.2.</strong> Lists</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mvp/16a-default-lists.html"><strong aria-hidden="true">3.2.1.</strong> Default Lists</a></li></ol></li><li class="chapter-item expanded "><a href="mvp/18-reordering.html"><strong aria-hidden="true">3.3.</strong> Reordering</a></li><li class="chapter-item expanded "><a href="mvp/20-stats.html"><strong aria-hidden="true">3.4.</strong> Stats</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dwyl book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dwyl/book/tree/main/src" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="intro"><a class="header" href="#intro">Intro</a></h1>
<p>Our aim with writing a <code>book</code> 
is to <strong><em>comprehensively</em> document</strong>
<strong><em>everything</em> we learned</strong> 
while building our 
<a href="https://github.com/dwyl/app"><strong><code>App</code></strong></a>
and 
<strong><code>API</code></strong>
in a <em>single</em> place.</p>
<p>This is the 
<a href="https://en.wikipedia.org/wiki/Handbook"><strong>handbook</strong></a>
we <em>wish</em> we had 
when we started our journey.
Our goal is to have a book 
that <em>anyone</em> can use 
to learn <em>exactly</em> how we build/built
<em>every</em> aspect of our <code>App</code>. </p>
<p>We have already written over 
<strong>100 stand-alone tutorials</strong>
for various technologies/tools/frameworks.
See:
<a href="https://github.com/dwyl?q=learn">dwyl?q=<strong>learn</strong></a> <br />
The <em>advantage</em> of 
<strong>standalone/self-contained tutorials</strong>
is that they are 
<strong><em>focussed</em> on one thing</strong>.
The disadvantage 
is that they lack clear progression.
So people can be left asking:
&quot;<strong>What <em>next</em></strong>?&quot;
By contrast the objective in the <code>book</code>
is to have a <strong><em>very</em> clear progression</strong>.</p>
<p>If you click the &quot;Print&quot; icon 
in the top-right of this screen: ‚ÜóÔ∏è</p>
<img width="97" alt="image" src="https://user-images.githubusercontent.com/194400/219624215-3d780055-5151-4e2e-8632-893578c4412b.png">
<p>You can save a PDF copy of the book 
and read it <em><strong>offline</strong></em> in your own time
without any distractions.
Or if you have good internet,
you can follow along 
and <em>build</em> the <code>App</code> step-by-step.</p>
<p>One day, <em>all</em> software will be Open Source.
This is our small contribution to that end.</p>
<p>If you agree with the idea
that software should be Open to <em>anyone</em>,
please let us know! üôè
&quot;Star&quot; the repo on <code>GitHub</code>
<a href="https://github.com/dwyl/book">dwyl/book</a> ‚≠ê</p>
<p>With that out of the way,
let's get started learning by <em>doing</em>! üöÄ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auth"><a class="header" href="#auth"><code>auth</code></a></h1>
<p>We built a <strong><em>complete</em> cohesive <code>auth</code> system</strong> 
because <em>nothing</em> we found 
met our requirements
for simplicity, security and speed.</p>
<p><img src="https://user-images.githubusercontent.com/194400/218912832-e46b0206-8dbd-4589-8cbf-6a160610b580.png" alt="auth-flow" /></p>
<p>Read our reasoning
and journey in the next few pages.</p>
<p>At the very least you can 
see if you <em>agree</em> (or not)
with our approach.</p>
<p>As always,
your feedback is very much welcome. üôè</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="why-custom-build-auth"><a class="header" href="#why-custom-build-auth">Why <em>Custom</em> Build Auth?</a></h1>
<p>After a couple of decades of writing code
and <em>studying</em> 30+ CMS/Frameworks 
&amp; Enterprise Auth providers
we concluded 
that all the Authentication/Authorization
systems are still <strong><em>way</em> too complex</strong>
and required <strong><em>far</em> too many steps</strong>.</p>
<p>Rather than lock ourselves into 
something complex and then 
be stuck with slow/no progress,
we decided to build something from scratch
that would allow us to <strong>move <em>much</em> faster</strong>
in the <em>long</em> run.</p>
<p>We have documented <em>all</em> the steps taken
in creating our <code>auth</code> system.
The code is well tested and maintained
so <em>anyone</em> can read how it all works.</p>
<h2 id="the-best-way-to-understand-something-is-to-build-it"><a class="header" href="#the-best-way-to-understand-something-is-to-build-it">The Best Way to <em>Understand</em> Something is to <em>Build</em> It!</a></h2>
<p>We <em>encourage</em> anyone interested
in <em>understanding</em> 
how things work behind the scenes
to read through the <code>auth</code> chapters.
We've attempted to include <em>all</em> the steps
we took so that anyone can grok it.</p>
<p>However we know this is not the most <em>exciting</em> 
part of the application stack. 
If you prefer to skip the <code>auth</code> section entirely,
you can just <em>use</em> it 
and treat it as a &quot;service&quot; that &quot;Just Works<sup>TM</sup>&quot;
and only refer to specific parts when needed.</p>
<h2 id="why-re-build-auth"><a class="header" href="#why-re-build-auth">Why <em>Re-build</em> <code>Auth</code>?</a></h2>
<p>We learned a <em>lot</em> from building our <code>first</code> version
of <code>auth</code> in <code>Elixir</code>.
Our &quot;Version 1&quot; has been working in production for several years
and thousands of people have used it successfully.
The UI/UX for the &quot;end-user&quot; is fine;
it's <em>fast</em> and already does what we need.
We aren't going to change what the <code>person</code> <em>using</em> <code>auth</code>
see very much in the next iteration.
What is <strong><em>not</em> fine</strong> is the <em>maintainability</em> 
and thus <em>extensibility</em> of the project.
We recently saw this when we tried 
to add a <code>new</code> feature to <code>auth</code>,
but we saw <code>Ecto</code> constraint errors.  </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-are-we-building"><a class="header" href="#what-are-we-building">What Are We Building?</a></h1>
<p>We are building a <strong><em>complete</em> authentication system</strong> 
that <em>anyone</em> can use
to protect the personal data 
of the <code>people</code> using an <code>App</code>.</p>
<p>While we are starting from scratch 
with zero code,
we aren't working in a vacuum 
or blinkered/blindfolded.
We have build <code>auth</code>
before in <code>PHP</code>, <code>Python</code>
<a href="https://github.com/dwyl/hapi-auth-jwt2"><code>JavaScript/TypeScript</code></a>
and most recently 
<code>Elixir</code>
and have <em>used</em>
and <em>studied</em>
several <code>auth</code> systems.
This is an 
<a href="https://en.wiktionary.org/wiki/otaku">otaku</a>
for us;
an obsession
not just a side-project.
If you feel that the <code>UI/UX</code> 
of authentication is one 
of the most important aspects
of building any App,
please read on. </p>
<h2 id="starting-point"><a class="header" href="#starting-point">Starting Point?</a></h2>
<p>As noted above,
we are starting from scratch
so there is zero &quot;baggage&quot; or &quot;legacy&quot;,
but we are <em>informed</em> by our previous iterations of <code>auth</code>. </p>
<p>Let's start by picking holes in our previous design.</p>
<blockquote>
<p><strong>Note</strong>: the objective of analysing our <em>own</em> code/design
is not &quot;criticism&quot;,
it's <em>reflection</em>, <em>learning</em> and <em>continuous improvement</em>. </p>
</blockquote>
<h3 id="old-databse-entity-relational-diagram-erd"><a class="header" href="#old-databse-entity-relational-diagram-erd"><em>Old</em> Databse Entity Relational Diagram (ERD)</a></h3>
<p>This is the ERD of the <em>old</em> version of <code>auth</code>:</p>
<img width="1177" alt="image" src="https://user-images.githubusercontent.com/194400/218709796-0ef83fd1-7e20-4c95-8817-76598ca0f1f7.png">
<p>If this diagram looks &quot;complicated&quot; to you right now,
don't worry, we <em>agree</em>! 
We're only sharing it here as a <em>reference</em>.
It is not the &quot;goal&quot; to recreate this.
Rather, our objective is to <em>simplify</em> it
and remove any tables that we don't <em>need</em>.
For example: 
we will remove the 
<code>tags</code>, <code>status</code>, <code>roles</code>
tables from the database
and instead define these exclusively in code.
The reasoning is simple:
this data does not change very often.
So having it in <code>Postgres</code> and forcing
a join for every query that requires the data
is immensely resource-wasteful.</p>
<p>Yes, the database purists would say:
&quot;all data should be in the database&quot;.
And &quot;old us&quot; would <em>agree</em> with that
<a href="https://en.wikipedia.org/wiki/Dogma">dogma</a>.
But what we've discovered in <em>practice</em>,
is that we can define <em>metadata</em>
in code and <em>significantly</em> 
improve both reasoning about the entity relationships
and query performance.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database-schema-review"><a class="header" href="#database-schema-review">Database Schema Review</a></h1>
<p>If you prefer to start with a blank slate,
feel free to skip this page.</p>
<p>Final snapshot of diagram: </p>
<img width="1163" alt="image" src="https://user-images.githubusercontent.com/194400/218710979-1331f056-01db-40dc-8b31-fad0d47565fa.png">
<p>Without much knowledge of database schemas, 
if you just pay <em>close</em> attention, 
you'll see that that the <strong><code>person_id</code></strong> relationship  (<strong><code>foreign key</code></strong>)
is not correctly defined on 3 tables: <strong><code>apikeys</code></strong>, <strong><code>apps</code></strong> and <strong><code>roles</code></strong>.</p>
<p><img width="1176" alt="auth-erd-person_id-fk-incomplete" 
  src="https://user-images.githubusercontent.com/194400/218711765-51d6c582-7465-444f-8c75-bcbe3f03c13d.png"></p>
<p>This has caused me/us no end of pain while trying to add new features ... 
<a href="https://github.com/dwyl/auth/pull/231#issuecomment-1345762532">auth/pull/231</a></p>
<p>So, in <em>addition</em> to <em>dramatically</em> simplifying the database schema, 
I will make sure that all the <code>Ecto</code> relationships are well-defined 
so that we don't run into annoying constraint errors in the future.</p>
<p>If we <em>start</em> by deleting the tables that we don't <em>need</em>, we <em>immediately</em> simplify the ERD:</p>
<p><img width="1285" alt="image" 
  src="https://user-images.githubusercontent.com/194400/218715031-91969a04-4f56-4da3-bf25-d3ae2945f25d.png"></p>
<p>If we manually edit the diagram to include the <code>person_id</code> links (foreign keys): </p>
<p><img width="1274" alt="auth-erd-tables-removed-person_id-edited" 
  src="https://user-images.githubusercontent.com/194400/218716741-ae49971f-98b5-46b8-9493-fcd8a815f6cd.png"></p>
<p>It becomes clearer what data &quot;belongs&quot; to a <code>person</code>. 
But we can immediately spot something that incomplete/incorrect:
<em><strong>who</strong></em> does a <code>group</code> &quot;belong&quot; to? ü§∑‚Äç‚ôÇÔ∏è </p>
<p>Obviously it's &quot;unfair&quot; to pick holes in a feature that is incomplete.
But it's &quot;broken&quot; and we (I) need to learn from it. üí≠ </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-build-auth-from-first-principals"><a class="header" href="#how-to-build-auth-from-first-principals">How To Build <code>Auth</code> From First Principals</a></h1>
<p>For the past 2 iterations,
we have use the <code>Phoenix</code> Web Application framework
to build our <code>Auth</code> system.
The reasons for this choice
are outlined in:
<a href="https://github.com/dwyl/technology-stack#phoenix">dwyl/<strong>technology-stack</strong>#<strong>phoenix</strong></a>
so won't be repeat it here.
<code>Phoenix</code> is a &quot;batteries included&quot; framework
that includes <em>many</em> features out-of-the-box.</p>
<p>Our <strong><code>Auth</code> system</strong> is a <strong>standalone <code>Phoenix</code> instance</strong>
that has its' own <strong><em>separate</em> database</strong>.
This is a very <em>deliberate</em> choice.
We want to enforce a <em>complete</em> 
<a href="https://en.wikipedia.org/wiki/Separation_of_concerns"><strong>separation of concerns</strong></a>
between <code>Auth</code> 
and the <code>App</code> that <em>uses</em> <code>Auth</code>.</p>
<p>@TODO: insert diagram illustrating relationship between <code>Auth</code> and <code>App</code>.</p>
<p>Beyond the security benefits 
of separating <code>Auth</code> 
the practical rationale is simple:
the code for building an <code>Auth</code> system 
is 
<a href="https://en.wiktionary.org/wiki/KLOC#Noun"><code>~3kloc</code></a>
see: 
<a href="https://en.wikipedia.org/wiki/Source_lines_of_code">wikipedia.org/Source_lines_of_code</a>
If we include all the <code>Auth</code> code in our main <code>App</code>
it adds to the <strong>complexity</strong> of the <code>App</code>
and thus increase the time 
it takes someone to
<a href="https://en.wikipedia.org/wiki/Grok">grok</a>.
The longer it takes people to <em>understand</em> the <code>App</code> code 
the less likely they are to <em>contribute</em> to the <code>App</code>.</p>
<blockquote>
<p><strong>Note</strong>: we are <em>not</em> suggesting 
that people should not <em>also</em> 
<code>try</code> to understand what <code>Auth</code> is doing. 
On the contrary we want as many people as possible 
to understand all aspects of our stack.
However we acknowledge that <code>Auth</code>
and &quot;People Management&quot; 
is not the most <em>interesting</em> part of the stack.
It's akin to the &quot;plumbing&quot; in your home.
Absolutely necessary 
and needs to function <em>flawlessly</em>.
But not something you <em>actively</em> think about
unless there's something that isn't working as expected ... </p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<p>Before you start building <code>auth</code>,
ensure that you have the following on your computer:</p>
<h2 id="latest-elixir"><a class="header" href="#latest-elixir">Latest <code>Elixir</code></a></h2>
<p>In your terminal,
run the following command:</p>
<pre><code class="language-sh">elixir -v
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">Erlang/OTP 25 [erts-13.1.4] [64-bit] [smp:10:10] [async-threads:1] [jit] [dtrace]

Elixir 1.14.3 (compiled with Erlang/OTP 25)
</code></pre>
<p>This is the latest and greatest version 
of <code>Elixir</code> and <code>OTP</code>
at the time of writing. 
<a href="https://github.com/elixir-lang/elixir/tags">github.com/elixir-lang/elixir/tags</a></p>
<blockquote>
<p><strong>Note</strong>: if you have a <em>later</em> version,
please consider creating a <code>Pull Request</code> 
to update this section of the book.</p>
</blockquote>
<h2 id="latest-phoenix"><a class="header" href="#latest-phoenix"><em>Latest</em> <code>Phoenix</code></a></h2>
<p>Visit: 
<a href="https://github.com/phoenixframework/phoenix/tags">github.com/phoenixframework/phoenix/tags</a>
to remind yourself 
of what the most recent version of <code>Phoenix</code> is.
I our case, <a href="https://phoenixframework.org/blog/phoenix-1.7-final-released"><code>v1.7.0</code></a>,
so that's what we are using.</p>
<p>Confirm that you have the latest version of <code>Phoenix</code>
by running the command:</p>
<pre><code class="language-sh">mix phx.new -v
</code></pre>
<p>You should see something similar to:</p>
<pre><code class="language-sh">Phoenix installer v1.7.0
</code></pre>
<blockquote>
<p><strong>Note</strong>: if the version of <code>Phoenix</code> you are using
is more recent than this, 
please help us to update our docs:</p>
</blockquote>
<p>If you don't already have 
the latest version of <code>Phoenix</code>,
run the command: </p>
<pre><code class="language-sh">mix archive.install hex phx_new
</code></pre>
<h2 id="postgresql-server"><a class="header" href="#postgresql-server"><code>PostgreSQL</code> Server</a></h2>
<p><em>Confirm</em> <strong>PostgreSQL</strong> is running 
(<em>so data can be stored</em>)
run the following command:</p>
<pre><code class="language-sh">lsof -i :5432
</code></pre>
<p>You should see output <em>similar</em> to the following:</p>
<pre><code class="language-sh">COMMAND  PID  USER   FD  TYPE DEVICE                  SIZE/OFF NODE NAME
postgres 529 Nelson  5u  IPv6 0xbc5d729e529f062b      0t0  TCP localhost:postgresql (LISTEN)
postgres 529 Nelson  6u  IPv4 0xbc5d729e55a89a13      0t0  TCP localhost:postgresql (LISTEN)
</code></pre>
<p>This tells us that PostgreSQL is &quot;<em>listening</em>&quot; on TCP Port <code>5432</code>
(<em>the default port</em>)</p>
<p>If the <code>lsof</code> command does not yield any result
in your terminal,
run:</p>
<pre><code class="language-sh">pg_isready
</code></pre>
<p>It should print the following:</p>
<pre><code class="language-sh">/tmp:5432 - accepting connections
</code></pre>
<p>With all those 
<a href="https://en.wikipedia.org/wiki/Preflight_checklist">&quot;pre-flight checks&quot;</a> 
performed, let's <em>fly</em>! üöÄ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-the-new-auth-phoenix-project"><a class="header" href="#create-the-new-auth-phoenix-project">Create The New <code>Auth</code> Phoenix Project</a></h1>
<p>In an empty working directory,
using the 
<a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.New.html"><code>mix phx.new</code></a>
generator,
create a new <code>Phoenix</code> project
called &quot;auth&quot;:</p>
<pre><code class="language-sh">mix phx.new auth
</code></pre>
<p>That will create a bunch of files.
Most of them are &quot;boilerplate&quot; code 
for configuring the <code>Phoenix</code> project
and a load of <code>components</code>.
We will use some of them and <code>delete</code>
the rest. </p>
<h2 id="run-the-phoenix-app"><a class="header" href="#run-the-phoenix-app">Run the <code>Phoenix</code> App</a></h2>
<p>Once the dependencies are installed,
run the following command in your terminal: </p>
<pre><code class="language-sh">mix setup
</code></pre>
<p>Once everything is setup,
run the <code>Phoenix</code> app 
with the command:</p>
<pre><code class="language-sh">mix phx.server
</code></pre>
<p>Open your web browser to: 
<code>http://localhost:4000</code></p>
<p>You should see something similar to the following: </p>
<p><img src="https://user-images.githubusercontent.com/194400/221915847-cfd297f0-52ab-46f2-8e0a-bd58abad971a.png" alt="default-phoenix-homepage" /></p>
<h2 id="run-the-tests"><a class="header" href="#run-the-tests">Run the Tests</a></h2>
<p>Just to confirm everything is working,
run the tests with the following command:</p>
<pre><code class="language-sh">mix test
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">Compiling 4 files (.ex)
Generated auth app
.....
Finished in 0.1 seconds (0.05s async, 0.05s sync)
5 tests, 0 failures

Randomized with seed 50114
</code></pre>
<p>With that out of the way,
let's build!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generate-auth-files"><a class="header" href="#generate-auth-files">Generate Auth Files</a></h1>
<p>In <code>auth v1</code> the 
<a href="https://github.com/phoenixframework/phoenix/blob/v1.7.1/guides/authentication/mix_phx_gen_auth.md#L1"><code>mix phx.gen.auth</code></a> 
generator 
<a href="https://github.com/dwyl/auth/issues/207">didn't exist</a>
so we had to hand-write all the code. 
For <code>auth v2</code><br />
we are using the <code>phx.gen.auth</code> &quot;generator&quot; 
to provide some of the scaffolding
and session management.
see:
<a href="https://hexdocs.pm/phoenix/mix_phx_gen_auth.html">hexdocs.pm/phoenix/mix_phx_gen_auth</a></p>
<p>In your terminal, run th following command: </p>
<pre><code class="language-sh">mix phx.gen.auth Accounts Person people
</code></pre>
<p>The generator prompts with the following question:</p>
<pre><code class="language-sh">An authentication system can be created in two different ways:
- Using Phoenix.LiveView (default)
- Using Phoenix.Controller only
Do you want to create a LiveView based authentication system? [Yn]
</code></pre>
<p>We answered <code>N</code> (No) 
because we will be adding more advanced <code>auth</code> </p>
<pre><code class="language-sh">* creating priv/repo/migrations/20230226095715_create_people_auth_tables.exs
* creating lib/auth/accounts/person_notifier.ex
* creating lib/auth/accounts/person.ex
* creating lib/auth/accounts/person_token.ex
* creating lib/auth_web/person_auth.ex
* creating test/auth_web/person_auth_test.exs
* creating lib/auth_web/controllers/person_session_controller.ex
* creating test/auth_web/controllers/person_session_controller_test.exs
* creating lib/auth_web/controllers/person_confirmation_html.ex
* creating lib/auth_web/controllers/person_confirmation_html/new.html.heex
* creating lib/auth_web/controllers/person_confirmation_html/edit.html.heex
* creating lib/auth_web/controllers/person_confirmation_controller.ex
* creating test/auth_web/controllers/person_confirmation_controller_test.exs
* creating lib/auth_web/controllers/person_registration_html/new.html.heex
* creating lib/auth_web/controllers/person_registration_controller.ex
* creating test/auth_web/controllers/person_registration_controller_test.exs
* creating lib/auth_web/controllers/person_registration_html.ex
* creating lib/auth_web/controllers/person_reset_password_html.ex
* creating lib/auth_web/controllers/person_reset_password_controller.ex
* creating test/auth_web/controllers/person_reset_password_controller_test.exs
* creating lib/auth_web/controllers/person_reset_password_html/edit.html.heex
* creating lib/auth_web/controllers/person_reset_password_html/new.html.heex
* creating lib/auth_web/controllers/person_session_html.ex
* creating lib/auth_web/controllers/person_session_html/new.html.heex
* creating lib/auth_web/controllers/person_settings_html.ex
* creating lib/auth_web/controllers/person_settings_controller.ex
* creating lib/auth_web/controllers/person_settings_html/edit.html.heex
* creating test/auth_web/controllers/person_settings_controller_test.exs
* creating lib/auth/accounts.ex
* injecting lib/auth/accounts.ex
* creating test/auth/accounts_test.exs
* injecting test/auth/accounts_test.exs
* creating test/support/fixtures/accounts_fixtures.ex
* injecting test/support/fixtures/accounts_fixtures.ex
* injecting test/support/conn_case.ex
* injecting config/test.exs
* injecting mix.exs
* injecting lib/auth_web/router.ex
* injecting lib/auth_web/router.ex - imports
* injecting lib/auth_web/router.ex - plug
* injecting lib/auth_web/components/layouts/root.html.heex

Please re-fetch your dependencies with the following command:

    $ mix deps.get

Remember to update your repository by running migrations:

    $ mix ecto.migrate

Once you are ready, visit &quot;/people/register&quot;
to create your account and then access &quot;/dev/mailbox&quot; to
see the account confirmation email.
</code></pre>
<p>That's a <em>lot</em> of code. 
See the <code>git</code> commit:
<a href="https://github.com/dwyl/auth/commit/90086a83c6968573f7d4c72b3882a247ac30112d"><code>90086a8</code></a>.
We will use the session management 
in our <code>auth</code> system
and <code>delete</code> some of the unused code along the way. </p>
<h2 id="migrate-the-schema"><a class="header" href="#migrate-the-schema">Migrate the Schema</a></h2>
<p>When you run:</p>
<pre><code class="language-sh">mix ecto.migrate
</code></pre>
<p>You will see the following output:</p>
<pre><code class="language-sh">Generated auth app

15:04:11.168 [info] == Running 20230226095715 Auth.Repo.Migrations.CreatePeopleAuthTables.change/0 forward

15:04:11.173 [info] execute &quot;CREATE EXTENSION IF NOT EXISTS citext&quot;

15:04:11.285 [info] create table people

15:04:11.296 [info] create index people_email_index

15:04:11.297 [info] create table people_tokens

15:04:11.302 [info] create index people_tokens_person_id_index

15:04:11.307 [info] create index people_tokens_context_token_index

15:04:11.310 [info] == Migrated 20230226095715 in 0.1s
</code></pre>
<h2 id="schema"><a class="header" href="#schema">Schema</a></h2>
<p>Let's take a quick look
at the created database tables.</p>
<p>If you open the <code>auth_dev</code> 
database in your Postgres GUI,
e.g:
<a href="https://github.com/dwyl/learn-postgresql/issues/43"><code>DBEaver</code></a> <br />
and view the 
<a href="https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model">ERD</a>
there are only two tables:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223881258-be77ebdc-0114-4606-aac1-065f172b6727.png" alt="mix-phx-gen-auth-erd" /></p>
<h3 id="data-in-people-and-people_tokens-tables"><a class="header" href="#data-in-people-and-people_tokens-tables">Data in <code>people</code> and <code>people_tokens</code> tables</a></h3>
<p>By default,
<code>mix phx.gen.auth</code> 
does not setup any <em>protection</em> 
for personal data in the database.
Email addresses are stored in-the-clear: üôÑ </p>
<p><img src="https://user-images.githubusercontent.com/194400/223880353-98597d83-cb9c-424d-bcb0-2121ecd743c0.png" alt="mix-phx-gen-auth-people-table-email-plaintext" /></p>
<p>Similarly the <code>people_tokens</code> table stores <code>email</code> addresses as <strong><code>plaintext</code></strong> in the <code>sent_to</code> column:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223948397-6984b456-8612-492b-bb79-84442c8b4241.png" alt="people_token-email-plaintext" /></p>
<p>This is <strong><em>obviously</em> undesirable</strong>. üôÉ 
This is a privacy/security issue
waiting to become a scandal!
We will address this <em>swiftly</em>
in the following pages.</p>
<p>But first, tests!</p>
<h2 id="run-the-tests-1"><a class="header" href="#run-the-tests-1">Run The Tests</a></h2>
<p>Sadly, the <code>phx.gen.auth</code> 
there to be a bunch of routes 
hard-coded with the &quot;/user&quot; prefix in the tests
e.g: 
<a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/test/auth_web/controllers/person_session_controller_test.exs#L15"><code>test/auth_web/controllers/person_session_controller_test.exs#L15</code></a></p>
<p>The generator doesn't respect 
the fact that we call them <strong><code>people</code></strong>
when we invoked the command above. 
so if you run the tests:</p>
<pre><code class="language-sh">mix test
</code></pre>
<p>You will see several warnings:</p>
<pre><code class="language-sh">.warning: no route path for AuthWeb.Router matches &quot;/users/log_out&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:40: AuthWeb.PersonRegistrationControllerTest.&quot;test POST /people/register creates account and logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/log_out&quot;
  test/auth_web/controllers/person_session_controller_test.exs:40: AuthWeb.PersonSessionControllerTest.&quot;test POST /people/log_in logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/settings&quot;
  test/auth_web/controllers/person_session_controller_test.exs:39: AuthWeb.PersonSessionControllerTest.&quot;test POST /people/log_in logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/settings&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:39: AuthWeb.PersonRegistrationControllerTest.&quot;test POST /people/register creates account and logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/register&quot;
  test/auth_web/controllers/person_session_controller_test.exs:15: AuthWeb.PersonSessionControllerTest.&quot;test GET /people/log_in renders log in page&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/register&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:12: AuthWeb.PersonRegistrationControllerTest.&quot;test GET /people/register renders registration page&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/log_in&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:11: AuthWeb.PersonRegistrationControllerTest.&quot;test GET /people/register renders registration page&quot;/1
</code></pre>
<p>And ultimately the tests fail: </p>
<pre><code class="language-sh">...............................................................................
Finished in 0.6 seconds (0.4s async, 0.2s sync)
115 tests, 5 failures
</code></pre>
<p>This should be a easy to fix.</p>
<p>Perform a find-and-replace for &quot;/users/&quot; to &quot;/people/&quot;</p>
<p><img src="https://user-images.githubusercontent.com/194400/223720287-98435204-8189-4baf-ab7b-a2a3f506b6dd.png" alt="replace-users-with-people" /></p>
<p>Attempt to re-run the tests:</p>
<pre><code class="language-sh">mix test
</code></pre>
<p>Sadly, 4 tests still fail:</p>
<pre><code class="language-sh">  1) test POST /people/register creates account and logs the person in (AuthWeb.PersonRegistrationControllerTest)
     test/auth_web/controllers/person_registration_controller_test.exs:24
     Assertion with =~ failed
     code:  assert response =~ email
     left:  &quot;&lt;!DOCTYPE html&gt;\n&lt;html lang=\&quot;en\&quot; style=\&quot;scrollbar-gutter: stable;\&quot;&gt;\n  &lt;head&gt;\n etc.

etc.

.......................................................................
Finished in 0.5 seconds (0.4s async, 0.1s sync)
115 tests, 4 failures
</code></pre>
<p>We're going to have to investigate/update these tests <em>manually</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notes-on-naming-conventions"><a class="header" href="#notes-on-naming-conventions">Notes on Naming Conventions</a></h1>
<p>The words we use matter.
To some people they matter <em>more</em> 
than the <em>message</em> we are trying to convey.
For some, if you speak or write
a word that offends them (or <em>anyone</em> else),
what you have to say is no longer relevant.</p>
<p>There are <em>many</em> words we avoid using
in polite company such as 
<a href="https://en.wikipedia.org/wiki/Profanity">profanity</a>
and others we attempt to eliminate completely such as 
<a href="https://en.wikipedia.org/wiki/Pejorative">pejorative</a> terms
or 
<a href="https://en.wikipedia.org/wiki/List_of_ethnic_slurs">ethnic slurs</a>.</p>
<h2 id="user---person"><a class="header" href="#user---person"><del>User</del> -&gt; <code>Person</code></a></h2>
<p>The word &quot;<strong>user</strong>&quot; is pervasive in computing:</p>
<blockquote>
<p>&quot;<em>A <strong><code>user</code></strong> is a <strong><code>person</code></strong> 
who utilizes a computer or network service.</em>&quot;
~ https://en.wikipedia.org/wiki/User_(computing)#Terminology</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/194400/223142338-11395ebc-2506-4114-895e-2051dcf8031f.png" alt="wikipedia-user-computer" /></p>
<p>Right there in the <em>definition</em>
they clarify that a &quot;user&quot; is a &quot;person&quot; ...
so why not just call them a <code>person</code>? </p>
<p>The fact that the term &quot;<strong>user</strong>&quot; is widely used
doesn't make it <em>right</em>; 
it's just the <code>default</code> word
many people have become accustomed to.</p>
<p>Mega tech companies like Apple, Microsoft, Google and Facebook
regularly use the word &quot;user&quot; or &quot;users&quot;
to describe the <strong><code>people</code></strong> that use their products and services.</p>
<h2 id="personalization"><a class="header" href="#personalization">Personalization?</a></h2>
<p>Consider the word <strong><code>personalization</code></strong>.
&quot;<em><strong>Personalization</strong> consists of tailoring 
a service or a product 
to accommodate specific individuals, 
sometimes tied to groups or segments of individuals</em>.&quot;
~ <a href="https://en.wikipedia.org/wiki/Personalization">wikipedia.org/wiki/Personalization</a></p>
<p>The word isn't &quot;userization&quot;,
because the interface for the &quot;user&quot; is always the same; generic.
Whereas the interface that is personalized 
to an individual person is <em>just</em> for them.</p>
<p>We will be doing a <em>lot</em> of <strong><code>personalization</code></strong>
in our <code>App</code>
and building tools that allow <code>people</code>
to personalize their <em>own</em> experience. </p>
<h2 id="complete-clarity"><a class="header" href="#complete-clarity">Complete Clarity</a></h2>
<p>We avoid using the word &quot;<em><strong>user</strong></em>&quot;
in the <code>auth</code> system and our <code>App</code>
because we consider it reductive
and distances the <code>people</code> creating the <code>code</code>
from the <code>people</code> <em>using</em> the product.</p>
<p>Instead we refer to <code>people</code> using the <code>App</code>
as <code>people</code> because it helps us 
to <em>think</em> of them as <strong><em>real</em> <code>people</code></strong>.</p>
<p>We cannot <em>force</em> anyone <code>else</code>
to stop using the word &quot;user&quot;.
It will still be the <code>default</code> for many companies.
Especially the company who 
treat their &quot;users&quot; as the <code>product</code>.</p>
<h2 id="the-product-facebook-sells-is-you"><a class="header" href="#the-product-facebook-sells-is-you">The Product <code>Facebook</code> Sells is <em>You</em></a></h2>
<p><a href="https://slate.com/technology/2018/04/are-you-really-facebooks-product-the-history-of-a-dangerous-idea.html"><img src="https://user-images.githubusercontent.com/194400/223942613-bbc5ea60-2ff4-4751-9dad-11e151ca5248.png" alt="facebook-users-for-sale" /></a></p>
<blockquote>
<p>&quot;<em>You may think Facebook is the product 
and you‚Äôre the client, 
but that‚Äôs not entirely true. 
There‚Äôs a reason tech companies 
call us <strong>users</strong> and not customers. 
It‚Äôs because we‚Äôre just people 
who come and use the interface. 
The <strong>product</strong> <code>Facebook</code> sells is <strong><code>you</code></strong>. 
The advertisers are the customers. 
That goes for all tech companies 
that make most of their money from ads.</em>&quot;
~ <a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-1461358970">Ben Wolford</a></p>
</blockquote>
<h2 id="daus-maus"><a class="header" href="#daus-maus"><code>DAUs</code>, <code>MAUs</code></a></h2>
<p><a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-406784935"><code>Facebook</code></a>
will continue referring to <code>people</code> as &quot;users&quot;
and more specifically 
&quot;<a href="https://en.wikipedia.org/wiki/Active_users"><strong>DAUs</strong></a>&quot; 
(<em>Daily</em> Active Users)
and 
&quot;<a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-1458429682"><strong>MAUs</strong></a>&quot;
(<em>Monthly</em> Active Users).
They don't <em>want</em> to think about the 
<code>people</code> whose lives they are 
<a href="https://github.com/dwyl/home/issues/29">wasting</a>
and in many cases
<a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-1350769626">destroying</a>.</p>
<p>We want to do the <em>exact</em> opposite 
of <code>Facebook</code> with our <code>App</code>;
we want to <strong>help <code>people</code> <em>save</em> time</strong>!
So we are using the word &quot;people&quot;
and avoiding &quot;users&quot; wherever we can.</p>
<h2 id="not-just-facebook"><a class="header" href="#not-just-facebook">Not Just <code>Facebook</code></a></h2>
<p>Facebook is just the most obvious
and <em>egregious</em> example.
All the top tech companies
harvest your personal data 
and sell it to advertisers.
<a href="https://www.wired.co.uk/article/apple-is-an-ad-company-now"><code>Apple</code></a>, 
<a href="https://www.ben-evans.com/benedictevans/2023/3/6/ways-to-think-about-amazon-advertising"><code>Amazon</code></a>, 
<a href="https://www.reuters.com/business/media-telecom/disney-secures-9-billion-upfront-ad-sales-2022-07-18/"><code>Disney</code></a>,
<a href="https://www.statista.com/statistics/266249/advertising-revenue-of-google/"><code>Google</code></a>, 
<a href="https://en.wikipedia.org/wiki/Microsoft_Advertising"><code>Microsoft</code></a>, 
<a href="https://www.statista.com/statistics/1361989/netflix-ad-revenue"><code>NetFlix</code></a>,
<a href="https://www.businessofapps.com/data/twitter-statistics/"><code>Twitter</code></a>,
<a href="https://www.reuters.com/technology/uber-looks-boost-digital-ad-revenue-with-new-advertising-division-2022-10-19/"><code>Uber</code></a> 
are all in the <code>advertising</code> business
whether you realize it or not.
They are all &quot;attention merchants&quot;.</p>
<blockquote>
<p>&quot;<em>Simply put, the U-words have their origin in a more sanguine, na√Øve era. 
As terms, I find them unethical and outdated, 
and so I have doubts they can usher in 
the kind of improvements to technology we desperately need.</em>&quot;
~ <a href="https://medium.com/s/user-friendly/why-im-done-saying-user-user-experience-and-ux-in-2019-4fdfc6b7de23">Adam Lefton</a></p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/194400/223168289-b44149c8-56da-4348-8561-4f9904007f72.png" alt="iamnotauser" /></p>
<h2 id="recommended-reading"><a class="header" href="#recommended-reading">Recommended Reading</a></h2>
<ul>
<li>Words Matter. Talk About People: 
Not Customers, Not Consumers, Not Users:
<a href="https://jnd.org/words_matter_talk_about_people_not_customers_not_consumers_not_users">jnd.org/words_matter_talk_about_people_not_customers_not_consumers_not_users</a></li>
<li>Refuse to Call People ‚ÄòUsers‚Äô:
<a href="https://medium.com/s/user-friendly/why-im-done-saying-user-user-experience-and-ux-in-2019-4fdfc6b7de23">medium.com/s/user-friendly/why-im-done-saying-user-user-experience-and-ux-in-2019-4fdfc6b7de23</a></li>
<li>Is Your Life Really Yours? 
How ‚ÄòThe Attention Merchants‚Äô Got Inside Our Heads:
<a href="https://bigthink.com/high-culture/tim-wu-on-the-attention-merchants-2/">bigthink.com/high-culture/tim-wu-on-the-attention-merchants-2</a></li>
<li>The words you choose within your app 
are an essential part of its experience:
<a href="https://developer.apple.com/design/human-interface-guidelines/foundations/writing">developer.apple.com/design/human-interface-guidelines/foundations/writing</a></li>
</ul>
<blockquote>
<p><strong>Note</strong>: <strong><code>Apple**</code></strong> while a proponent
of carefully selecting words,
often refer to the <code>people</code> 
that buy and use 
their products and services
as &quot;users&quot;. 
This is a legacy of their <em>age</em> as a company -
they have been around since 
<a href="https://en.wikipedia.org/wiki/Apple_Inc">1976</a> -
and their <em>scale</em>;
they have more than 
<a href="https://www.macrumors.com/2023/02/02/apple-two-billion-active-devices"><strong>2 billion active devices</strong></a>.
At that scale it's about numbers and &quot;users&quot;
not individual <code>people</code>. 
There are many great <code>people</code> at <code>Apple</code>
who understand that words matter. 
If the company was started today perhaps
they would think twice about the &quot;users&quot; word.
But sadly, even Apple are now in the advertising
business:
<a href="https://www.wired.co.uk/article/apple-is-an-ad-company-now">wired.co.uk/article/apple-is-an-ad-company-now</a>
So they aren't likely to update 
the word they use to describe us.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modals-are-an-experience-antipattern"><a class="header" href="#modals-are-an-experience-antipattern">Modals Are An Experience <em>Antipattern</em></a></h1>
<p>&quot;<em>An <strong>antipattern</strong> is just like a pattern, except that instead of a solution it gives something that looks superficially like a solution, but <strong>isn't one</strong>.</em>&quot;
~ Linda Rising - The Patterns Handbook
<a href="https://en.wikipedia.org/wiki/Anti-pattern#:~:text=An%20antipattern%20is%20just%20like,%2C%20but%20isn&#x27;t%20one.">wikipedia.org/wiki/Anti-pattern</a></p>
<p>9 times out of 10 
when designers/egineers 
employ a <code>modal</code> in an App.
they are doing so inappropriately
and inadvertently making 
the experience/interface <em>worse</em>
for the <code>person</code>.</p>
<p>If you are unfamiliar with them,
a good place to learn is:
<a href="https://getbootstrap.com/docs/4.0/components/modal/">bootstrap.com/modal</a></p>
<p><img src="https://user-images.githubusercontent.com/194400/224336299-9d22426a-5efd-4cb4-8ee5-9d565f9f5a9c.png" alt="bootstrap-modal" /></p>
<p>A <code>modal</code> overlays information 
on top of what is already displayed on the page.
It hijacks the person's focus 
to what the dev wants them to see
and requires the person
to <em>manually</em> dismiss it 
before being <em>allowed</em> to resume what they were doing.
This is an unwelcome interruption
to the flow and a generally <strong><em>horrible</em> experience</strong>.</p>
<p><code>Modals</code> are a relic of the old web
where ads hijacked people's screens with pop-ups:</p>
<p><img src="https://user-images.githubusercontent.com/194400/224343020-c1e0fc9c-7850-44e9-8df7-c5a5bdff8bfc.jpg" alt="pop-up-ads-90s" /></p>
<p>See:
<a href="https://en.wikipedia.org/wiki/Pop-up_ad">wikipedia.org/Pop-up_ad</a></p>
<p>The situation got completely out-of-hand
and made browsing the web a <em>horrible</em> experience.
All modern browsers block pop-ups by default now
but designers/devs who don't respect 
the <code>people</code> using their site/app
still reach for <code>modals</code> for hijacking attention.</p>
<p><img src="https://user-images.githubusercontent.com/194400/208245674-cabc63f7-3975-4590-bc0d-b80e8823e200.png" alt="modal-ad" /></p>
<p>Modals are almost <em>never</em>
a good way of displaying information.</p>
<h2 id="modals-in-phoenix"><a class="header" href="#modals-in-phoenix">Modals in <code>Phoenix</code>?</a></h2>
<p><code>Phoenix 1.7</code> added the new 
<a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/lib/auth_web/components/core_components.ex#L48"><code>modal</code></a> 
component.</p>
<p>We <em>really wish</em> the creators of <code>Phoenix</code> 
had not done it
because it will <em>inevitably</em> be misused.
Naive devs who mean well 
but haven't studied UX,
will use a <code>modal</code>
when a basic <code>&lt;div&gt;</code>
would be considerably better.</p>
<p>It is used by <code>default</code> for inserting new content:</p>
<p><img src="https://user-images.githubusercontent.com/194400/199604980-3a7d8c6a-82e3-488b-aebf-e3c6c28d9e1d.png" alt="phoenix-modal-new-item" /></p>
<p>This is a <em>horrible</em> experience.
The <code>New Item</code> <code>modal</code> overlays the <code>Listing Items</code> page
instead of just showing a <code>New Item</code> <em>page</em>. 
This adds absolutely no value to the <code>person</code>
inputing the <code>item</code>; 
it's just a distraction.
This shows that the devs building
<code>Phoenix</code> have not done very much UX/Usability testing
because this would <em>immediately</em> confuse
an older less tech-savvy person.
They would ask is this page &quot;Listing Items&quot;
or is it allowing me to create a &quot;New Item&quot;?
And if they accidentally clicked/tapped
on the &quot;X&quot; they would lose the text they inputted.
Horrible.</p>
<h2 id="quick-example"><a class="header" href="#quick-example">Quick Example</a></h2>
<p>After executing the <code>mix phx.gen.auth</code> command
and then running the project with:</p>
<pre><code class="language-sh">mix phx.server
</code></pre>
<p>The following 2 links 
are added to the header 
of home page: 
<img width="1159" alt="phoenix-homepage-with-register-login-links" src="https://user-images.githubusercontent.com/194400/223761934-73e848c8-4ccd-44b3-ae8c-9376cd10fafb.png"></p>
<p>The code that creates these links is: <a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/lib/auth_web/components/layouts/root.html.heex#L15-L55"><code>/lib/auth_web/components/layouts/root.html.heex#L15-L55</code></a></p>
<p>Clicking on the <code>register</code> link we navigate to: http://localhost:4000/people/register
<img width="771" alt="image" src="https://user-images.githubusercontent.com/194400/223764612-8cdae223-49f3-43ae-9e24-c22a4e2caada.png"></p>
<p>Here we can enter an <code>Email</code> and <code>Password</code> to and click on the <code>Create an account</code> button:
<img width="771" alt="phoenix-auth-register-account" src="https://user-images.githubusercontent.com/194400/223766668-b0dcab60-be53-480e-9e4d-d1795ae57bdb.png"></p>
<p>This redirects us back to the homepage <code>http://localhost:4000/</code> and we see the following <code>modal</code>:
<img width="801" alt="phoenix-auth-register-success-modal" src="https://user-images.githubusercontent.com/194400/223767398-b1ac4510-a941-4d23-a748-1da6946cdd41.png"></p>
<p>The person viewing this screen 
has to <em>manually</em> dismiss
the <code>modal</code> in order to see 
the content that is <em>relevant</em> to them: </p>
<p><img src="https://user-images.githubusercontent.com/194400/223803237-55458f41-1456-4981-b531-3fdafb6b74ba.png" alt="phoenix-auth-email-in-header" /></p>
<p>Inspecting the <code>DOM</code> of the page in our browser:
<img width="1297" alt="image" src="https://user-images.githubusercontent.com/194400/223771234-b839c8fe-feb9-481c-ba66-40dabba374fc.png"></p>
<p>We see that the <code>&lt;div id=&quot;flash&quot;</code> 
has the following <code>HTML</code>: </p>
<pre><code class="language-html">&lt;div id=&quot;flash&quot; phx-mounted=&quot;[[&amp;quot;show&amp;quot;,{&amp;quot;display&amp;quot;:null,&amp;quot;time&amp;quot;:200,&amp;quot;to&amp;quot;:&amp;quot;#flash&amp;quot;,&amp;quot;transition&amp;quot;:[[&amp;quot;transition-all&amp;quot;,&amp;quot;transform&amp;quot;,&amp;quot;ease-out&amp;quot;,&amp;quot;duration-300&amp;quot;],[&amp;quot;opacity-0&amp;quot;,&amp;quot;translate-y-4&amp;quot;,&amp;quot;sm:translate-y-0&amp;quot;,&amp;quot;sm:scale-95&amp;quot;],[&amp;quot;opacity-100&amp;quot;,&amp;quot;translate-y-0&amp;quot;,&amp;quot;sm:scale-100&amp;quot;]]}]]&quot; phx-click=&quot;[[&amp;quot;push&amp;quot;,{&amp;quot;event&amp;quot;:&amp;quot;lv:clear-flash&amp;quot;,&amp;quot;value&amp;quot;:{&amp;quot;key&amp;quot;:&amp;quot;info&amp;quot;}}],[&amp;quot;hide&amp;quot;,{&amp;quot;time&amp;quot;:200,&amp;quot;to&amp;quot;:&amp;quot;#flash&amp;quot;,&amp;quot;transition&amp;quot;:[[&amp;quot;transition-all&amp;quot;,&amp;quot;transform&amp;quot;,&amp;quot;ease-in&amp;quot;,&amp;quot;duration-200&amp;quot;],[&amp;quot;opacity-100&amp;quot;,&amp;quot;translate-y-0&amp;quot;,&amp;quot;sm:scale-100&amp;quot;],[&amp;quot;opacity-0&amp;quot;,&amp;quot;translate-y-4&amp;quot;,&amp;quot;sm:translate-y-0&amp;quot;,&amp;quot;sm:scale-95&amp;quot;]]}]]&quot; role=&quot;alert&quot; class=&quot;fixed hidden top-2 right-2 w-80 sm:w-96 z-50 rounded-lg p-3 shadow-md shadow-zinc-900/5 ring-1 bg-emerald-50 text-emerald-800 ring-emerald-500 fill-cyan-900&quot; style=&quot;display: block;&quot;&gt;
  &lt;p class=&quot;flex items-center gap-1.5 text-[0.8125rem] font-semibold leading-6&quot;&gt;
    &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; aria-hidden=&quot;true&quot; class=&quot;h-4 w-4&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&gt;
        &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z&quot; clip-rule=&quot;evenodd&quot;&gt;&lt;/path&gt;
    &lt;/svg&gt;
    Success!
  &lt;/p&gt;
  &lt;p class=&quot;mt-2 text-[0.8125rem] leading-5&quot;&gt;Person created successfully.&lt;/p&gt;
  &lt;button type=&quot;button&quot; class=&quot;group absolute top-2 right-1 p-2&quot; aria-label=&quot;close&quot;&gt;
    &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; aria-hidden=&quot;true&quot; class=&quot;h-5 w-5 stroke-current opacity-40 group-hover:opacity-70&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&gt;
        &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z&quot; clip-rule=&quot;evenodd&quot;&gt;&lt;/path&gt;
    &lt;/svg&gt;
  &lt;/button&gt;
&lt;/div&gt;
</code></pre>
<p>This is a <em>lot</em> of code 
just to inform the <code>person</code>
that the successfully registered.</p>
<p>We <em>know</em> there's a <em>much</em> better way.
We will be <em>demonstrating</em> it 
in the next few pages.</p>
<p>For now, we're just going to 
remove the line:</p>
<pre><code class="language-html">&lt;.flash_group flash={@flash} /&gt;
</code></pre>
<p>From the file:
<a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/lib/auth_web/components/layouts/app.html.heex#L40"><code>/lib/auth_web/components/layouts/app.html.heex#L40</code></a></p>
<p>To remove all <code>flash</code> modals.</p>
<p>And just like magic,
the tests that were failing previously,
because the <code>modal</code> (noise)
was covering the <code>email</code> address,
now pass: </p>
<pre><code class="language-sh">mix test 

Compiling 2 files (.ex)
The database for Auth.Repo has already been created

19:08:47.892 [info] Migrations already up
..........................................................
.........................................................
Finished in 0.5 seconds (0.3s async, 0.1s sync)
115 tests, 0 failures
</code></pre>
<p>With all tests passing,
we can <em>finally</em> get on 
with building <code>Auth</code>! </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="encrypt-personal-data"><a class="header" href="#encrypt-personal-data">Encrypt Personal Data</a></h1>
<p>As previously noted
the schema created by the 
<code>phx.gen.auth</code> generator
leaves <strong><code>email</code></strong> addresses stored 
as 
<a href="https://en.wikipedia.org/wiki/Plaintext"><strong><code>plaintext</code></strong></a>:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223880353-98597d83-cb9c-424d-bcb0-2121ecd743c0.png" alt="mix-phx-gen-auth-people-table-email-plaintext" /></p>
<p>It's disappointing to us 
that this is the <code>default</code>
and many devs
will <em>naively</em> think this is &quot;OK&quot;.</p>
<h2 id="its-never-ok-to-store-personal-data-as-plaintext"><a class="header" href="#its-never-ok-to-store-personal-data-as-plaintext">It's <em>Never</em> &quot;OK&quot; to Store Personal Data as <code>plaintext</code></a></h2>
<p>It might be <em>tempting</em> 
to store personal data as 
human-readable text
during development
to make it easier to debug,
but we urge <em>everyone</em>
to resist this temptation!
<a href="https://en.wikipedia.org/wiki/Data_breach">Data breaches</a>
happen <em>every</em> day.
Breaches can <em>destroy</em> the reputation
of a company.
Thankfully,
the EU now has stronger laws
in the form of the
<a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">General Data Protection Regulation</a>
(GDPR),
which carry heavy fines
for companies
that improperly store personal data.</p>
<p>Most software engineers don't consider
the law(s) around data protection
but none of us have <em>any</em> excuse 
to ignore them even in basic projects.
The good news is:
protecting personal data
is quite straightforward.</p>
<h2 id="why-encrypt-now"><a class="header" href="#why-encrypt-now">Why Encrypt <em>Now</em>?</a></h2>
<p>We <em>know</em> this might feel like a deeply technical
step to have so early on in 
the creation of the <code>auth</code> App.
Why don't we just <em>skip</em> this 
and focus on the interface <code>people</code> will <em>see</em>?
We feel that getting the data privacy/security
right from the <em>start</em>
is essential for building a robust
and therefore trustworthy app. 
We will get to the interface design 
in the next chapter
so if you prefer that part,
feel free to speed-read/run this
and only return to it when you 
need a deeper understanding.</p>
<h2 id="how-to-encrypt-sensitive-data"><a class="header" href="#how-to-encrypt-sensitive-data">How To Encrypt Sensitive Data?</a></h2>
<p>When we first started using <code>Elixir</code> in 2016
we explored the topic of 
encrypting personal data in <em>depth</em>
and wrote a comprehensive guide:
<a href="https://github.com/dwyl/phoenix-ecto-encryption-example"><code>dwyl/phoenix-ecto-encryption-example</code></a>
We <em>highly</em> recommend following step-by-step guide
to understand this in detail.
We aren't going to duplicate/repeat 
any of the <em>theory</em> here. 
Rather we are going to focus on 
the <em>practice</em> using
the 
<a href="https://github.com/dwyl/fields"><code>fields</code></a>
package we created
to implement transparent encryption.</p>
<h2 id="using-fields-to-automatically-encrypt-personal-data"><a class="header" href="#using-fields-to-automatically-encrypt-personal-data">Using <code>Fields</code> to <em>Automatically</em> Encrypt Personal Data</a></h2>
<p>Following the instructions in the 
<a href="https://github.com/dwyl/fields"><code>fields</code></a>
repo, open the <code>mix.exs</code> file
and locate the <code>defp deps do</code> section
and add <code>fields</code> to the list:</p>
<pre><code class="language-elixir">{:fields, &quot;~&gt; 2.10.3&quot;},
</code></pre>
<p>Save the <code>mix.exs</code> file and run:</p>
<pre><code class="language-sh">mix deps.get
</code></pre>
<h3 id="create-environment-variables"><a class="header" href="#create-environment-variables">Create Environment Variables</a></h3>
<p><code>fields</code> expects an `environment variable</p>
<p>e.g. using the <a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Secret.html"><code>phx.gen.secret</code></a> command:</p>
<pre><code class="language-sh">mix phx.gen.secret
</code></pre>
<p>You should see output similar to:</p>
<pre><code class="language-sh">XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
</code></pre>
<p>Export this key in your terminal with the following command:</p>
<pre><code class="language-sh">export ENCRYPTION_KEYS=XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
</code></pre>
<p>Run the <code>phx.gen.secret</code> command again 
and export it as <code>SECRET_KEY_BASE</code>, e.g:</p>
<pre><code class="language-sh">export SECRET_KEY_BASE=GLH2S6EU0eZt+GSEmb5wEtonWO847hsQ9fck0APr4VgXEdp9EKfni2WO61z0DMOF
</code></pre>
<p>We use an <code>.env</code> file on <code>localhost</code>:</p>
<pre><code class="language-sh">export ENCRYPTION_KEYS=XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
export SECRET_KEY_BASE=GLH2S6EU0eZt+GSEmb5wEtonWO847hsQ9fck0APr4VgXEdp9EKfni2WO61z0DMOF
</code></pre>
<p>See:
<a href="https://github.com/dwyl/auth/blob/main/.env_sample"><code>.env_sample</code></a> 
for a sample including 
all the recommended/required environment variables
for running the <code>auth</code> app.</p>
<p>Now to the <em>interesting</em> part!</p>
<h2 id="update-peopleemail-data-type"><a class="header" href="#update-peopleemail-data-type">Update <code>people.email</code> Data Type</a></h2>
<p>The <code>phx.gen.auth</code> generator
created the <code>people</code> schema
with the <code>:email</code> field defined as a <code>:string</code>:</p>
<pre><code class="language-sh">field :email, :string
</code></pre>
<p>See: 
<a href="https://github.com/dwyl/auth/blob/da0af7ee702c278714b47f92045edce4adad542a/lib/auth/accounts/person.ex#L6"><code>lib/auth/accounts/person.ex#L6</code></a></p>
<h3 id="create-migration-file"><a class="header" href="#create-migration-file">Create Migration File</a></h3>
<p>Using <a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html#module-creating-your-first-migration"><code>Ecto.Migration</code></a>
run the following command 
to create a migration file 
with a descriptive name:</p>
<pre><code class="language-sh">mix ecto.gen.migration modify_people_email_string_binary
</code></pre>
<p>You should see output similar to:</p>
<pre><code class="language-sh">* creating priv/repo/migrations/20230309145958_modify_people_email_string_binary.exs
</code></pre>
<p>Open the file in your editor. You should see:</p>
<pre><code class="language-elixir">defmodule Auth.Repo.Migrations.ModifyPeopleEmailStringBinary do
  use Ecto.Migration

  def change do

  end
end
</code></pre>
<p>Update it to include the <code>alter</code> statement:</p>
<pre><code class="language-elixir">defmodule Auth.Repo.Migrations.ModifyPeopleEmailStringBinary do
  use Ecto.Migration

  def change do
    alter table(:people) do
      remove :email
      add :email, :binary
      add ...
    end

    alter table(:people_tokens) do
      remove :sent_to
      add :sent_to, :binary
    end
  end
end
</code></pre>
<blockquote>
<p><strong>Note</strong>: we tried using 
<a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html#modify/3"><code>Ecto.Migration.modify/3</code></a>
to modify the field type
but got the error:</p>
</blockquote>
<pre><code class="language-sh">15:06:13.691 [info] alter table people
** (Postgrex.Error) ERROR 42804 (datatype_mismatch) column &quot;email&quot; cannot be cast automatically to type bytea

    hint: You might need to specify &quot;USING email::bytea&quot;.
</code></pre>
<p>Given that this is a new project 
and there is no data in the DB,
we decided it was easier 
to remove and re-add the <code>email</code> column/field.</p>
<p>Save the migration file and run:</p>
<pre><code class="language-sh">mix ecto.reset
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">15:13:29.989 [info] == Migrated 20230226095715 in 0.0s

15:13:30.057 [info] == Running 20230309145958 Auth.Repo.Migrations.ModifyPeopleEmailStringBinary.change/0 forward

15:13:30.058 [info] alter table people

15:13:30.059 [info] alter table people_tokens

15:13:30.059 [info] == Migrated 20230309145958 in 0.0s
</code></pre>
<p>###¬†Update <code>person.email</code></p>
<p>Open 
<code>lib/auth/accounts/person.ex</code>
and replace the line:</p>
<pre><code class="language-elixir">field :email, :string
</code></pre>
<p>With:</p>
<pre><code class="language-elixir">field :email, Fields.EmailEncrypted
field :email_hash, Fields.EmailHash
</code></pre>
<p>Sadly, this <em>essential</em> privacy/security enhancement 
was not quite as straightforward as we had hoped 
and had quite a few ramifications.
The boilerplate code 
generated by <code>phx.gen.auth</code>
was relying on <code>person.email</code> being <code>plaintext</code>
so we ended up having to make several changes.</p>
<p>Rather than repeating all of these here
which will take up a <em>lot</em> of space
and duplicate the code unessessarily,
we recommend you read through the git commit:
<a href="https://github.com/dwyl/auth/pull/231/commits/2bbba99c7057f0d2943dd8327be52ccf1a1bd58c"><code>#2bbba99</code></a></p>
<p>In a follow-up section 
we will be removing most of this code
because we don't <em>want</em> to
use links in emails to verify <code>people</code>.
Instead we will be using one-time-numeric codes.</p>
<p>Following the changes made in: 
<a href="https://github.com/dwyl/auth/pull/231/commits/2bbba99c7057f0d2943dd8327be52ccf1a1bd58c"><code>#2bbba99</code></a></p>
<p>If we now run a query to view the data in the <code>people</code> table:</p>
<pre><code class="language-sql">SELECT id, email, inserted_at FROM people;
</code></pre>
<p>We see that the <code>email</code> is now a binary blob, 
i.e: <em>encrypted</em>:</p>
<img width="1096" alt="image" src="https://user-images.githubusercontent.com/194400/224109679-0084ae9d-a1e8-48f2-a083-94aff46d7137.png">
<p>This cannot be read by anyone 
who does not have the encryption key.
So if the database is somehow compromised,
it's <em>useless</em> to the attacker. </p>
<p>Registration and Login still works as expected:</p>
<img width="1159" alt="image" src="https://user-images.githubusercontent.com/194400/224111036-7a4e5764-8966-4b97-aaea-515c8e3b7fd4.png">
<p>But now the personal data 
captured in registration is stored 
<strong><code>encrypted</code></strong> at rest 
the way it should be. üîê </p>
<p>Now we can get on with <em>building</em> <code>auth</code>!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-build-an-metrics-dashboard"><a class="header" href="#how-to-build-an-metrics-dashboard">How to Build an Metrics Dashboard</a></h1>
<pre><code class="language-sh">mix phx.new atm --no-mailer
</code></pre>
<p>We won't send <code>email</code> from this app.
But we want everything <code>else</code> 
<code>Phoenix</code> has to offer. üöÄ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parse-and-store-browser-user-agent-string"><a class="header" href="#parse-and-store-browser-user-agent-string">Parse and Store Browser User Agent String</a></h1>
<p>The <em>first</em> data we want to parse and store 
is the Web Browser 
<a href="https://en.wikipedia.org/wiki/User_agent">User Agent</a>
so that we know what devices and browsers are visiting.</p>
<p>There is a lot of info about User Agents on <strong>MDN</strong>:
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent">developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent</a>
recommended reading for the curious.</p>
<p>For our purposes 
we only need to extract the <code>user_agent</code> data that interest us
and thankfully, 
<a href="https://github.com/mneudert"><code>@mneudert</code></a>
has created a handy library we can use:
<a href="https://github.com/elixir-inspector/ua_inspector"><strong><code>ua_inspector</code></strong></a></p>
<h2 id="ua_inspector-usage-example"><a class="header" href="#ua_inspector-usage-example"><code>ua_inspector</code> Usage Example</a></h2>
<p>From the <code>ua_inspector</code> docs we get the following sample code/output:</p>
<pre><code class="language-elixir">iex&gt; UAInspector.parse(&quot;Mozilla/5.0 (iPad; CPU OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&quot;)
%UAInspector.Result{
  client: %UAInspector.Result.Client{
    engine: &quot;WebKit&quot;,
    engine_version: &quot;537.51.1&quot;,
    name: &quot;Mobile Safari&quot;,
    type: &quot;browser&quot;,
    version: &quot;7.0&quot;
  },
  device: %UAInspector.Result.Device{
    brand: &quot;Apple&quot;,
    model: &quot;iPad&quot;,
    type: &quot;tablet&quot;
  },
  os: %UAInspector.Result.OS{
    name: &quot;iOS&quot;,
    platform: :unknown,
    version: &quot;7.0.4&quot;
  },
  user_agent: &quot;Mozilla/5.0 (iPad; CPU OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&quot;
}
</code></pre>
<p>Additionally there is following sample output for a non-browser agent (<code>Google Bot</code>):</p>
<pre><code class="language-elixir">iex&gt; UAInspector.parse(&quot;Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Safari/537.36&quot;)
%UAInspector.Result.Bot{
  category: &quot;Search bot&quot;,
  name: &quot;Googlebot&quot;,
  producer: %UAInspector.Result.BotProducer{
    name: &quot;Google Inc.&quot;,
    url: &quot;http://www.google.com&quot;
  },
  url: &quot;http://www.google.com/bot.html&quot;,
  user_agent: &quot;Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Safari/537.36&quot;
}
</code></pre>
<p>From this sample output 
we can extract the following fields:</p>
<ul>
<li><code>engine</code>: <code>String</code> e.g: &quot;WebKit&quot;</li>
<li><code>engine_version</code>: <code>String</code> e.g: &quot;537.51.1&quot; - sadly we can't store this as <code>float</code> unless we lose the last digit ...</li>
<li><code>name</code>: <code>String</code> e.g: &quot;Mobile Safari&quot;</li>
<li><code>version</code>: <code>Float</code> e.g: &quot;7.0&quot; - we will <em>parse</em> this <code>float</code> so that we can run queries on it.</li>
<li><code>brand</code>: <code>String</code> e.g: &quot;Apple&quot;</li>
<li><code>model</code>: <code>String</code> e.g: &quot;iPad&quot;</li>
<li><code>device_type</code>: <code>String</code> e.g: &quot;tablet&quot;</li>
<li><code>os_name</code>: <code>String</code> e.g: &quot;iOS&quot;</li>
<li><code>platform</code>: <code>String</code> e.g: &quot;unknown&quot; - <code>Atom.to_string(:unknown)</code></li>
<li><code>os_version</code>: <code>String</code> e.g: &quot;7.0.4&quot;</li>
<li><code>url</code>: <code>String</code> e.g: &quot;http://www.google.com/bot.html&quot; - used by non-human agents; blank if null.</li>
<li><code>user_agent</code>: <code>String</code>, the <em>full</em> agent string.
Even though <code>ua_inspector</code> does a good job of parsing the <code>user_agent</code>,
we are storing the <em>full</em> <code>user_agent</code> string 
so that we can sense-check the parsed data when needed.</li>
</ul>
<p>Fields we will ignore:</p>
<ul>
<li><code>type</code>: <code>String</code> e.g: &quot;browser&quot; - we will skip this field as it's implied. </li>
<li></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="minimum-viable-product-mvp"><a class="header" href="#minimum-viable-product-mvp">Minimum Viable Product (MVP)</a></h1>
<p><em>All</em> Apps start with an MVP. 
In our case we created a <em>separate</em> repository:
<a href="https://github.com/dwyl/mvp">github.com/dwyl/<strong>mvp</strong></a>
so that the most <em>basic</em> version of our <code>App</code> 
could be used as a reference by other people building MVPs.</p>
<h1 id="todo"><a class="header" href="#todo">TODO:</a></h1>
<p>Lift the contents of 
<a href="https://github.com/dwyl/mvp/blob/7c0a29cfe71582a9aada531af339afdd2734b809/BUILDIT.md?plain=1">github.com/dwyl/mvp/BUILDIT.md</a>
and split it into separate files here in <code>book</code>.
See: 
<a href="https://github.com/dwyl/mvp/issues/350">dwyl/mvp/<strong>issues/350</strong></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="use-cid-for-universally-unique-ids"><a class="header" href="#use-cid-for-universally-unique-ids">Use <code>cid</code> for <em>universally unique</em> <code>ids</code></a></h1>
<p>By default all the tables 
in a <code>Phoenix</code> Application 
use an auto-incrementing <code>integer</code> (<code>Serial</code>) 
for the <code>id</code> (Primary Key).
e.g the <code>items</code> table:</p>
<p><img src="https://github.com/dwyl/mvp/assets/194400/d3020e53-2ad8-43ff-b0ed-95251ee21a87" alt="items-id-integer" /></p>
<p>This is fine for a <em>server</em>-side rendered app 
with a <em>single</em> relational database instance.
i.e. the server/database controls the <code>id</code> of records.
But our ambition has always been 
to build a mobile + offline-first distributed App.</p>
<p>Luckily our friends at 
<a href="https://github.com/ipfs">Protocol Labs</a>
creators of
<a href="https://github.com/dwyl/learn-ipfs"><code>IPFS</code></a>
have done some great groundwork on
<a href="https://en.wikipedia.org/wiki/Decentralized_application">&quot;Decentralized Apps&quot;</a>
so we can build on that.
We created an <code>Elixir</code> package 
that creates <code>IPFS</code> compliant
Content Identifiers: 
<a href="https://github.com/dwyl/cid"><code>cid</code></a></p>
<p>The basic usage is:</p>
<pre><code class="language-elixir">item = %{text: &quot;Build PARA System App&quot;, person_id: 2, status: 2}
Cid.cid(item)
&quot;zb2rhn92tqTt41uFZ3hh3VPnssXjYCW4yDSX7KB39dXZyMtNC&quot;
</code></pre>
<p>This <code>cid</code> string is unique to this content
therefore creating it on the client (Mobile device)
will generate the <em>same</em> <code>cid</code>
if the record is created <em>offline</em>.</p>
<p>We can easily confirm the validity of this <code>cid</code>
by inputting it into CID Inspector:
<a href="https://cid.ipfs.tech">cid.ipfs.tech</a>
e.g:
https://cid.ipfs.tech/#zb2rhn92tqTt41uFZ3hh3VPnssXjYCW4yDSX7KB39dXZyMtNC</p>
<p><img src="https://github.com/dwyl/mvp/assets/194400/56ac8bdf-663a-4cb3-8ad3-f8bd4e9a4be3" alt="cid-inspector" /></p>
<h2 id="add-excid-package-to-deps"><a class="header" href="#add-excid-package-to-deps">Add <code>excid</code> package to <code>deps</code></a></h2>
<p>Add the <code>excid</code> package to the <code>deps</code> in <code>mix.exs</code>:</p>
<pre><code class="language-elixir"># Universally Unique Deterministic Content IDs: github.com/dwyl/cid
{:excid, &quot;~&gt; 1.0.1&quot;},
</code></pre>
<p>Run:</p>
<pre><code class="language-sh">mix deps.get
</code></pre>
<p>Then in <code>config/config.exs</code> add the following configuration line:</p>
<pre><code class="language-elixir">config :excid, base: :base58
</code></pre>
<p>We want to use 
<a href="https://github.com/dwyl/base58#why-base58"><code>base58</code></a>
because it uses 17% fewer characters to represent the same <code>ID</code> 
when compared to <code>base32</code>.</p>
<pre><code class="language-elixir">&quot;bafkreihght5nbnmn6xbwoakmjyhkiu2naxmwpxgxbp6xkpbiweuetbohde&quot;
|&gt; String.length()
59
</code></pre>
<p>vs.</p>
<pre><code class="language-elixir">&quot;zb2rhn92tqTt41uFZ3hh3VPnssXjYCW4yDSX7KB39dXZyMtNC&quot;
|&gt; String.length()
49
</code></pre>
<h2 id="create-migration"><a class="header" href="#create-migration">Create <code>migration</code></a></h2>
<p>Using the 
<a href="https://hexdocs.pm/ecto_sql/Mix.Tasks.Ecto.Gen.Migration.html"><code>mix ecto.gen.migration</code></a>
command, 
create a migration file:</p>
<pre><code class="language-sh">mix ecto.gen.migration add_cid
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">* creating priv/repo/migrations/20230824153220_add_cid.exs
</code></pre>
<p>This tells us that the migration file was created:
<code>priv/repo/migrations/20230824153220_add_cid_to_item.exs</code>
Open the file, you should see a blank migration:</p>
<pre><code class="language-elixir">defmodule App.Repo.Migrations.AddCidToItem do
  use Ecto.Migration

  def change do

  end
end
</code></pre>
<p>Update it to:</p>
<pre><code class="language-elixir">defmodule App.Repo.Migrations.AddCidToItem do
  use Ecto.Migration

  def change do
    alter table(:items) do
      add(:cid, :string)
    end
  end
end
</code></pre>
<blockquote>
<p><strong>Note</strong>: if you're rusty on <code>migrations</code>,
see:
<a href="https://devhints.io/phoenix-migrations">devhints.io/phoenix-migrations</a></p>
</blockquote>
<h2 id="add-cid-field-to-item-schema"><a class="header" href="#add-cid-field-to-item-schema">Add <code>cid</code> field to <code>item</code> schema</a></h2>
<p>Open the 
<code>lib/app/item.ex</code>
file and locate the <code>schema items do</code> section.
Add the line:</p>
<pre><code class="language-elixir">field :cid, :string
</code></pre>
<h2 id="create-put_cid1-test"><a class="header" href="#create-put_cid1-test">Create <code>put_cid/1</code> test</a></h2>
<p>Create a new file with the path:
<code>test/app/cid_test.exs</code>
and add the following test:</p>
<pre><code class="language-elixir">defmodule App.CidTest do
  use App.DataCase, async: true

  @valid_attrs %{text: &quot;Buy Bananas&quot;, person_id: 1, status: 2}

  test &quot;put_cid/1 adds a `cid` for the `item` record&quot; do
    # Create a changeset with a valid item record as the &quot;changes&quot;:
    changeset_before = %{changes: @valid_attrs}
    # Should not yet have a cid:
    refute Map.has_key?(changeset_before.changes, :cid)

    # Confirm cid was added to the changes:
    changeset_with_cid = App.Cid.put_cid(changeset_before)
    assert changeset_with_cid.changes.cid == Cid.cid(@valid_attrs)

    # confirm idempotent:
    assert App.Cid.put_cid(changeset_with_cid) == changeset_with_cid
  end
end
</code></pre>
<p>Running this test will fail:</p>
<pre><code class="language-sh">mix test test/app/cid_test.exs
</code></pre>
<p>E.g:</p>
<pre><code class="language-sh">** (UndefinedFunctionError) function App.Cid.put_cid/1 is undefined or private.
</code></pre>
<p>Let's implement it!</p>
<h2 id="create-put_cid1-function"><a class="header" href="#create-put_cid1-function">Create <code>put_cid/1</code> function</a></h2>
<p>Create a new file with the path:
<code>lib/app/cid.ex</code>.
Add the following function definition to the file:</p>
<pre><code class="language-elixir">defmodule App.Cid do
  def put_cid(changeset) do
    if Map.has_key?(changeset.changes, :cid) do
      changeset
    else
      cid = Cid.cid(changeset.changes)
      %{changeset | changes: Map.put(changeset.changes, :cid, cid)}
    end
  end
end
</code></pre>
<p>The function just adds a <code>cid</code> to the <code>changeset.changes</code>
so that it creates a hash of the contents of the changeset
and then adds the <code>cid</code> to identify that content. 
If the <code>changes</code> already have a <code>cid</code> don't do anything.
This covers the case where an <code>item</code> is created in the Mobile client
with a <code>cid</code>. We will add verification for this later. </p>
<h2 id="invoke-put_cid1-in-itemchangeset2"><a class="header" href="#invoke-put_cid1-in-itemchangeset2">Invoke <code>put_cid/1</code> in <code>Item.changeset/2</code></a></h2>
<p>In the 
<code>lib/app/item.ex</code>
file, locate the <code>changeset/2</code> function definition
and change the lines: </p>
<pre><code class="language-elixir">|&gt; cast(attrs, [:person_id, :status, :text])
|&gt; validate_required([:text, :person_id])
</code></pre>
<p>To: </p>
<pre><code class="language-elixir">|&gt; cast(attrs, [:cid, :person_id, :status, :text])
|&gt; validate_required([:text, :person_id])
|&gt; App.Cid.put_cid()
</code></pre>
<p>The call to <code>put_cid/1</code> within <code>changeset/2</code>
adds the <code>cid</code> to the <code>item</code> record.</p>
<h2 id="checkpoint-item-table-with-cid"><a class="header" href="#checkpoint-item-table-with-cid">Checkpoint: <code>item</code> table with <code>cid</code></a></h2>
<p>After running the migration:</p>
<pre><code class="language-sh">mix ecto.migrate
</code></pre>
<p>The <code>item</code> table has the <code>cid</code> column:</p>
<p><img src="https://github.com/dwyl/mvp/assets/194400/cadc5227-40f0-4462-9b32-6034c9a6c0d1" alt="mvp-items-with-cid" /></p>
<p>Even though the <code>cid</code> field was added to the table,
it is <em>empty</em> for all <em>existing</em> <code>item</code> records. 
Easily resolved.</p>
<h2 id="update-all-item-records"><a class="header" href="#update-all-item-records">Update all <code>item</code> records</a></h2>
<p>Add the following function to 
<code>lib/app/item.ex</code>:</p>
<pre><code class="language-elixir">  def update_all_items_cid do
    items = list_items()
    Enum.each(items, fn i -&gt;
      item = %{
        person_id: i.person_id,
        status: i.status,
        text: i.text,
        id: i.id,
      }
      i
      |&gt; changeset(Map.put(item, :cid, Cid.cid(item)))
      |&gt; Repo.update()
    end)
  end
end
</code></pre>
<p>Invoke it in the 
<code>priv/repo/seeds.exs</code>
so that all <code>items</code>
are given a <code>cid</code>. </p>
<p><img src="https://github.com/dwyl/mvp/assets/194400/7291050e-4e63-4564-a661-bc848b5b2993" alt="mvp-items-with-cid-populated" /></p>
<p>With that working we can get back to <em>using</em> this 
in our next feature; <code>lists</code>!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lists"><a class="header" href="#lists">Lists</a></h1>
<p>Our <strong>MVP App</strong> already has 
much of the basic functionality we need/want 
but is sorely lacking 
a way to <strong><em>organize</em> <code>items</code></strong> 
into distinct projects/areas.
Let's fix that by introducing <code>lists</code>!</p>
<h2 id="quick-recap"><a class="header" href="#quick-recap">Quick Recap</a></h2>
<p>Up till this point we've <em>deliberately</em> kept the <code>MVP</code>
as lean as possible to avoid complexity. <br />
The 
<a href="https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model">Entity Relationship Diagram</a>
(ERD) is currently:</p>
<p><img src="https://github.com/dwyl/mvp/assets/194400/0936903f-97ed-4be3-9f70-54c5e138afcd" alt="mvp-erd-before-lists" /></p>
<p>Just the four tables
you've already seen 
in the previous sections.</p>
<p>Our reasons for adding <code>lists</code> <em>now</em> are: <br /></p>
<p><strong>a)</strong> Separate <code>lists</code> 
for different areas of life/work 
have been on our 
<a href="https://github.com/dwyl/product-roadmap">product roadmap</a> for a while ... <br />
<em>specifically</em>:
<a href="https://github.com/dwyl/app/issues/271">dwyl/app#<strong>271</strong></a>
<br /></p>
<p><strong>b)</strong> We want to use <code>lists</code> 
as the basis for organizing 
and 
<a href="https://github.com/dwyl/mvp/issues/145"><strong>re-ordering <code>items</code></strong></a>. <br /></p>
<p><strong>c)</strong> <code>lists</code> will unlock other functionality we have planned
that will make the <code>App</code> more <em>useful</em> both to individuals and teams.</p>
<h2 id="create-lists-schema"><a class="header" href="#create-lists-schema">Create <code>lists</code> Schema</a></h2>
<p>Create the <code>lists</code> table
with the following 
<a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Schema.html"><code>mix phx.gen.schema</code></a>
command:</p>
<pre><code class="language-sh">mix phx.gen.schema Lista lista cid:string name:string person_id:integer seq:string sort:integer status:integer
</code></pre>
<p>This command will create the following migration:</p>
<p><a href="https://github.com/dwyl/mvp/blob/fa0b79eebbe582e3b24213a2c657d0fc343782c9/priv/repo/migrations/20230416001029_create_lists.exs"><code>20230416001029_create_lists.exs</code></a></p>
<pre><code class="language-elixir">defmodule App.Repo.Migrations.CreateLists do
  use Ecto.Migration

  def change do
    create table(:lists) do
      add :cid, :string
      add :name, :string
      add :person_id, :integer
      add :seq, :string
      add :sort, :integer
      add :status, :integer

      timestamps()
    end
  end
end
</code></pre>
<p>Once we run <code>mix ecto.migrate</code>,
we have the following database
ERD:</p>
<p><img src="https://github.com/dwyl/mvp/assets/194400/02ad8f68-9b39-4d59-9a54-cfd7824e9bcf" alt="mvp-erd-with-lists" /></p>
<p>This new database table
lets us create a <code>list</code>
but there is still more work to be done
to enable the features we want.</p>
<h2 id="quick-look-at-libapplistex-file"><a class="header" href="#quick-look-at-libapplistex-file">Quick Look at <code>/lib/app/list.ex</code> file</a></h2>
<p>The <code>mix phx.gen.schema</code> command created the 
<a href="mvp/"><code>lib/app/list.ex</code></a>
file with the following:</p>
<pre><code class="language-elixir">defmodule App.List do
  use Ecto.Schema
  import Ecto.Changeset

  schema &quot;lists&quot; do
    field :cid, :string
    field :name, :string
    field :person_id, :integer
    field :seq, :string
    filed :sort, :integer
    field :status, :integer

    timestamps()
  end

  @doc false
  def changeset(list, attrs) do
    list
    |&gt; cast(attrs, [:cid, :name, :person_id, :seq, :sort, :status])
    |&gt; validate_required([:name, :person_id])
    |&gt; App.Cid.put_cid()
  end
end
</code></pre>
<p>The <code>schema</code> matches the <code>migration</code> above.
Just the 5 fields we need for creating <code>lists</code>:</p>
<ol>
<li><code>cid</code> - the universally unique <code>id</code> for the <code>list</code>.</li>
<li><code>name</code> - the <em>name</em> of the list. a <code>:string</code> of arbitrary length.</li>
<li><code>person_id</code> - the <code>id</code> of the <code>person</code> who created the <code>list</code></li>
<li><code>seq</code> - the <em>sequence</em> of <code>item.cid</code> for the <code>list</code></li>
<li><code>sort</code> - the sort order for the <code>list</code> e.g. 1: <code>Ascending</code></li>
<li><code>status</code> - the <code>status</code> (represented as an <code>Integer</code>) for the <code>list</code>. 
see: 
<a href="https://github.com/dwyl/statuses">dwyl/statuses</a></li>
</ol>
<p>The only function in the <code>list.ex</code> file is <code>changeset/2</code>
which just checks the fields in teh <code>attrs</code> Map
and validates the data that are <code>required</code> to create a <code>list</code>.</p>
<!--
## Preview 

By the end of this chapter we will have ...
-->
<h2 id="create-list_testexs-tests-file-tdd"><a class="header" href="#create-list_testexs-tests-file-tdd">Create <code>list_test.exs</code> Tests File (TDD)</a></h2>
<p>The <code>gen.schema</code> command only creates the migration file
and the corresponding schema file in the 
<a href="https://github.com/dwyl/mvp/tree/main/lib/app"><code>lib/app</code></a> 
directory of our <code>Phoenix App</code>.
It does not create any <code>CRUD</code> functions or tests.
This is fine because <em>most</em> of what we need is bespoke.</p>
<p><em>Manually</em> create the test file 
with the following path:
<code>test/app/list_test.exs</code>.</p>
<p>In the test file
<code>test/app/list_test.exs</code>
add the following test code: </p>
<pre><code class="language-elixir">defmodule App.ListTest do
  use App.DataCase, async: true
  alias App.{List}

  describe &quot;list&quot; do
    @valid_attrs %{name: &quot;My List&quot;, person_id: 1, status: 2}
    @update_attrs %{name: &quot;some updated text&quot;, person_id: 1}
    @invalid_attrs %{name: nil}

    test &quot;get_list!/2 returns the list with given id&quot; do
      {:ok, %{model: list, version: _version}} = List.create_list(@valid_attrs)
      assert List.get_list!(list.id).name == list.name
    end

    test &quot;create_list/1 with valid data creates a list&quot; do
      assert {:ok, %{model: list, version: _version}} =
               List.create_list(@valid_attrs)

      assert list.name == @valid_attrs.name
    end

    test &quot;create_list/1 with invalid data returns error changeset&quot; do
      assert {:error, %Ecto.Changeset{}} = List.create_list(@invalid_attrs)
    end

    test &quot;update_list/2 with valid data updates the list&quot; do
      {:ok, %{model: list, version: _version}} = List.create_list(@valid_attrs)

      assert {:ok, %{model: list, version: _version}} =
               List.update_list(list, @update_attrs)

      assert list.name == &quot;some updated text&quot;
    end
  end
end
</code></pre>
<p>Once you've saved the file, 
run the tests with the following command:</p>
<pre><code class="language-sh">mix test test/app/list_test.exs
</code></pre>
<p>You should see all four tests fail 
(because the functions they invoke do not yet exist):</p>
<pre><code class="language-sh">1) test list create_list/1 with valid data creates a list (App.ListTest)
     test/app/list_test.exs:15
     ** (UndefinedFunctionError) function App.List.create_list/1 is undefined or private
     code: List.create_list(@valid_attrs)
     stacktrace:
       (app 1.0.0) App.List.create_list(%{status: 2, text: &quot;My List&quot;, person_id: 1})
       test/app/list_test.exs:17: (test)

  2) test list create_list/1 with invalid data returns error changeset (App.ListTest)
     test/app/list_test.exs:24
     ** (UndefinedFunctionError) function App.List.create_list/1 is undefined or private
     code: assert {:error, %Ecto.Changeset{}} = List.create_list(@invalid_attrs)
     stacktrace:
       (app 1.0.0) App.List.create_list(%{text: nil})
       test/app/list_test.exs:25: (test)

  3) test list get_list!/2 returns the list with given id (App.ListTest)
     test/app/list_test.exs:10
     ** (UndefinedFunctionError) function App.List.create_list/1 is undefined or private
     code: {:ok, %{model: list, version: _version}} = List.create_list(@valid_attrs)
     stacktrace:
       (app 1.0.0) App.List.create_list(%{status: 2, text: &quot;My List&quot;, person_id: 1})
       test/app/list_test.exs:11: (test)

  4) test list update_list/2 with valid data updates the list (App.ListTest)
     test/app/list_test.exs:28
     ** (UndefinedFunctionError) function App.List.create_list/1 is undefined or private
     code: {:ok, %{model: list, version: _version}} = List.create_list(@valid_attrs)
     stacktrace:
       (app 1.0.0) App.List.create_list(%{status: 2, text: &quot;My List&quot;, person_id: 1})
       test/app/list_test.exs:29: (test)


Finished in 0.03 seconds (0.03s async, 0.00s sync)
4 tests, 4 failures

Randomized with seed 730787
</code></pre>
<p>This is <em>expected</em>. 
Let's create the required functions.</p>
<h3 id="define-the-basic-lists-functions"><a class="header" href="#define-the-basic-lists-functions">Define the basic <code>lists</code> functions</a></h3>
<p>In the 
<code>lib/app/list.ex</code>
file, 
add the following <code>aliases</code> near the top of the file:</p>
<pre><code class="language-elixir">alias App.{Repo}
alias PaperTrail
alias __MODULE__
</code></pre>
<p>Next add the following functions:</p>
<pre><code class="language-elixir">def create_list(attrs) do
  %List{}
  |&gt; changeset(attrs)
  |&gt; PaperTrail.insert()
end

def get_list!(id) do
  List
  |&gt; Repo.get!(id)
end

def update_list(%List{} = list, attrs) do
  list
  |&gt; List.changeset(attrs)
  |&gt; PaperTrail.update()
end
</code></pre>
<p>The main functions to pay attention to 
in the newly created files are:
<code>App.List.create_list/1</code> 
that creates a new <code>list</code>
and
<code>App.List.update_list/2</code> 
which updates the <code>list</code>.
Both are simple and well-documented.</p>
<h3 id="create_list1"><a class="header" href="#create_list1"><code>create_list/1</code></a></h3>
<p><code>create_list/1</code> receives a <code>Map</code> of <code>attrs</code> (attributes)
which it validates using <code>changeset/2</code> function
and then inserts into the <code>lists</code> table
via the <code>PaperTrail.insert()</code> function:</p>
<pre><code class="language-elixir">def create_list(attrs) do
  %List{}
  |&gt; changeset(attrs)
  |&gt; PaperTrail.insert()
end
</code></pre>
<p>The <code>attrs</code> are just:</p>
<ul>
<li><code>name</code> the name/description of the list </li>
<li><code>person_id</code> the <code>id</code> of the <code>person</code> creating the list, and</li>
<li><code>status</code> (optional) an <code>integer</code> representing the <code>status</code> of the <code>list</code>,
this is useful later when people have a <code>draft</code> or <code>archived</code> <code>list</code>. </li>
</ul>
<p>If you are new to the <code>PaperTrail</code> package 
and the benefits it offers,
we wrote a quick intro:
<a href="https://github.com/dwyl/phoenix-papertrail-demo">dwyl/phoenix-papertrail-demo</a></p>
<p>The gist is this: it gives us version history for records in our database
without any query overhead. </p>
<h2 id="get-lists-for-a-person"><a class="header" href="#get-lists-for-a-person">Get <code>lists</code> for a <code>person</code></a></h2>
<p>To display the <code>lists</code> 
that belong to a <code>person</code> 
we need a simple query.</p>
<h3 id="test-get_lists_for_person1"><a class="header" href="#test-get_lists_for_person1">Test <code>get_lists_for_person/1</code></a></h3>
<p>Open the 
<code>test/app/list_test.exs</code>
file 
and add the following test:</p>
<pre><code class="language-elixir">test &quot;get_lists_for_person/1 returns the lists for the person_id&quot; do
  person_id = 3
  lists_before = App.List.get_lists_for_person(person_id)
  assert length(lists_before) == 0

  # Create a couple of lists
  {:ok, %{model: all_list}} =
    %{name: &quot;all&quot;, person_id: person_id, status: 2}
    |&gt; App.List.create_list()

  {:ok, %{model: recipe_list}} =
    %{name: &quot;recipes&quot;, person_id: person_id, status: 2}
    |&gt; App.List.create_list()

  # Retrieve the lists for the person_id:
  lists_after = App.List.get_lists_for_person(person_id)
  assert length(lists_after) == 2
  assert Enum.member?(lists_after, all_list)
  assert Enum.member?(lists_after, recipe_list)
end
</code></pre>
<h3 id="implment-the-get_lists_for_person1-function"><a class="header" href="#implment-the-get_lists_for_person1-function">Implment the <code>get_lists_for_person/1</code> function</a></h3>
<p>In the <code>lib/app/list.ex</code> file,
implement the function 
as simply as possible:</p>
<pre><code class="language-elixir">def get_lists_for_person(person_id) do
  List
  |&gt; where(person_id: ^person_id)
  |&gt; Repo.all()
end
</code></pre>
<p>For this function to work, 
replace the line:</p>
<pre><code class="language-elixir">import Ecto.Changeset
</code></pre>
<p>With:</p>
<pre><code class="language-elixir">import Ecto.{Changeset, Query}
</code></pre>
<p>i.e. we need to import the 
<a href="https://hexdocs.pm/ecto/Ecto.Query.html"><code>Ecto.Query</code></a>
module 
to gain access to the the 
<a href="https://hexdocs.pm/ecto/Ecto.Query.html#where/3"><code>where/3</code></a>
filtering function.</p>
<blockquote>
<p><strong>Note</strong>: If you're rusty on <code>Ecto.Query</code>,
refresh your memory on: 
<a href="https://elixirschool.com/en/lessons/ecto/querying_basics">elixirschool.com/ecto/querying_basics</a>
And if you get stuck, please just open an issue. </p>
</blockquote>
<p>Make sure the test is passing 
as we will be using this function next!</p>
<h2 id="create-the-all-list-for-a-given-person_id"><a class="header" href="#create-the-all-list-for-a-given-person_id">Create the &quot;All&quot; <code>list</code> for a given <code>person_id</code></a></h2>
<p>In order to have sorting/reordering of <code>list_items</code>
(see next chapter)
we <em>first</em> need to have a <code>list</code>!
Rather than forcing <code>people</code> 
to <em>manually</em> create their &quot;all&quot; <code>list</code>
before they know what a <code>list</code> <em>is</em>,
it will be created for them <em>automatically</em>
when they first authenticate.</p>
<h3 id="test-get_list_by_text2"><a class="header" href="#test-get_list_by_text2">Test <code>get_list_by_text!/2</code></a></h3>
<p>In the 
<code>test/app/list_test.exs</code>
file,
create the following test:</p>
<pre><code class="language-elixir">test &quot;get_list_by_text!/2 returns the list for the person_id by text&quot; do
  person_id = 4
  %{name: &quot;All&quot;, person_id: person_id, status: 2}
    |&gt; App.List.create_list()
  list = App.List.get_list_by_text!(&quot;all&quot;, person_id)
  assert list.text == &quot;all&quot;
end
</code></pre>
<h3 id="define-get_list_by_text2"><a class="header" href="#define-get_list_by_text2">Define <code>get_list_by_text!/2</code></a></h3>
<p>This is one is dead simple thanks to <code>Ecto</code> compact syntax:</p>
<pre><code class="language-elixir">def get_list_by_text!(name, person_id) do
  Repo.get_by(List, name: name, person_id: person_id)
end
</code></pre>
<blockquote>
<p><strong>Note</strong>: in future, we may need to use<br />
<a href="https://hexdocs.pm/ecto/Ecto.Repo.html#c:one/2"><code>Repo.one/2</code></a>
if we think there's a chance a <code>person</code> 
may have <em>multiple</em> <code>lists</code> with <code>&quot;all</code>&quot; in the <code>list.name</code>. </p>
</blockquote>
<h2 id="add-existing-itmes-to-the-all-list"><a class="header" href="#add-existing-itmes-to-the-all-list">Add <em>Existing</em> <code>itmes</code> to the &quot;All&quot; <code>list</code></a></h2>
<p>One final function we need
in order to <em>retroactively</em> add <code>lists</code>
to our <code>MVP</code> App that started out <em>without</em> <code>lists</code>
is a function to add all the <em>existing</em> <code>items</code>
to the newly created &quot;All&quot; <code>list</code>. </p>
<h3 id="test-add_all_items_to_all_list_for_person_id1"><a class="header" href="#test-add_all_items_to_all_list_for_person_id1">Test <code>add_all_items_to_all_list_for_person_id/1</code></a></h3>
<blockquote>
<p><strong>Note</strong>: This is a <em>temporary</em> function that we will <code>delete</code>
once all the <em>existing</em> people using the <code>MVP</code>
have transitioned their <code>items</code> to the &quot;All&quot; <code>list</code>.
But we still need to have a <em>test</em> for it!</p>
</blockquote>
<p>Open 
<code>test/app/list_test.exs</code>
and add the following test:</p>
<pre><code class="language-elixir">test &quot;add_all_items_to_all_list_for_person_id/1 to seed the All list&quot; do
  person_id = 0
  all_list = App.List.get_list_by_text!(person_id, &quot;All&quot;)
  count_before = App.ListItem.next_position_on_list(all_list.id)
  assert count_before == 1

  item_ids = App.ListItem.get_items_on_all_list(person_id)
  assert length(item_ids) == 0

  App.ListItem.add_items_to_all_list(person_id)
  updated_item_ids = App.ListItem.get_items_on_all_list(person_id)
  assert length(updated_item_ids) ==
            length(App.Item.all_items_for_person(person_id))

  count_after = App.ListItem.next_position_on_list(all_list.id)
  assert count_before + length(updated_item_ids) == count_after
end
</code></pre>
<p>That's a very long test.
Take a moment to read it through.
Remember: this will be deleted,
it's just data migration code.</p>
<h3 id="define-add_items_to_all_list1"><a class="header" href="#define-add_items_to_all_list1">Define <code>add_items_to_all_list/1</code></a></h3>
<p>In the 
<code>lib/app/list_item.ex</code>
file,
add the <code>add_items_to_all_list/1</code> function definition:</p>
<pre><code class="language-elixir">def add_items_to_all_list(person_id) do
  all_list = App.List.get_list_by_text!(person_id, &quot;All&quot;)
  all_items = App.Item.all_items_for_person(person_id)
  item_ids_in_all_list = get_items_on_all_list(person_id)

  all_items
  |&gt; Enum.with_index()
  |&gt; Enum.each(fn {item, index} -&gt;
    unless Enum.member?(item_ids_in_all_list, item.id) do
      add_list_item(item, all_list, person_id, (index + 1) / 1)
    end
  end)
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="default-lists"><a class="header" href="#default-lists">Default <code>lists</code></a></h1>
<p>We want <code>people</code> to use our <code>App</code> 
for a wide variety of areas/projects in their life+work.
Therefore we are creating several <code>default</code> <code>lists</code> 
for them when they first authenticate.
See: <a href="https://github.com/dwyl/mvp/issues/401">dwyl/mvp#401</a>
for the discussion.</p>
<blockquote>
<p><strong>Note</strong>: This section is &quot;parked&quot; here in the <code>book</code> for future reference.
The <code>default lists</code> feature is not yet integrated into the <code>MVP</code>.
Once we have an idea of which <code>default lists</code> we want to work on
in terms of interface/experience,
we can easily enable it and guide people through the workflow.</p>
</blockquote>
<h3 id="test-creating-default-lists"><a class="header" href="#test-creating-default-lists">Test creating &quot;Default&quot; <code>lists</code></a></h3>
<p>Let's write a quick test to
confirm that our <code>default lists</code> are created.</p>
<pre><code class="language-elixir">test &quot;create_default_lists/1 creates the default lists&quot; do
  # Should have no lists:
  person_id = 3
  lists = App.List.get_lists_for_person(person_id)
  assert length(lists) == 0
  # Create the default lists for this person_id:
  assert List.create_default_lists(person_id) |&gt; length() == 9
end
</code></pre>
<blockquote>
<p><strong>Note</strong>: at present we have <strong>9</strong> <code>default lists</code>
This is just a <em>suggested</em> collection of <em>generic</em> <code>lists</code>. 
We could easily have fewer or more.
Please discuss! 
<a href="https://github.com/dwyl/mvp/issues/401">dwyl/mvp#401</a></p>
</blockquote>
<h3 id="define-create_default_lists1"><a class="header" href="#define-create_default_lists1">Define <code>create_default_lists/1</code></a></h3>
<pre><code class="language-elixir">@default_lists ~w(All Goals Fitness Meals Recipes Reading Shopping Today Todo)

def create_default_lists(person_id) do
  # Check if the &quot;All&quot; list exists for the person_id
  lists = get_lists_for_person(person_id)
  # Extract just the list.text (name) from the person's lists:
  list_names = Enum.reduce(lists, [], fn l, acc -&gt; [l.text | acc] end)
  # Quick check for length of lists:
  if length(list_names) &lt; length(@default_lists) do
    create_list_if_not_exists(list_names, person_id)
    # Re-fetch the list of lists for the person_id
    get_lists_for_person(person_id)
  else
    # Return the list we got above
    lists
  end
end

@doc &quot;&quot;&quot;
`create_list_if_not_exists/1` create the default &quot;All&quot; list
for the `person_id` if it does not already exist.
&quot;&quot;&quot;
def create_list_if_not_exists(list_names, person_id) do
  Enum.each(@default_lists, fn name -&gt;
    # Create the list if it does not already exists
    unless Enum.member?(list_names, name) do
      %{name: name, person_id: person_id, status: 2}
      |&gt; List.create_list()
    end
  end)
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reordering-items-in-a-list"><a class="header" href="#reordering-items-in-a-list">Reordering <code>items</code> in a <code>list</code></a></h1>
<p>The <code>people</code> who 
<a href="https://github.com/dwyl/mvp/issues/140">tested</a>
the <code>MVP</code>
noted that the ability to <strong><em>organise</em> their <code>items</code></strong>
as an <strong><em>essential</em> feature</strong>:
<a href="https://github.com/dwyl/mvp/issues/145">dwyl/mvp#145</a></p>
<p>With the addition of <code>lists</code>
we now have a way of <em>organising</em> our <code>items</code>
using the <code>list.seq</code> or <code>sequence</code>. </p>
<p>This chapter will take you through how we implented reordering
in the <code>MVP</code> from first principals.</p>
<blockquote>
<p><strong>Note</strong>: There is quite a lot to cover in this chapter,
so we have created two <em>standalone</em>
tutorials:
<a href="https://github.com/dwyl/learn-alpine.js/blob/main/drag-and-drop.md">drag-and-drop</a>
and 
<a href="https://github.com/dwyl/phoenix-liveview-realtime-cursor-tracking-tutorial">cursor-tracking</a>
which detail the mechanics of dragging and dropping <code>items</code>
and cursor tracking across browsers/devices.
If you are totally new to drag-and-drop,
we suggest following at least that one for full context.</p>
</blockquote>
<h1 id="todo-upload-screenshot-of-item-being-moved-in-interface-as-visual-explainer-before-diving-into-code"><a class="header" href="#todo-upload-screenshot-of-item-being-moved-in-interface-as-visual-explainer-before-diving-into-code">TODO: upload screenshot of <code>item</code> being moved in interface as visual explainer <code>before</code> diving into code!</a></h1>
<h2 id="getset-listcid-in-mount3"><a class="header" href="#getset-listcid-in-mount3">Get/Set <code>list.cid</code> in <code>mount/3</code></a></h2>
<p>In order for us to know which <code>list</code> 
the <code>person</code> is viewing - and thus reordering - 
we need to add it to the <code>socket.assigns</code> in the <code>mount/3</code> function.
Open the <code>lib/app_web/live/app_live.ex</code> file 
and locate the <code>mount/3</code> function.</p>
<p>Add the following lines to the body:</p>
<pre><code class="language-elixir"># Create or Get the &quot;all&quot; list for the person_id
all_list = App.List.get_all_list_for_person(person_id)
# Temporary function to add All *existing* items to the &quot;All&quot; list:
App.List.add_all_items_to_all_list_for_person_id(person_id)
</code></pre>
<p>This is invoking two functions we previously created in <code>lists</code>.</p>
<p>Then in the returned tuple:</p>
<pre><code class="language-elixir">{:ok,
     assign(socket,
       items: items,
       etc.
</code></pre>
<p>Make sure to add the line:</p>
<pre><code class="language-elixir">       list_cid: all_list.cid,
</code></pre>
<p>That will ensure that we know the <code>list.cid</code> 
later when the <code>person</code> reorders their <code>items</code>.</p>
<h2 id="moving-items-in-the-interface"><a class="header" href="#moving-items-in-the-interface">Moving <code>items</code> in the interface</a></h2>
<h3 id="update-the-li"><a class="header" href="#update-the-li">Update the <code>&lt;li&gt;</code></a></h3>
<p>In the <code>lib/app_web/live/app_live.html.heex</code> file,
locate the <code>&lt;ul&gt;</code> (unordered list) defintion:</p>
<pre><code class="language-html">  &lt;!-- List of items with inline buttons and controls --&gt;
  &lt;ul class=&quot;w-full&quot;&gt;
    &lt;%= for item &lt;- filter_items(@items, @filter, @filter_tag) do %&gt;
      &lt;li
        data-id={item.id}
        class=&quot;mt-2 flex w-full border-t border-slate-200 py-2&quot;
      &gt;
</code></pre>
<p>Replace it with the following:</p>
<pre><code class="language-html">  &lt;!-- List of items with inline buttons and controls --&gt;
  &lt;ul id=&quot;items&quot; phx-hook=&quot;Items&quot; x-data=&quot;{selectedItem: null}&quot; class=&quot;w-full&quot;&gt;
    &lt;%= for item &lt;- filter_items(@items, @filter, @filter_tag) do %&gt;
      &lt;li
        id={&quot;item-#{item.id}&quot;}
        data-id={item.id}
        class={&quot;mt-2 flex flex-col w-full border-t border-slate-200 py-2 item 
            #{if item.id == @editing do 'cursor-default' else 'cursor-grab' end}&quot;}
        draggable={&quot;#{if item.id == @editing do 'false' else 'true' end}&quot;}
        x-data=&quot;{selected: false}&quot;
        x-on:dragstart=&quot;selected = true; $dispatch('highlight', {id: $el.id}); selectedItem = $el&quot;
        x-on:dragend=&quot;selected = false; $dispatch('remove-highlight', {id: $el.id}); selectedItem = null; $dispatch('update-indexes', {fromItemId: $el.dataset.id})&quot;
        x-bind:class=&quot;selected ?? 'cursor-grabbing'&quot;
        x-on:dragover.throttle=&quot;$dispatch('dragoverItem', {selectedItemId: selectedItem.id, currentItem: $el})&quot;
        data-highlight={JS.add_class(&quot;bg-teal-300&quot;)}
        data-remove-highlight={JS.remove_class(&quot;bg-teal-300&quot;)}
      &gt;
</code></pre>
<p>There's a <em>lot</em> going on in this definition.
But it's all related to 5 key areas:</p>
<ol>
<li><em>Select</em> an <code>item</code> to be moved/reordered</li>
<li><em>Add</em> a highlight when an <code>item</code> is selected</li>
<li>_Display) the appropriate <code>cursor-grabbing</code> class when the <code>item</code> is selected.</li>
<li><em>Dispatch</em> the <code>dragoverItem</code> event so that other connected clients can see the <code>item</code> being moved</li>
<li><em>Remove</em> the <code>highlight</code> when the <code>item</code> is no longer selected.</li>
</ol>
<blockquote>
<p><strong>Note</strong>: if you feel this section could benefit from further explanation,
please <em>first</em> read: 
<a href="https://github.com/dwyl/learn-alpine.js/blob/main/drag-and-drop.md">drag-and-drop</a>
and 
<a href="https://github.com/dwyl/phoenix-liveview-realtime-cursor-tracking-tutorial">cursor-tracking</a>
And if anything is still unclear, 
please open an issue:
<a href="https://github.com/dwyl/book/issues">dwyl/book/issues</a></p>
</blockquote>
<h2 id="add-js-event-handling-code"><a class="header" href="#add-js-event-handling-code">Add <code>JS</code> event handling code:</a></h2>
<p>In the <code>assets/js/app.js</code> file,
add the following code:</p>
<pre><code class="language-js">// Drag and drop highlight handlers
window.addEventListener(&quot;phx:highlight&quot;, (e) =&gt; {
  document.querySelectorAll(&quot;[data-highlight]&quot;).forEach(el =&gt; {
    if(el.id == e.detail.id) {
        liveSocket.execJS(el, el.getAttribute(&quot;data-highlight&quot;))
    }
  })
})

// Item id of the destination in the DOM
let itemId_to;

let Hooks = {}
Hooks.Items = {
  mounted() {
    const hook = this

    this.el.addEventListener(&quot;highlight&quot;, e =&gt; {
      hook.pushEventTo(&quot;#items&quot;, &quot;highlight&quot;, {id: e.detail.id})
      // console.log('highlight', e.detail.id)
    })

    this.el.addEventListener(&quot;remove-highlight&quot;, e =&gt; {
      hook.pushEventTo(&quot;#items&quot;, &quot;removeHighlight&quot;, {id: e.detail.id})
      // console.log('remove-highlight', e.detail.id)
    })

    this.el.addEventListener(&quot;dragoverItem&quot;, e =&gt; {
      // console.log(&quot;dragoverItem&quot;, e.detail)
      const currentItemId = e.detail.currentItem.id
      const selectedItemId = e.detail.selectedItemId
      if( currentItemId != selectedItemId) {
        hook.pushEventTo(&quot;#items&quot;, &quot;dragoverItem&quot;, {currentItemId: currentItemId, selectedItemId: selectedItemId})
        itemId_to = e.detail.currentItem.dataset.id
      }
    })

    this.el.addEventListener(&quot;update-indexes&quot;, e =&gt; {
      const item_id = e.detail.fromItemId 
      const list_ids = get_list_item_cids()
      console.log(&quot;update-indexes&quot;, e.detail, &quot;list: &quot;, list_ids)
      // Check if both &quot;from&quot; and &quot;to&quot; are defined
      if(item_id &amp;&amp; itemId_to &amp;&amp; item_id != itemId_to) {
        hook.pushEventTo(&quot;#items&quot;, &quot;update_list_seq&quot;, 
          {seq: list_ids})
      }
      
      itemId_to = null;
    })
  }
}

/**
 * `get_list_item_ids/0` retrieves the full `list` of visible `items` form the DOM
 * and returns a String containing the IDs as a space-separated list e.g: &quot;1 2 3 42 71 93&quot;
 * This is used to determine the `position` of the `item` that has been moved.
 */
function get_list_item_cids() {
  console.log(&quot;invoke get_list_item_ids&quot;)
  const lis = document.querySelectorAll(&quot;label[phx-value-cid]&quot;);
  return Object.values(lis).map(li =&gt; {
    return li.attributes[&quot;phx-value-cid&quot;].nodeValue
  }).join(&quot;,&quot;)
}

window.addEventListener(&quot;phx:remove-highlight&quot;, (e) =&gt; {
  document.querySelectorAll(&quot;[data-highlight]&quot;).forEach(el =&gt; {
    if(el.id == e.detail.id) {
        liveSocket.execJS(el, el.getAttribute(&quot;data-remove-highlight&quot;))
    }
  })
})

window.addEventListener(&quot;phx:dragover-item&quot;, (e) =&gt; {
  console.log(&quot;phx:dragover-item&quot;, e.detail)
  const selectedItem = document.querySelector(`#${e.detail.selected_item_id}`)
  const currentItem = document.querySelector(`#${e.detail.current_item_id}`)

  const items = document.querySelector('#items')
  const listItems = [...document.querySelectorAll('.item')]

  if(listItems.indexOf(selectedItem) &lt; listItems.indexOf(currentItem)){
    items.insertBefore(selectedItem, currentItem.nextSibling)
  }

  if(listItems.indexOf(selectedItem) &gt; listItems.indexOf(currentItem)){
    items.insertBefore(selectedItem, currentItem)
  }
})
</code></pre>
<p>Again, there's a fair amount of code there 
so take a moment to step through it 
and understand what each event listener does.</p>
<h2 id="handle-the-update_list_seq-event"><a class="header" href="#handle-the-update_list_seq-event">Handle the <code>update_list_seq</code> event</a></h2>
<p>Back in the <code>LiveView</code> file,
<code>lib/app_web/live/app_live.ex</code>
add the following event handlers:</p>
<pre><code class="language-elixir"> @impl true
  def handle_event(&quot;highlight&quot;, %{&quot;id&quot; =&gt; id}, socket) do
    # IO.puts(&quot;highlight: #{id}&quot;)
    AppWeb.Endpoint.broadcast(@topic, &quot;move_items&quot;, {:drag_item, id})
    {:noreply, socket}
  end

  @impl true
  def handle_event(&quot;removeHighlight&quot;, %{&quot;id&quot; =&gt; id}, socket) do
    # IO.puts(&quot;removeHighlight: #{id}&quot;)
    AppWeb.Endpoint.broadcast(@topic, &quot;move_items&quot;, {:drop_item, id})
    {:noreply, socket}
  end

  @impl true
  def handle_event(
        &quot;dragoverItem&quot;,
        %{
          &quot;currentItemId&quot; =&gt; current_item_id,
          &quot;selectedItemId&quot; =&gt; selected_item_id
        },
        socket
      ) do
    # IO.puts(&quot;285: current_item_id: #{current_item_id}, selected_item_id: #{selected_item_id} | #{Useful.typeof(selected_item_id)}&quot;)
    AppWeb.Endpoint.broadcast(
      @topic,
      &quot;move_items&quot;,
      {:dragover_item, {current_item_id, selected_item_id}}
    )

    {:noreply, socket}
  end

  @impl true
  def handle_info(
        %Broadcast{
          event: &quot;move_items&quot;,
          payload: {:dragover_item, {current_item_id, selected_item_id}}
        },
        socket
      ) do
    # IO.puts(
    #   &quot;cur_item_id: #{current_item_id}, selected_item_id: #{selected_item_id}&quot;
    # )

    {:noreply,
     push_event(socket, &quot;dragover-item&quot;, %{
       current_item_id: current_item_id,
       selected_item_id: selected_item_id
     })}
  end

  @impl true
  def handle_info(
        %Broadcast{event: &quot;move_items&quot;, payload: {:drag_item, item_id}},
        socket
      ) do
    {:noreply, push_event(socket, &quot;highlight&quot;, %{id: item_id})}
  end

  @impl true
  def handle_info(
        %Broadcast{event: &quot;move_items&quot;, payload: {:drop_item, item_id}},
        socket
      ) do
    {:noreply, push_event(socket, &quot;remove-highlight&quot;, %{id: item_id})}
  end


  @impl true
  def handle_event(
        &quot;update_list_seq&quot;,
        %{&quot;seq&quot; =&gt; seq},
        socket
      ) do
    list_cid = get_list_cid(socket.assigns)
    person_id = get_person_id(socket.assigns)
    App.List.update_list_seq(list_cid, person_id, seq)
    {:noreply, socket}
  end
</code></pre>
<p>All the <code>highlight</code>, <code>remove-highlight</code> and <code>move_items</code> 
handlers are for presentation and synching between clients.
The handler that performs the actual list updating is:</p>
<pre><code class="language-elixir">  @impl true
  def handle_event(
        &quot;update_list_seq&quot;,
        %{&quot;seq&quot; =&gt; seq},
        socket
      ) do
    list_cid = get_list_cid(socket.assigns)
    person_id = get_person_id(socket.assigns)
    App.List.update_list_seq(list_cid, person_id, seq)
    {:noreply, socket}
  end
</code></pre>
<p>This receives the <code>seq</code> (sequence of <code>item.cid</code>)
from the client and and updates the <code>list.seq</code>
using the previously defined <code>update_list_seq/3</code> function.</p>
<p>With this code in place we now have everything we need for reordering <code>items</code> on a <em>single</em> <code>list</code>. 
Try it!</p>
<h2 id="add-a-test"><a class="header" href="#add-a-test">Add a Test!</a></h2>
<p>To ensure this feature is tested,
open the 
<code>test/app_web/live/app_live_test.exs</code>
file and add the following test:</p>
<pre><code class="language-elixir">  test &quot;Drag and Drop item&quot;, %{conn: conn} do
    person_id = 0
    # Creating Three items
    {:ok, %{model: item}} =
      Item.create_item(%{text: &quot;Learn Elixir&quot;, person_id: person_id, status: 2})

    {:ok, %{model: item2}} =
      Item.create_item(%{ text: &quot;Build Awesome App&quot;, person_id: person_id, status: 2})

    {:ok, %{model: item3}} =
      Item.create_item(%{ text: &quot;Profit&quot;, person_id: person_id, status: 2})

    # Create &quot;all&quot; list for this person_id:
    list = App.List.get_all_list_for_person(person_id)

    # Add all items to &quot;all&quot; list:
    App.List.add_all_items_to_all_list_for_person_id(person_id)

    # Render LiveView
    {:ok, view, _html} = live(conn, &quot;/&quot;)

    # Highlight broadcast should have occurred
    assert render_hook(view, &quot;highlight&quot;, %{&quot;id&quot; =&gt; item.id})
      |&gt; String.split(&quot;bg-teal-300&quot;)
      |&gt; Enum.drop(1)
      |&gt; length() &gt; 0

    # Dragover and remove highlight
    render_hook(view, &quot;dragoverItem&quot;, %{
      &quot;currentItemId&quot; =&gt; item2.id,
      &quot;selectedItemId&quot; =&gt; item.id
    })

    assert render_hook(view, &quot;removeHighlight&quot;, %{&quot;id&quot; =&gt; item.id})

    # reorder items:
    render_hook(view, &quot;updateIndexes&quot;, %{
      &quot;seq&quot; =&gt; &quot;#{item.cid},#{item2.cid},#{item3.cid}&quot;
    })

    all_list = App.List.get_all_list_for_person(person_id)
    seq = App.List.get_list_seq(all_list)
    pos1 = Enum.find_index(seq, fn x -&gt; x == &quot;#{item.cid}&quot; end)
    pos2 = Enum.find_index(seq, fn x -&gt; x == &quot;#{item2.cid}&quot; end)
    # IO.puts(&quot;#{pos1}: #{item.cid}&quot;)
    # IO.puts(&quot;#{pos2}: #{item2.cid}&quot;)

    assert pos1 &lt; pos2

    # Update list_item.seq:
    {:ok, %{model: list}} = App.List.update_list_seq(list.cid, person_id, 
        &quot;#{item.cid},#{item3.cid},#{item2.cid}&quot;)
    new_seq = list.seq |&gt; String.split(&quot;,&quot;)
    # dbg(new_seq)
    pos2 = Enum.find_index(new_seq, fn x -&gt; x == &quot;#{item2.cid}&quot; end)
    pos3 = Enum.find_index(new_seq, fn x -&gt; x == &quot;#{item3.cid}&quot; end)
    assert pos3 &lt; pos2
  end
</code></pre>
<p>Again, there's a <em>lot</em> going on in this test 
because it's testing for 
both the <code>highlight</code> 
<em>and</em> the update of the <code>seq</code> (sequence of <code>item.cid</code>) in the <code>list</code>.
Take a momemnt to step through it and if you have any questions, ask!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="metrics"><a class="header" href="#metrics">Metrics</a></h1>
<p>This chapter adds a few basic metrics for the <code>people</code> using the <code>MVP</code>. üìà <br />
If you have ideas for additional stats you want to see,
please open an issue:
<a href="https://github.com/dwyl/mvp/issues">dwyl/mvp/issues</a> üôè</p>
<h2 id="adding-sorting-to-the-track-metrics-table-and-more-additional-fields"><a class="header" href="#adding-sorting-to-the-track-metrics-table-and-more-additional-fields">Adding Sorting to the track metrics table and more additional fields</a></h2>
<p>What happens when we need to track more <code>metrics</code>?
And even, when we get more users on the <code>MVP</code>?</p>
<p>How can we sort the <code>columns</code> to make it easier to understand the data?</p>
<p>One of the most intuitive ways to manage large datasets is by enabling sorting.
It allows users to arrange data in a manner that's most meaningful to them, be it in ascending or descending order.
This makes it significantly easier to spot trends, anomalies, or specific data points.</p>
<p>In this section, we will <code>supercharge</code> our track metrics table, we will:</p>
<ul>
<li>Introduce new columns (First Joined, Last Item Inserted and Total Elapsed Time)</li>
<li>Highlight your user on the table</li>
<li>Create a Table <code>LiveComponent</code> to componentize our table that can be used throughout the application</li>
<li>Implement Column Sorting</li>
</ul>
<p>Sneak Peek ;D
<img width="1016" alt="image" src="https://github.com/dwyl/mvp/assets/2154092/2240d91f-cdf3-4b6c-ba05-1929b764c7d8"></p>
<h2 id="add-new-columns"><a class="header" href="#add-new-columns">Add new columns</a></h2>
<p>With the growth of our MVP, we've identified the need for more detailed metrics. This involves adding more fields to our existing stats query.</p>
<p>Since our new fields have dates to be shown we need a way to format them.</p>
<p>Let's create a new file called <code>date_time_helper.ex</code> inside the <code>lib/app</code> folder.</p>
<pre><code class="language-elixir">defmodule App.DateTimeHelper do
  require Decimal
  alias Timex.{Duration}

  def format_date(date) do
    Calendar.strftime(date, &quot;%m/%d/%Y %H:%M:%S&quot;)
  end

  def format_duration(nil), do: &quot;&quot;

  def format_duration(seconds) when Decimal.is_decimal(seconds) do
    duration = seconds |&gt; Decimal.to_integer() |&gt; Duration.from_seconds()

    Timex.format_duration(duration, :humanized)
  end

  def format_duration(_seconds), do: &quot;&quot;
end
</code></pre>
<p>This is a new helper module that we are going to use to format dates and durations.</p>
<p>We will need the <code>Decimal</code> and the <a href="https://hexdocs.pm/timex/Timex.html">Timex</a> library to format it.</p>
<p><code>require Decimal</code></p>
<p>This line tells Elixir that you will be using macros from the Decimal module. This is needed because the code calls Decimal.is_decimal/1 later.</p>
<p><code>alias Timex.{Duration}</code></p>
<p>An alias is a way to reference a module with a shorter name. Here, we're creating an alias for Timex.Duration so that we can simply write Duration instead of the full module name.</p>
<pre><code class="language-elixir">def format_date(date) do
  Calendar.strftime(date, &quot;%m/%d/%Y %H:%M:%S&quot;)
end
</code></pre>
<p>This function takes in a date and returns a formatted string in the pattern &quot;MM/DD/YYYY HH:MM:SS&quot;. It uses the strftime function from the <a href="https://hexdocs.pm/elixir/1.13/Calendar.html">Calendar</a> module to accomplish this.</p>
<pre><code class="language-elixir">def format_duration(nil), do: &quot;&quot;

def format_duration(seconds) when Decimal.is_decimal(seconds) do
  duration = seconds |&gt; Decimal.to_integer() |&gt; Duration.from_seconds()

  Timex.format_duration(duration, :humanized)
end

def format_duration(_seconds), do: &quot;&quot;
</code></pre>
<p>The first function clause matches when the input is nil. It simply returns an empty string.</p>
<p>The second clause is where the <code>juicy</code> is, it  matches when the given seconds is a decimal (in this case, it's what is going to be return from Ecto). It does the following:</p>
<ul>
<li>Checks if seconds is a decimal using Decimal.is_decimal/1.</li>
<li>Converts the decimal value of seconds to an integer using Decimal.to_integer/1.</li>
<li>Converts the integer value to a duration using <a href="https://hexdocs.pm/timex/Timex.Duration.html#from_seconds/1">Duration.from_seconds/1</a>.</li>
<li>Formats the duration using <a href="https://hexdocs.pm/timex/Timex.html#format_duration/2">Timex.format_duration/2</a> with a :humanized option.</li>
</ul>
<p>The last clause of the format_duration/1 function matches any input (other than nil and decimals, which were handled by the previous clauses). This function simply returns an empty string.</p>
<p>In summary, this App.DateTimeHelper module provides utility functions to format dates and durations. Dates are formatted in the &quot;MM/DD/YYYY HH:MM:SS&quot; pattern, while durations are formatted in a humanized form if they are decimals; otherwise, an empty string is returned. If we want we could possibly extend this module to more utilities functions.</p>
<p>Now, we can create some tests for this new module, inside the <code>test/app</code> create a new file called <code>date_time_helper_test.exs</code> with the following content.</p>
<pre><code class="language-elixir">defmodule App.DateTimeHelperTest do
  use ExUnit.Case
  alias App.DateTimeHelper
  alias Timex

  describe &quot;format_date/1&quot; do
    test &quot;formats a date correctly&quot; do
      dt = Timex.parse!(&quot;2023-08-02T15:30:30+00:00&quot;, &quot;{ISO:Extended}&quot;)
      assert DateTimeHelper.format_date(dt) == &quot;08/02/2023 15:30:30&quot;
    end
  end

  describe &quot;format_duration/1&quot; do
    test &quot;returns an empty string for nil&quot; do
      assert DateTimeHelper.format_duration(nil) == &quot;&quot;
    end

    test &quot;returns an empty string when other than decimal&quot; do
      assert DateTimeHelper.format_duration(12345) == &quot;&quot;
    end

    test &quot;formats a duration correctly&quot; do
      duration_seconds = Decimal.new(12345)

      assert DateTimeHelper.format_duration(duration_seconds) ==
               &quot;3 hours, 25 minutes, 45 seconds&quot;
    end

    test &quot;formats a zero decimal duration correctly&quot; do
      duration_seconds = Decimal.new(0)

      assert DateTimeHelper.format_duration(duration_seconds) ==
               &quot;0 microseconds&quot;
    end
  end
end
</code></pre>
<p>This file tests various cases using the <code>DateTimeHelper</code>, feel free to take your time to understand each one.</p>
<p>With our Helper fully tested we can now modify our <code>item.ex</code> to return the new columns that we want in our Stats Live page.</p>
<p>Open <code>item.ex</code> and update the <code>person_with_item_and_timer_count/0</code> method:</p>
<pre><code class="language-elixir">def person_with_item_and_timer_count() do
  sql = &quot;&quot;&quot;
  SELECT i.person_id,
  COUNT(distinct i.id) AS &quot;num_items&quot;,
  COUNT(distinct t.id) AS &quot;num_timers&quot;,
  MIN(i.inserted_at) AS &quot;first_inserted_at&quot;,
  MAX(i.inserted_at) AS &quot;last_inserted_at&quot;,
  SUM(EXTRACT(EPOCH FROM (t.stop - t.start))) AS &quot;total_timers_in_seconds&quot;
  FROM items i
  LEFT JOIN timers t ON t.item_id = i.id
  GROUP BY i.person_id
  &quot;&quot;&quot;

  Ecto.Adapters.SQL.query!(Repo, sql)
  |&gt; map_columns_to_values()
end
</code></pre>
<p>We are just adding three new columns to it, <code>first_inserted_at</code>, <code>last_inserted_at</code> and <code>total_timers_in_seconds</code>.</p>
<p><code>MIN(i.inserted_at) AS &quot;first_inserted_at&quot;</code></p>
<p>This column gets the earliest <code>inserted_at</code> timestamp from the <code>items</code> table for each <code>person_id</code>. The <code>MIN</code> SQL function retrieves the minimum value in the <code>inserted_at</code> column for each group of records with the same <code>person_id</code>.</p>
<p><code>MAX(i.inserted_at) AS &quot;last_inserted_at&quot;</code></p>
<p>Conversely, this column gets the most recent <code>inserted_at</code> timestamp from the <code>items</code> table for each <code>person_id</code>. The <code>MAX</code> SQL function retrieves the maximum value in the <code>inserted_at</code> column for each group of records with the same <code>person_id</code>.</p>
<p><code>SUM(EXTRACT(EPOCH FROM (t.stop - t.start))) AS &quot;total_timers_in_seconds&quot;</code></p>
<p>This one is more tricky, but don't worry. This column calculates the total duration of all timers associated with each item for a given <code>person_id</code>.</p>
<p>The inner expression <code>(t.stop - t.start)</code> calculates the duration of each timer by subtracting the start time from the stop time, this will give us a resulted timestamp that is the difference between the two.</p>
<p>The <code>EXTRACT(EPOCH FROM ...)</code> function then converts this duration into <code>seconds</code>. Finally, the SUM function aggregates (sums up) all these durations for each group of records with the same <code>person_id</code>.</p>
<p>You can read more about the EXTRACT PostgreSQL function <a href="https://www.postgresqltutorial.com/postgresql-date-functions/postgresql-extract/">here</a>.</p>
<p>Done!</p>
<p>There is one last thing we need to do to show our new columns on the Phoenix template.</p>
<p>We need to add a helpers in our <code>stats_live.ex</code> file so we can format the date and duration.</p>
<p>Open this file and add the following code in the beggining of the file and the two methods on the end:</p>
<pre><code class="language-elixir">defmodule AppWeb.StatsLive do
  ...
  alias App.{Item, DateTimeHelper}
  ...

  def format_date(date) do
    DateTimeHelper.format_date(date)
  end

  def format_seconds(seconds) do
    DateTimeHelper.format_duration(seconds)
  end
end
</code></pre>
<p>This is just calling the DateTimeHelper module with the methods that we created.</p>
<p>Great! Now we can show or new columns inside the <code>Phoenix</code> Template.</p>
<p>Open the <code>stats_live.html.heex</code> and update the table to add the new columns and fields:</p>
<pre><code class="language-html">&lt;table class=&quot;text-sm text-left text-gray-500 dark:text-gray-400 table-auto&quot;&gt;
  &lt;thead class=&quot;text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400&quot;&gt;
    &lt;tr&gt;
      ...
      &lt;th scope=&quot;col&quot; class=&quot;px-6 py-3 text-center&quot;&gt;
        First Joined
      &lt;/th&gt;
      &lt;th scope=&quot;col&quot; class=&quot;px-6 py-3 text-center&quot;&gt;
        Last Item Inserted
      &lt;/th&gt;
      &lt;th scope=&quot;col&quot; class=&quot;px-6 py-3 text-center&quot;&gt;
        Total Elapsed Time
      &lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;%= for metric &lt;- @metrics do %&gt;
      &lt;tr class=&quot;bg-white border-b dark:bg-gray-800 dark:border-gray-700&quot;&gt;
        ...
        &lt;td class=&quot;px-6 py-4 text-center&quot;&gt;
          &lt;%= format_date(metric.first_inserted_at) %&gt;
        &lt;/td&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot;&gt;
          &lt;%= format_date(metric.last_inserted_at) %&gt;
        &lt;/td&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot;&gt;
          &lt;%= format_seconds(metric.total_timers_in_seconds) %&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;% end %&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
<p>Done! Now we have our new columns and rows with the appropriate information as planned and already formatted.</p>
<p>The next tasks will only enhance that!</p>
<h2 id="highlight-your-user-on-the-table"><a class="header" href="#highlight-your-user-on-the-table">Highlight your user on the table</a></h2>
<p>To emphasize the currently logged-in user within the table, we'll first need to retrieve the user's information within our Phoenix LiveView, similar to how <code>app_live</code> operates.</p>
<p>Begin by opening <code>stats_live.ex</code> and add the following code:</p>
<pre><code class="language-elixir">defmodule AppWeb.StatsLive do
  ...
  @stats_topic &quot;stats&quot;

  defp get_person_id(assigns), do: assigns[:person][:id] || 0

  @impl true
  def mount(_params, _session, socket) do
    ...

    person_id = get_person_id(socket.assigns)
    metrics = Item.person_with_item_and_timer_count()

    {:ok,
     assign(socket,
       person_id: person_id,
       metrics: metrics,
     )}
  end

  ...
end
</code></pre>
<p>Now to explain the changes.</p>
<p><code>defp get_person_id(assigns), do: assigns[:person][:id] || 0</code></p>
<p>This function attempts to extract the <code>:id</code> of the <code>:person</code> from the given <code>assigns</code> (a map or struct). If it doesn't find an ID, it defaults to <code>0</code>.</p>
<p><code>person_id = get_person_id(socket.assigns)</code></p>
<p>This line inside the <code>mount/3</code> retrieves the <code>person_id</code> from the <code>socket.assigns</code> using the aforementioned private function.</p>
<p>Furthermore, the <code>assign/3</code> function call has been updated to include this <code>person_id</code> in the socket's assigns.</p>
<p>In the previous step, we made adjustments to the <code>AppWeb.StatsLive</code> module to extract the <code>person_id</code> of the currently logged-in user. Now, it's time to use that to visually distinguish the user's row in our table.</p>
<p>Open the <code>stats_live.html.heex</code> file, where our table is defined. We're going to conditionally set the background and border colors of each table row based on whether the row corresponds to the currently logged-in user.</p>
<p>Locate the <code>&lt;tbody&gt;</code> section of your table, where each metric from <code>@metrics</code> is looped over to generate table rows and update the code to the following below:</p>
<pre><code class="language-html">...

&lt;/thead&gt;
&lt;tbody&gt;
  &lt;%= for metric &lt;- @metrics do %&gt;
    &lt;tr class={
      if metric.person_id == @person_id,
        do:
          &quot;bg-teal-100 border-teal-500 dark:bg-teal-800 dark:border-teal-700&quot;,
        else: &quot;bg-white border-b dark:bg-gray-800 dark:border-gray-700&quot;
    }&gt;
      &lt;td class=&quot;px-6 py-4&quot;&gt;
        &lt;a href={person_link(metric.person_id)}&gt;
          &lt;%= metric.person_id %&gt;
...
</code></pre>
<p>What we're doing here is checking if the <code>person_id</code> of the current metric matches the <code>@person_id</code> (the ID of the logged-in user). If it does:</p>
<ul>
<li>The row will have a teal background (<code>bg-teal-100</code>) and border (<code>border-teal-500</code>).</li>
<li>In dark mode, it will have a darker teal background (<code>dark:bg-teal-800</code>) and border (<code>dark:border-teal-700</code>).</li>
</ul>
<p>And if the IDs don't match, the row will maintain the same look.</p>
<p>With these changes, when you view your table now, the row corresponding to the currently logged-in user will be distinctly highlighted, providing an intuitive visual cue for users.</p>
<h2 id="creating-a-table-livecomponent"><a class="header" href="#creating-a-table-livecomponent">Creating a Table LiveComponent</a></h2>
<p>In this section we are going to build a <code>LiveComponent</code> that can be reused throughout our application.</p>
<p>This <code>LiveComponent</code> will be a table with dynamic rows and columns so we can create other tables if needed. This will be a good showcase of the <code>LiveComponent</code> capabilities as well.</p>
<p>From the <code>Phoenix.LiveComponent</code> <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveComponent.html">docs</a>:</p>
<blockquote>
<p>LiveComponents are a mechanism to compartmentalize state, markup, and events in LiveView.</p>
</blockquote>
<p>So with that in mind, let's begin by creating our live component file.</p>
<p>Remember to create new folders if needed.</p>
<p>Create a new file inside the <code>lib/app_web/live/components/table_component.ex</code> with the following content:</p>
<pre><code class="language-elixir">defmodule AppWeb.TableComponent do
  use Phoenix.LiveComponent

  def render(assigns) do
    Phoenix.View.render(
      AppWeb.TableComponentView,
      &quot;table_component.html&quot;,
      assigns
    )
  end
end
</code></pre>
<p>This is a simple LiveComponent code that points to a new <code>table_component.html</code> template, let's create this file too inside the <code>lib/app_web/templates/table_component/table_component.html.heex</code> with the following content:</p>
<pre><code class="language-html">&lt;table class=&quot;text-sm text-left text-gray-500 dark:text-gray-400 table-auto&quot;&gt;
  &lt;thead class=&quot;text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400&quot;&gt;
    &lt;%= for column &lt;- @column do %&gt;
      &lt;th
        scope=&quot;col&quot;
        class=&quot;px-6 py-3 text-center cursor-pointer&quot;
      &gt;
        &lt;a href=&quot;#&quot; class=&quot;group inline-flex&quot;&gt;
          &lt;%= column.label %&gt;
        &lt;/a&gt;
      &lt;/th&gt;
    &lt;% end %&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;%= for row &lt;- @rows do %&gt;
      &lt;tr class={
        if @highlight.(row),
          do:
            &quot;bg-teal-100 border-teal-500 dark:bg-teal-800 dark:border-teal-700&quot;,
          else: &quot;bg-white border-b dark:bg-gray-800 dark:border-gray-700&quot;
      }&gt;
        &lt;%= for column &lt;- @column do %&gt;
          &lt;%= render_slot(column, row) %&gt;
        &lt;% end %&gt;
      &lt;/tr&gt;
    &lt;% end %&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
<p>Before we proceed, let's take a moment to understand what we've just created:</p>
<h3 id="the-livecomponent-file"><a class="header" href="#the-livecomponent-file">The LiveComponent File:</a></h3>
<ul>
<li>We've created a new <code>LiveComponent</code> named <code>AppWeb.TableComponent</code>.</li>
<li>This component uses <code>Phoenix.View.render/3</code> to render a template named <code>table_component.html</code>.</li>
</ul>
<h3 id="the-template-file"><a class="header" href="#the-template-file">The Template File:</a></h3>
<ul>
<li>This is a general-purpose table template with the all the current styles that we have on our <code>stats_live</code> template.</li>
<li>The headers (<thead>) of the table are dynamically generated based on the <code>@column</code> assign, which is expected to be a list of columns with their respective labels.</li>
<li>The body (<tbody>) of the table is dynamically generated based on the <code>@rows</code> assign. Each row's appearance can be conditionally modified using the <code>@highlight</code> function (we are going to use to highlight the current logged user, remember?).</li>
<li>The <code>render_slot/2</code> function suggests that this component will use &quot;<a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveComponent.html#module-slots">slots</a>&quot; - a feature in Phoenix LiveView that allows for rendering dynamic parts of a component.</li>
</ul>
<p>To finish the LiveComponent we just need to create our <code>view</code> file that will make everything work together, create this new file inside <code>lb/app_web/views/table_component_view.ex</code> with the following content:</p>
<pre><code class="language-elixir">defmodule AppWeb.TableComponentView do
  use AppWeb, :view
end
</code></pre>
<p>With that in place, we can update our Stats page to use this LiveComponent in a dynamic way. Open the <code>stats_live.html.heex</code> and make the following modifications:</p>
<pre><code class="language-html">...
      Stats
    &lt;/h1&gt;

    &lt;.live_component
      module={AppWeb.TableComponent}
      id=&quot;table_component&quot;
      rows={@metrics}
      highlight={&amp;is_highlighted_person?(&amp;1, @person_id)}
    &gt;
      &lt;:column :let={metric} label=&quot;Id&quot; key=&quot;person_id&quot;&gt;
        &lt;td class=&quot;px-6 py-4&quot; data-test-id=&quot;person_id&quot;&gt;
          &lt;a href={person_link(metric.person_id)}&gt;
            &lt;%= metric.person_id %&gt;
          &lt;/a&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column :let={metric} label=&quot;Items&quot; key=&quot;num_items&quot;&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;num_items&quot;&gt;
          &lt;%= metric.num_items %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column :let={metric} label=&quot;Timers&quot; key=&quot;num_timers&quot;&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;num_timers&quot;&gt;
          &lt;%= metric.num_timers %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column :let={metric} label=&quot;First Joined&quot; key=&quot;first_inserted_at&quot;&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;first_inserted_at&quot;&gt;
          &lt;%= format_date(metric.first_inserted_at) %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column :let={metric} label=&quot;Last Item Inserted&quot; key=&quot;last_inserted_at&quot;&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;last_inserted_at&quot;&gt;
          &lt;%= format_date(metric.last_inserted_at) %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column
        :let={metric}
        label=&quot;Total Elapsed Time&quot;
        key=&quot;total_timers_in_seconds&quot;
      &gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;total_timers_in_seconds&quot;&gt;
          &lt;%= format_seconds(metric.total_timers_in_seconds) %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;
    &lt;/.live_component&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<p>Now let's breakdown the code.</p>
<pre><code class="language-html">&lt;.live_component
  module={AppWeb.TableComponent}
  id=&quot;table_component&quot;
  rows={@metrics}
  highlight={&amp;is_highlighted_person?(&amp;1, @person_id)}
&gt;
</code></pre>
<ul>
<li>The tag <code>&lt;.live_component&gt;</code> is the syntax to embed a LiveComponent within a LiveView.</li>
<li>We specify which LiveComponent to use using the <code>module</code> attribute. In this case, it's the <code>AppWeb.TableComponent</code> we discussed in the previous steps.</li>
<li>Setting the <code>id</code> is essential for Phoenix to keep track of the component's state across updates.</li>
<li><code>rows={@metrics}</code> passes the <code>@metrics</code> assign to the component as its rows property.</li>
<li><code>highlight={&amp;is_highlighted_person?(&amp;1, @person_id)}</code> passes a function as the highlight property to the component. This function checks if a given row should be highlighted. We will create this function inside our <code>stats_live.ex</code> on the next step.</li>
</ul>
<p>The next sections use the slot feature of LiveComponents:</p>
<pre><code class="language-html">&lt;:column :let={metric} label=&quot;Id&quot; key=&quot;person_id&quot;&gt;
  ...
&lt;/:column&gt;
</code></pre>
<ul>
<li><code>&lt;:column ...&gt;</code> is a slot. It tells the <code>TableComponent</code> how to render each cell of a column. The <code>:let={metric}</code> attribute means that inside this slot, you can access each row's data with the variable metric.</li>
<li><code>label=&quot;Id&quot;</code> specifies the header label for this column.</li>
<li><code>key=&quot;person_id&quot;</code> this key will be used to sort the columns when we get there.</li>
</ul>
<p>Inside each slot, the template for rendering the cell is provided. For instance:</p>
<pre><code class="language-html">&lt;td class=&quot;px-6 py-4&quot; data-test-id=&quot;person_id&quot;&gt;
  &lt;a href={person_link(metric.person_id)}&gt;
    &lt;%= metric.person_id %&gt;
  &lt;/a&gt;
&lt;/td&gt;
</code></pre>
<p>This renders a table cell with the <code>person_id</code> content. The <code>data-test-id</code> attribute will be used for testing purposes, making it easier to find this specific element in test scenarios, more about that later.</p>
<p>As a last update for this section we need to create the <code>is_highlighted_person?/2</code> method inside our <code>stats_live.ex</code> file:</p>
<pre><code class="language-elixir">defmodule AppWeb.StatsLive do

  ...

  def is_highlighted_person?(metric, person_id),
      do: metric.person_id == person_id
end
</code></pre>
<p>In summary, this code replaces the static table that we had with a dynamic one, utilizing our <code>TableComponent</code>.</p>
<p>Now you can run the code and see the same result that we had before.</p>
<h2 id="implement-column-sorting"><a class="header" href="#implement-column-sorting">Implement Column Sorting</a></h2>
<p>Finally, we are in our last section to add the column sorting feature!</p>
<p>For these we will need:</p>
<ul>
<li>Add the sorting logic inside our query and method of <code>item.ex</code> file.</li>
<li>Include the sort mechanism on the Table <code>LiveComponent</code> by adding a onclick event in the table header's</li>
<li>Add the event to sort on the <code>Stats LiveView</code></li>
<li>Create tests for everything</li>
</ul>
<p>To add the sorting logic inside <code>item.ex</code> file, we are going to create two parameters to our current method that fetches the stats. And we are going to validate the parameters as well.</p>
<p>Open the <code>item.ex</code> file and update to the following:</p>
<pre><code class="language-elixir">  ...

  def person_with_item_and_timer_count(
          sort_column \\ :person_id,
          sort_order \\ :asc
      ) do
    
    sort_column = to_string(sort_column)
    sort_order = to_string(sort_order)

    sort_column =
      if validate_sort_column(sort_column), do: sort_column, else: &quot;person_id&quot;

    sort_order = if validate_order(sort_order), do: sort_order, else: &quot;asc&quot;

    sql = &quot;&quot;&quot;
    SELECT i.person_id,
    COUNT(distinct i.id) AS &quot;num_items&quot;,
    COUNT(distinct t.id) AS &quot;num_timers&quot;,
    MIN(i.inserted_at) AS &quot;first_inserted_at&quot;,
    MAX(i.inserted_at) AS &quot;last_inserted_at&quot;,
    SUM(EXTRACT(EPOCH FROM (t.stop - t.start))) AS &quot;total_timers_in_seconds&quot;
    FROM items i
    LEFT JOIN timers t ON t.item_id = i.id
    GROUP BY i.person_id
    ORDER BY #{sort_column} #{sort_order}
    &quot;&quot;&quot;

  ...

  # validates the items columns to make sure it's a valid column passed
  defp validate_sort_column(column) do
    Enum.member?(
      ~w(person_id num_items num_timers first_inserted_at last_inserted_at total_timers_in_seconds),
      column
    )
  end

  # validates the order SQL to make sure it's a valid asc or desc
  defp validate_order(order) do
    Enum.member?(
      ~w(asc desc),
      order
    )
  end
end
</code></pre>
<p>In the <code>person_with_item_and_timer_count/2</code> function, two default parameters have been introduced: <code>sort_column</code> and <code>sort_order</code>. These parameters dictate which column the result should be sorted by and the direction of the sort, respectively.</p>
<p>The default values (<code>:person_id</code> for column and <code>:asc</code> for order) ensure that if no sorting criteria are provided when calling the function, it will default to sorting by <code>person_id</code> in ascending order.</p>
<p>To ensure that only valid column names and sorting orders are used in our SQL query (and to prevent potential SQL injection attacks), we need to validate these parameters:</p>
<pre><code class="language-elixir">sort_column = to_string(sort_column)
sort_order = to_string(sort_order)

sort_column =
  if validate_sort_column(sort_column), do: sort_column, else: &quot;person_id&quot;

sort_order = if validate_order(sort_order), do: sort_order, else: &quot;asc&quot;
</code></pre>
<p>Here, the <code>sort_column</code> and <code>sort_order</code> parameters are first converted to strings. Then, the <code>validate_sort_column/1</code> and <code>validate_order/1</code> private functions are used to check if the provided values are valid. If they aren't, defaults are set.</p>
<p>The SQL query has been modified to include an ORDER BY clause as well using string interpolation to insert the parameters on the query after validating them.</p>
<p>The private function <code>validate_sort_column/1</code> and <code>validate_order/1</code> are similar, since they ensure that the provided column/order is one of the valid ones in our stats.</p>
<p>The <code>~w(...)</code> is a word list in Elixir, which creates a list of strings. The <code>Enum.member?/2</code> function checks if the provided value exists in this list.</p>
<p>By introducing these changes, you've made the <code>person_with_item_and_timer_count/2</code> function more versatile, allowing it to retrieve sorted results based on provided criteria. Additionally, by validating the input parameters, you've added an essential layer of security to prevent potential misuse or attacks.</p>
<p>Let's include now the sorting mechanism inside the TableComponent.</p>
<p>For that, we will create two template files that will be used as SVG with an arrow poiting up and another pointing down to include these on our table header's.</p>
<p>Create the following two files.</p>
<p><code>lib/app_web/templates/table_component/arrow_down.html.heex</code></p>
<pre><code class="language-html">&lt;span
  class=&quot;ml-2 flex-none rounded bg-gray-100 text-gray-900 group-hover:bg-gray-200&quot;
  data-test-id=&quot;arrow_down&quot;
&gt;
  &lt;svg
    class=&quot;h-5 w-5&quot;
    viewBox=&quot;0 0 20 20&quot;
    fill=&quot;currentColor&quot;
    aria-hidden=&quot;true&quot;
  &gt;
    &lt;path
      fill-rule=&quot;evenodd&quot;
      d=&quot;M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z&quot;
      clip-rule=&quot;evenodd&quot;
    /&gt;
  &lt;/svg&gt;
&lt;/span&gt;
</code></pre>
<p><code>lib/app_web/templates/table_component/arrow_up.html.heex</code></p>
<pre><code class="language-html">&lt;%= if @invisible do %&gt;
  &lt;span
    class=&quot;invisible ml-2 flex-none rounded text-gray-400 group-hover:visible group-focus:visible&quot;
    data-test-id=&quot;invisible_arrow_up&quot;
  &gt;
    &lt;svg
      class=&quot;invisible ml-2 h-5 rotate-180 w-5 flex-none rounded text-gray-400 group-hover:visible group-focus:visible&quot;
      viewBox=&quot;0 0 20 20&quot;
      fill=&quot;currentColor&quot;
      aria-hidden=&quot;true&quot;
    &gt;
      &lt;path
        fill-rule=&quot;evenodd&quot;
        d=&quot;M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z&quot;
        clip-rule=&quot;evenodd&quot;
      /&gt;
    &lt;/svg&gt;
  &lt;/span&gt;
&lt;% else %&gt;
  &lt;span
    class=&quot;ml-2 flex-none rounded bg-gray-100 text-gray-900 group-hover:bg-gray-200&quot;
    data-test-id=&quot;arrow_up&quot;
  &gt;
    &lt;svg
      class=&quot;h-5 w-5 rotate-180&quot;
      viewBox=&quot;0 0 20 20&quot;
      fill=&quot;currentColor&quot;
      aria-hidden=&quot;true&quot;
    &gt;
      &lt;path
        fill-rule=&quot;evenodd&quot;
        d=&quot;M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z&quot;
        clip-rule=&quot;evenodd&quot;
      /&gt;
    &lt;/svg&gt;
  &lt;/span&gt;
&lt;% end %&gt;
</code></pre>
<p>These files are similar, the only difference is that the arrow_up will be invisible when there is no selection. We will create a method to deal with the show/hide of the arrows inside our <code>table_component_view.ex</code>.</p>
<p>Let's open this file and create the following methods:</p>
<pre><code class="language-elixir">defmodule AppWeb.TableComponentView do
  use AppWeb, :view

  def render_arrow_down() do
    Phoenix.View.render(AppWeb.TableComponentView, &quot;arrow_down.html&quot;, %{})
  end

  def render_arrow_up() do
    Phoenix.View.render(AppWeb.TableComponentView, &quot;arrow_up.html&quot;, %{
      invisible: false
    })
  end

  def render_arrow_up(:invisible) do
    Phoenix.View.render(AppWeb.TableComponentView, &quot;arrow_up.html&quot;, %{
      invisible: true
    })
  end
end
</code></pre>
<p>There are three methods added to render arrow icons:</p>
<ul>
<li><code>render_arrow_down/0</code>: Renders a downward-pointing arrow, used to indicate descending sort order.</li>
<li><code>render_arrow_up/0</code>: Renders an upward-pointing arrow, used to indicate ascending sort order. By default, this arrow is visible.</li>
<li><code>render_arrow_up/:invisible</code>: An overloaded version of the above method, which renders the upward-pointing arrow but marks it as invisible.</li>
</ul>
<p>The invisible attribute in the third method will be used as a conditional rendering in the <code>arrow_up.html</code> template to hide the arrow when invisible is set to <code>true</code>.</p>
<p>Let's update our <code>table_component.html.heex</code> template now, to include the arrows and the new Phoenix event that will be used to trigger the sorting mechanism.</p>
<p>Open the <code>table_component.html.heex</code> and make the following modifications:</p>
<pre><code class="language-html">&lt;table class=&quot;text-sm text-left text-gray-500 dark:text-gray-400 table-auto&quot;&gt;
  &lt;thead class=&quot;text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400&quot;&gt;
    &lt;%= for column &lt;- @column do %&gt;
      &lt;th
        scope=&quot;col&quot;
        class=&quot;px-6 py-3 text-center cursor-pointer&quot;
        phx-click=&quot;sort&quot;
        phx-value-key={column.key}
      &gt;
        &lt;a href=&quot;#&quot; class=&quot;group inline-flex&quot;&gt;
          &lt;%= column.label %&gt;

          &lt;%= if @sort_column == String.to_atom(column.key) do %&gt;
            &lt;%= if @sort_order == :asc do %&gt;
              &lt;%= render_arrow_up() %&gt;
            &lt;% else %&gt;
              &lt;%= render_arrow_down() %&gt;
            &lt;% end %&gt;
          &lt;% else %&gt;
            &lt;%= render_arrow_up(:invisible) %&gt;
          &lt;% end %&gt;
        &lt;/a&gt;
      &lt;/th&gt;
    &lt;% end %&gt;
  &lt;/thead&gt;
...
</code></pre>
<p>The <code>phx-click=&quot;sort&quot;</code> attribute indicates that when a user clicks a header, the sort event will be triggered in the LiveView. The <code>phx-value-key</code> sends the key of the column (like person_id, num_items, etc.) to the server as the value of the clicked item, that will be used for determining which column to sort by.</p>
<pre><code class="language-html">&lt;%= if @sort_column == String.to_atom(column.key) do %&gt;
  &lt;%= if @sort_order == :asc do %&gt;
    &lt;%= render_arrow_up() %&gt;
  &lt;% else %&gt;
    &lt;%= render_arrow_down() %&gt;
  &lt;% end %&gt;
&lt;% else %&gt;
  &lt;%= render_arrow_up(:invisible) %&gt;
&lt;% end %&gt;
</code></pre>
<p>This logic determines which arrow to display next to a column label:</p>
<ul>
<li>If the current sort column (<code>@sort_column</code>) matches the column's key, it means this column is the one currently being sorted.
<ul>
<li>Within this condition, if the sort order (<code>@sort_order</code>) is ascending (<code>:asc</code>), the upward-pointing arrow is displayed using the <code>render_arrow_up()</code> function.</li>
<li>If the sort order is not ascending, then the downward-pointing arrow is displayed using the <code>render_arrow_down()</code> function.</li>
</ul>
</li>
<li>If the current sort column does not match the column's key, an upward-pointing arrow in an invisible state is displayed using <code>render_arrow_up(:invisible)</code>. This gives a visual cue to the user that they can click to sort by this column.</li>
</ul>
<p>The additions to this file enhance the table by adding sortable column headers. When a user clicks on a column header, the table's content is re-ordered based on that column. The sort arrows provide a clear visual indication of the current sort column and its direction (ascending or descending).</p>
<p>Now, we just need to update our Stats LiveView to include this new variables and logic.</p>
<p>Open the <code>stats_live.ex</code> and update to the following code:</p>
<pre><code class="language-elixir">defmodule AppWeb.StatsLive do
...

  def mount(_params, _session, socket) do
    # subscribe to the channel
    if connected?(socket), do: AppWeb.Endpoint.subscribe(@stats_topic)

    person_id = get_person_id(socket.assigns)
    metrics = Item.person_with_item_and_timer_count()

    {:ok,
     assign(socket,
       person_id: person_id,
       metrics: metrics,
       sort_column: :person_id,
       sort_order: :asc
     )}
  end

...

  @impl true
  def handle_event(&quot;sort&quot;, %{&quot;key&quot; =&gt; key}, socket) do
    sort_column =
      key
      |&gt; String.to_atom()

    sort_order =
      if socket.assigns.sort_column == sort_column do
        toggle_sort_order(socket.assigns.sort_order)
      else
        :asc
      end

    metrics = Item.person_with_item_and_timer_count(sort_column, sort_order)

    {:noreply,
     assign(socket,
       metrics: metrics,
       sort_column: sort_column,
       sort_order: sort_order
     )}
  end

...

  defp toggle_sort_order(:asc), do: :desc
  defp toggle_sort_order(:desc), do: :asc
end
</code></pre>
<p>In the <code>mount/3</code> function, two new assigns are initialized: <code>sort_column</code> and <code>sort_order</code>.</p>
<pre><code class="language-elixir">sort_column: :person_id,
sort_order: :asc
</code></pre>
<ul>
<li><code>sort_column</code>: Represents the column on which the table is currently sorted. By default, it's set to <code>:person_id</code>.</li>
<li><code>sort_order</code>: Represents the order in which the table is currently sorted. By default, it's set to <code>:asc</code> (ascending).</li>
</ul>
<p>A new function, <code>handle_event/3</code>, has been added to handle the &quot;sort&quot; event, 
which is triggered when a user clicks on a table column header to sort by that column.</p>
<pre><code class="language-elixir">def handle_event(&quot;sort&quot;, %{&quot;key&quot; =&gt; key}, socket) do
</code></pre>
<p>This function takes in an event payload with a key (the column to sort by) and the current socket.</p>
<ul>
<li>The provided key is converted to an atom to get the <code>sort_column</code>.</li>
<li>The <code>sort_order</code> is determined using the <code>toggle_sort_order/1</code> function. If the clicked column (<code>sort_column</code>) 
is the same as the one currently being sorted, the sort order is toggled (from ascending to descending or vice versa). 
If it's a different column, the sort order is set to ascending by default.</li>
<li>With the determined <code>sort_column</code> and <code>sort_order</code>, 
the function fetches the sorted metrics using <code>Item.person_with_item_and_timer_count/2</code>.</li>
<li>Finally, the <code>socket</code> is updated with the new metrics and sorting parameters.</li>
</ul>
<p>A private helper function, <code>toggle_sort_order/1</code>, has been introduced to toggle the sorting order:</p>
<pre><code class="language-elixir">defp toggle_sort_order(:asc), do: :desc
defp toggle_sort_order(:desc), do: :asc
</code></pre>
<p>If the current order is ascending (<code>:asc</code>), it returns descending (<code>:desc</code>), and vice versa.</p>
<p>These modifications enhance the <code>AppWeb.StatsLive</code> module with dynamic sorting capabilities. 
Users can now click on table column headers to sort the table's content based on the chosen column, and the sort order will toggle between ascending and descending with each click.</p>
<p>Finally, we need to update our usage of the Table LiveComponent for the usage of these new sort variables.</p>
<p>Open the <code>stats_live.html.heex</code> file and make the following modifications:</p>
<pre><code class="language-html">...

   &lt;.live_component
      module={AppWeb.TableComponent}
      id=&quot;table_component&quot;
      rows={@metrics}
      sort_column={@sort_column}
      sort_order={@sort_order}
      highlight={&amp;is_highlighted_person?(&amp;1, @person_id)}
    &gt;
      &lt;:column :let={metric} label=&quot;Id&quot; key=&quot;person_id&quot;&gt;
        &lt;td class=&quot;px-6 py-4&quot; data-test-id=&quot;person_id&quot;&gt;
          &lt;a href={person_link(metric.person_id)}&gt;
            &lt;%= metric.person_id %&gt;
          &lt;/a&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column :let={metric} label=&quot;Items&quot; key=&quot;num_items&quot;&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;num_items&quot;&gt;
          &lt;%= metric.num_items %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

      &lt;:column :let={metric} label=&quot;Timers&quot; key=&quot;num_timers&quot;&gt;
        &lt;td class=&quot;px-6 py-4 text-center&quot; data-test-id=&quot;num_timers&quot;&gt;
          &lt;%= metric.num_timers %&gt;
        &lt;/td&gt;
      &lt;/:column&gt;

...
</code></pre>
<p>We are just passing the <code>sort_column</code> and <code>sort_order</code> to the live component to be used internally for the arrow logic.</p>
<blockquote>
<p>Remember the <code>key</code> attribute that we created before? It's used to determine which column was clicked and to trigger the sort event.</p>
</blockquote>
<p>With that, we finished all of our tasks! Yay! Let's run the application and see our results:</p>
<pre><code class="language-sh">mix s
</code></pre>
<p>Our final modification will be create tests for everything, let's update all tests to test the new features:</p>
<p><code>test/app/item_test.exs</code></p>
<pre><code class="language-elixir">...
  describe &quot;items&quot; do
    ...
    @another_person %{text: &quot;some text&quot;, person_id: 2, status: 2}
    ...

...

  test &quot;Item.person_with_item_and_timer_count/0 returns a list of count of timers and items for each given person&quot; do
    ...

    assert first_element.num_items == 2
    assert first_element.num_timers == 2

    assert NaiveDateTime.compare(
             first_element.first_inserted_at,
             item1.inserted_at
           ) == :eq

    assert NaiveDateTime.compare(
             first_element.last_inserted_at,
             item2.inserted_at
           ) == :eq
  end

  test &quot;Item.person_with_item_and_timer_count/1 returns a list sorted in ascending order&quot; do
    {:ok, %{model: _, version: _version}} = Item.create_item(@valid_attrs)
    {:ok, %{model: _, version: _version}} = Item.create_item(@valid_attrs)

    {:ok, %{model: _, version: _version}} = Item.create_item(@another_person)
    {:ok, %{model: _, version: _version}} = Item.create_item(@another_person)

    # list person with number of timers and items
    result = Item.person_with_item_and_timer_count(:person_id)

    assert length(result) == 2

    first_element = Enum.at(result, 0)
    assert first_element.person_id == 1
  end

  test &quot;Item.person_with_item_and_timer_count/1 returns a sorted list based on the column&quot; do
    {:ok, %{model: _, version: _version}} = Item.create_item(@valid_attrs)
    {:ok, %{model: _, version: _version}} = Item.create_item(@valid_attrs)

    {:ok, %{model: _, version: _version}} = Item.create_item(@another_person)
    {:ok, %{model: _, version: _version}} = Item.create_item(@another_person)

    # list person with number of timers and items
    result = Item.person_with_item_and_timer_count(:person_id, :desc)

    assert length(result) == 2

    first_element = Enum.at(result, 0)
    assert first_element.person_id == 2
  end

  test &quot;Item.person_with_item_and_timer_count/1 returns a sorted list by person_id if invalid sorted column and order&quot; do
    {:ok, %{model: _, version: _version}} = Item.create_item(@valid_attrs)
    {:ok, %{model: _, version: _version}} = Item.create_item(@valid_attrs)

    {:ok, %{model: _, version: _version}} = Item.create_item(@another_person)
    {:ok, %{model: _, version: _version}} = Item.create_item(@another_person)

    # list person with number of timers and items
    result =
      Item.person_with_item_and_timer_count(:invalid_column, :invalid_order)

    assert length(result) == 2

    first_element = Enum.at(result, 0)
    assert first_element.person_id == 1
  end
end
</code></pre>
<p><code>test/app_web/live/components/table_component_test.exs</code></p>
<pre><code class="language-elixir">defmodule AppWeb.TableComponentTest do
  use AppWeb.ConnCase, async: true
  alias AppWeb.TableComponent
  import Phoenix.LiveViewTest

  @column [
    %{label: &quot;Person Id&quot;, key: &quot;person_id&quot;},
    %{label: &quot;Num Items&quot;, key: &quot;num_items&quot;}
  ]

  test &quot;renders table correctly&quot; do
    component_rendered =
      render_component(TableComponent,
        column: @column,
        sort_column: :person_id,
        sort_order: :asc,
        rows: []
      )

    assert component_rendered =~ &quot;Person Id&quot;
    assert component_rendered =~ &quot;Num Items&quot;

    assert component_rendered =~ &quot;person_id&quot;
    assert component_rendered =~ &quot;num_items&quot;

    assert component_rendered =~ &quot;arrow_up&quot;
    assert component_rendered =~ &quot;invisible_arrow_up&quot;
  end

  test &quot;renders table correctly with desc arrow&quot; do
    component_rendered =
      render_component(TableComponent,
        column: @column,
        sort_column: :person_id,
        sort_order: :desc,
        rows: []
      )

    assert component_rendered =~ &quot;Person Id&quot;
    assert component_rendered =~ &quot;Num Items&quot;

    assert component_rendered =~ &quot;person_id&quot;
    assert component_rendered =~ &quot;num_items&quot;

    assert component_rendered =~ &quot;arrow_down&quot;
    assert component_rendered =~ &quot;invisible_arrow_up&quot;
  end
end
</code></pre>
<p><code>test/app_web/live/stats_live_test.exs</code></p>
<pre><code class="language-elixir">defmodule AppWeb.StatsLiveTest do
  alias App.DateTimeHelper
  
  ...

  test &quot;display metrics on mount&quot;, %{conn: conn} do
    ...
      # Creating one timer
    started = NaiveDateTime.utc_now()
    {:ok, timer} = Timer.start(%{item_id: item.id, start: started})
    {:ok, _} = Timer.stop(%{id: timer.id})

    ...

    # two items and one timer expected
    assert page_live |&gt; element(&quot;td[data-test-id=person_id]&quot;) |&gt; render() =~
             &quot;55&quot;

    assert page_live |&gt; element(&quot;td[data-test-id=num_items]&quot;) |&gt; render() =~ &quot;2&quot;

    assert page_live |&gt; element(&quot;td[data-test-id=num_timers]&quot;) |&gt; render() =~
             &quot;1&quot;

    assert page_live
           |&gt; element(&quot;td[data-test-id=first_inserted_at]&quot;)
           |&gt; render() =~
             DateTimeHelper.format_date(started)

    assert page_live
           |&gt; element(&quot;td[data-test-id=last_inserted_at]&quot;)
           |&gt; render() =~
             DateTimeHelper.format_date(started)

    assert page_live
           |&gt; element(&quot;td[data-test-id=total_timers_in_seconds]&quot;)
           |&gt; render() =~
             &quot;&quot;
  end

  test &quot;handle broadcast when item is created&quot;, %{conn: conn} do
    ...

    assert render(page_live) =~ &quot;Stats&quot;
    # num of items
    assert page_live |&gt; element(&quot;td[data-test-id=num_items]&quot;) |&gt; render() =~ &quot;1&quot;

    ...

    # num of items
    assert page_live |&gt; element(&quot;td[data-test-id=num_items]&quot;) |&gt; render() =~ &quot;2&quot;

    ...

    # num of items
    assert page_live |&gt; element(&quot;td[data-test-id=num_items]&quot;) |&gt; render() =~ &quot;2&quot;
  end

  test &quot;handle broadcast when timer is created&quot;, %{conn: conn} do
    ...

    assert render(page_live) =~ &quot;Stats&quot;
    # num of timers
    assert page_live |&gt; element(&quot;td[data-test-id=num_timers]&quot;) |&gt; render() =~
             &quot;0&quot;
    ...

    # num of timers
    assert page_live |&gt; element(&quot;td[data-test-id=num_timers]&quot;) |&gt; render() =~
             &quot;1&quot;

    ...

    # num of timers
    assert page_live |&gt; element(&quot;td[data-test-id=num_timers]&quot;) |&gt; render() =~
             &quot;1&quot;
  end

  ...

  test &quot;sorting column when clicked&quot;, %{conn: conn} do
    {:ok, %{model: _, version: _version}} =
      Item.create_item(%{text: &quot;Learn Elixir&quot;, status: 2, person_id: 1})

    {:ok, %{model: _, version: _version}} =
      Item.create_item(%{text: &quot;Learn Elixir&quot;, status: 4, person_id: 2})

    {:ok, page_live, _html} = live(conn, &quot;/stats&quot;)

    # sort first time
    result =
      page_live |&gt; element(&quot;th[phx-value-key=person_id]&quot;) |&gt; render_click()

    [first_element | _] = Floki.find(result, &quot;td[data-test-id=person_id]&quot;)

    assert first_element |&gt; Floki.text() =~ &quot;2&quot;

    # sort second time
    result =
      page_live |&gt; element(&quot;th[phx-value-key=person_id]&quot;) |&gt; render_click()

    [first_element | _] = Floki.find(result, &quot;td[data-test-id=person_id]&quot;)

    assert first_element |&gt; Floki.text() =~ &quot;1&quot;
  end
end
</code></pre>
<p>Let's run the tests:</p>
<pre><code class="language-sh">mix t
</code></pre>
<p>That's it! I'll let the tests file for you to explore and test different cases if you want.</p>
<p>Congratulations!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
