<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>dwyl book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        <script defer data-domain="dwyl.github.io" src="https://plausible.io/js/script.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        
        <!-- additional languages -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/elixir.min.js"></script>
        
        <script>hljs.highlightAll();</script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="auth/index.html"><strong aria-hidden="true">1.</strong> Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="auth/00-why.html"><strong aria-hidden="true">1.1.</strong> Why build Auth?</a></li><li class="chapter-item expanded "><a href="auth/01-what.html"><strong aria-hidden="true">1.2.</strong> What are we building?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="auth/02-database-schema-review.html"><strong aria-hidden="true">1.2.1.</strong> Quick Review of Old Database Schema</a></li></ol></li><li class="chapter-item expanded "><a href="auth/03-how.html"><strong aria-hidden="true">1.3.</strong> How?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="auth/04-prerequisites.html"><strong aria-hidden="true">1.3.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="auth/05-mix-phx-new.html"><strong aria-hidden="true">1.3.2.</strong> Create New Phoenix Project</a></li><li class="chapter-item expanded "><a href="auth/06-mix-gen-auth.html"><strong aria-hidden="true">1.3.3.</strong> Generate Auth Schema</a></li><li class="chapter-item expanded "><a href="auth/07-notes-on-naming.html"><strong aria-hidden="true">1.3.4.</strong> Notes on Naming</a></li><li class="chapter-item expanded "><a href="auth/08-modals-antipattern.html"><strong aria-hidden="true">1.3.5.</strong> Modals Are An Antipattern</a></li><li class="chapter-item expanded "><a href="auth/09-encrypt-data.html"><strong aria-hidden="true">1.3.6.</strong> Encrypt Personal Data</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="atm/index.html"><strong aria-hidden="true">2.</strong> ATM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="atm/01-browser-agent.html"><strong aria-hidden="true">2.1.</strong> Parse User Agent</a></li><li class="chapter-item expanded "><a href="atm/02-gen-schema-user_agents.html"><strong aria-hidden="true">2.2.</strong> User Agent Schema</a></li></ol></li><li class="chapter-item expanded "><a href="mvp/index.html"><strong aria-hidden="true">3.</strong> MVP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mvp/16-lists.html"><strong aria-hidden="true">3.1.</strong> Lists</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dwyl book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="intro"><a class="header" href="#intro">Intro</a></h1>
<p>Our aim with writing a book 
is to <strong><em>comprehensively</em> document</strong>
<strong><em>everything</em> we learned</strong> 
while building our 
<a href="https://github.com/dwyl/app"><strong><code>App</code></strong></a>
and 
<strong><code>API</code></strong>.</p>
<p>This is the 
<a href="https://en.wikipedia.org/wiki/Handbook"><strong>handbook</strong></a>
we <em>wish</em> we had 
when we started our journey.
Our goal is to have a book 
that <em>anyone</em> can use 
to learn <em>exactly</em> how we build/built
<em>every</em> aspect of our <code>App</code>. </p>
<p>We have already written over 
<strong>100 stand-alone tutorials</strong>
for various technologies/tools/frameworks.
See:
<a href="https://github.com/dwyl?q=learn">dwyl?q=<strong>learn</strong></a> <br />
The <em>advantage</em> of 
standalone/self-contained tutorials
is that they are <em>focussed</em> 
on one thing.
The disadvantage 
is that they lack clear progression.
So people can be left asking:
&quot;<strong>What <em>next</em></strong>?&quot;
By contrast the objective in the <code>book</code>
is to have a <strong><em>very</em> clear progression</strong>.</p>
<p>If you click the &quot;Print&quot; icon 
in the top-right of this screen: ↗️</p>
<img width="97" alt="image" src="https://user-images.githubusercontent.com/194400/219624215-3d780055-5151-4e2e-8632-893578c4412b.png">
<p>You can save a PDF copy of the book 
and read it <em><strong>offline</strong></em> in your own time
without any distractions.
Of if you have good internet,
you can follow along 
and <em>build</em> the <code>App</code> step-by-step.</p>
<p>One day, <em>all</em> software will be Open Source.
This is our small contribution to that end.</p>
<p>If you agree with the idea
that software should be Open to <em>anyone</em>,
please let us know! 🙏
&quot;Star&quot; the repo on <code>GitHub</code>
<a href="https://github.com/dwyl/book">dwyl/book</a> ⭐</p>
<p>With that out of the way,
let's get started learning by <em>doing</em>! 🚀</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auth"><a class="header" href="#auth"><code>auth</code></a></h1>
<p>We built a <strong><em>complete</em> cohesive <code>auth</code> system</strong> 
because <em>nothing</em> we found 
met our requirements
for simplicity, security and speed.</p>
<p><img src="https://user-images.githubusercontent.com/194400/218912832-e46b0206-8dbd-4589-8cbf-6a160610b580.png" alt="auth-flow" /></p>
<p>Read our reasoning
and journey in the next few pages.</p>
<p>At the very least you can 
see if you <em>agree</em> (or not)
with our approach.</p>
<p>As always,
your feedback is very much welcome. 🙏</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="why-custom-build-auth"><a class="header" href="#why-custom-build-auth">Why <em>Custom</em> Build Auth?</a></h1>
<p>After a couple of decades of writing code
and <em>studying</em> 30+ CMS/Frameworks 
&amp; Enterprise Auth providers
we concluded 
that all the Authentication/Authorization
systems are still <strong><em>way</em> too complex</strong>
and required <strong><em>far</em> too many steps</strong>.</p>
<p>Rather than lock ourselves into 
something complex and then 
be stuck with slow/no progress,
we decided to build something from scratch
that would allow us to <strong>move <em>much</em> faster</strong>
in the <em>long</em> run.</p>
<p>We have documented <em>all</em> the steps taken
in creating our <code>auth</code> system.
The code is well tested and maintained
so <em>anyone</em> can read how it all works.</p>
<h2 id="the-best-way-to-understand-something-is-to-build-it"><a class="header" href="#the-best-way-to-understand-something-is-to-build-it">The Best Way to <em>Understand</em> Something is to <em>Build</em> It!</a></h2>
<p>We <em>encourage</em> anyone interested
in <em>understanding</em> 
how things work behind the scenes
to read through the <code>auth</code> chapters.
We've attempted to include <em>all</em> the steps
we took so that anyone can grok it.</p>
<p>However we know this is not the most <em>exciting</em> 
part of the application stack. 
If you prefer to skip the <code>auth</code> section entirely,
you can just <em>use</em> it 
and treat it as a &quot;service&quot; that &quot;Just Works<sup>TM</sup>&quot;
and only refer to specific parts when needed.</p>
<h2 id="why-re-build-auth"><a class="header" href="#why-re-build-auth">Why <em>Re-build</em> <code>Auth</code>?</a></h2>
<p>We learned a <em>lot</em> from building our <code>first</code> version
of <code>auth</code> in <code>Elixir</code>.
Our &quot;Version 1&quot; has been working in production for several years
and thousands of people have used it successfully.
The UI/UX for the &quot;end-user&quot; is fine;
it's <em>fast</em> and already does what we need.
We aren't going to change what the <code>person</code> <em>using</em> <code>auth</code>
see very much in the next iteration.
What is <strong><em>not</em> fine</strong> is the <em>maintainability</em> 
and thus <em>extensibility</em> of the project.
We recently saw this when we tried 
to add a <code>new</code> feature to <code>auth</code>,
but we saw <code>Ecto</code> constraint errors.  </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-are-we-building"><a class="header" href="#what-are-we-building">What Are We Building?</a></h1>
<p>We are building a <strong><em>complete</em> authentication system</strong> 
that <em>anyone</em> can use
to protect the personal data 
of the <code>people</code> using an <code>App</code>.</p>
<p>While we are starting from scratch 
with zero code,
we aren't working in a vacuum 
or blinkered/blindfolded.
We have build <code>auth</code>
before in <code>PHP</code>, <code>Python</code>
<a href="https://github.com/dwyl/hapi-auth-jwt2"><code>JavaScript/TypeScript</code></a>
and most recently 
<code>Elixir</code>
and have <em>used</em>
and <em>studied</em>
several <code>auth</code> systems.
This is an 
<a href="https://en.wiktionary.org/wiki/otaku">otaku</a>
for us;
an obsession
not just a side-project.
If you feel that the <code>UI/UX</code> 
of authentication is one 
of the most important aspects
of building any App,
please read on. </p>
<h2 id="starting-point"><a class="header" href="#starting-point">Starting Point?</a></h2>
<p>As noted above,
we are starting from scratch
so there is zero &quot;baggage&quot; or &quot;legacy&quot;,
but we are <em>informed</em> by our previous iterations of <code>auth</code>. </p>
<p>Let's start by picking holes in our previous design.</p>
<blockquote>
<p><strong>Note</strong>: the objective of analysing our <em>own</em> code/design
is not &quot;criticism&quot;,
it's <em>reflection</em>, <em>learning</em> and <em>continuous improvement</em>. </p>
</blockquote>
<h3 id="old-databse-entity-relational-diagram-erd"><a class="header" href="#old-databse-entity-relational-diagram-erd"><em>Old</em> Databse Entity Relational Diagram (ERD)</a></h3>
<p>This is the ERD of the <em>old</em> version of <code>auth</code>:</p>
<img width="1177" alt="image" src="https://user-images.githubusercontent.com/194400/218709796-0ef83fd1-7e20-4c95-8817-76598ca0f1f7.png">
<p>If this diagram looks &quot;complicated&quot; to you right now,
don't worry, we <em>agree</em>! 
We're only sharing it here as a <em>reference</em>.
It is not the &quot;goal&quot; to recreate this.
Rather, our objective is to <em>simplify</em> it
and remove any tables that we don't <em>need</em>.
For example: 
we will remove the 
<code>tags</code>, <code>status</code>, <code>roles</code>
tables from the database
and instead define these exclusively in code.
The reasoning is simple:
this data does not change very often.
So having it in <code>Postgres</code> and forcing
a join for every query that requires the data
is immensely resource-wasteful.</p>
<p>Yes, the database purists would say:
&quot;all data should be in the database&quot;.
And &quot;old us&quot; would <em>agree</em> with that
<a href="https://en.wikipedia.org/wiki/Dogma">dogma</a>.
But what we've discovered in <em>practice</em>,
is that we can define <em>metadata</em>
in code and <em>significantly</em> 
improve both reasoning about the entity relationships
and query performance.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database-schema-review"><a class="header" href="#database-schema-review">Database Schema Review</a></h1>
<p>If you prefer to start with a blank slate,
feel free to skip this page.</p>
<p>Final snapshot of diagram: </p>
<img width="1163" alt="image" src="https://user-images.githubusercontent.com/194400/218710979-1331f056-01db-40dc-8b31-fad0d47565fa.png">
<p>Without much knowledge of database schemas, 
if you just pay <em>close</em> attention, 
you'll see that that the <strong><code>person_id</code></strong> relationship  (<strong><code>foreign key</code></strong>)
is not correctly defined on 3 tables: <strong><code>apikeys</code></strong>, <strong><code>apps</code></strong> and <strong><code>roles</code></strong>.</p>
<p><img width="1176" alt="auth-erd-person_id-fk-incomplete" 
  src="https://user-images.githubusercontent.com/194400/218711765-51d6c582-7465-444f-8c75-bcbe3f03c13d.png"></p>
<p>This has caused me/us no end of pain while trying to add new features ... 
<a href="https://github.com/dwyl/auth/pull/231#issuecomment-1345762532">auth/pull/231</a></p>
<p>So, in <em>addition</em> to <em>dramatically</em> simplifying the database schema, 
I will make sure that all the <code>Ecto</code> relationships are well-defined 
so that we don't run into annoying constraint errors in the future.</p>
<p>If we <em>start</em> by deleting the tables that we don't <em>need</em>, we <em>immediately</em> simplify the ERD:</p>
<p><img width="1285" alt="image" 
  src="https://user-images.githubusercontent.com/194400/218715031-91969a04-4f56-4da3-bf25-d3ae2945f25d.png"></p>
<p>If we manually edit the diagram to include the <code>person_id</code> links (foreign keys): </p>
<p><img width="1274" alt="auth-erd-tables-removed-person_id-edited" 
  src="https://user-images.githubusercontent.com/194400/218716741-ae49971f-98b5-46b8-9493-fcd8a815f6cd.png"></p>
<p>It becomes clearer what data &quot;belongs&quot; to a <code>person</code>. 
But we can immediately spot something that incomplete/incorrect:
<em><strong>who</strong></em> does a <code>group</code> &quot;belong&quot; to? 🤷‍♂️ </p>
<p>Obviously it's &quot;unfair&quot; to pick holes in a feature that is incomplete.
But it's &quot;broken&quot; and we (I) need to learn from it. 💭 </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-build-auth-from-first-principals"><a class="header" href="#how-to-build-auth-from-first-principals">How To Build <code>Auth</code> From First Principals</a></h1>
<p>For the past 2 iterations,
we have use the <code>Phoenix</code> Web Application framework
to build our <code>Auth</code> system.
The reasons for this choice
are outlined in:
<a href="https://github.com/dwyl/technology-stack#phoenix">dwyl/<strong>technology-stack</strong>#<strong>phoenix</strong></a>
so won't be repeat it here.
<code>Phoenix</code> is a &quot;batteries included&quot; framework
that includes <em>many</em> features out-of-the-box.</p>
<p>Our <strong><code>Auth</code> system</strong> is a <strong>standalone <code>Phoenix</code> instance</strong>
that has its' own <strong><em>separate</em> database</strong>.
This is a very <em>deliberate</em> choice.
We want to enforce a <em>complete</em> 
<a href="https://en.wikipedia.org/wiki/Separation_of_concerns"><strong>separation of concerns</strong></a>
between <code>Auth</code> 
and the <code>App</code> that <em>uses</em> <code>Auth</code>.</p>
<p>@TODO: insert diagram illustrating relationship between <code>Auth</code> and <code>App</code>.</p>
<p>Beyond the security benefits 
of separating <code>Auth</code> 
the practical rationale is simple:
the code for building an <code>Auth</code> system 
is 
<a href="https://en.wiktionary.org/wiki/KLOC#Noun"><code>~3kloc</code></a>
see: 
<a href="https://en.wikipedia.org/wiki/Source_lines_of_code">wikipedia.org/Source_lines_of_code</a>
If we include all the <code>Auth</code> code in our main <code>App</code>
it adds to the <strong>complexity</strong> of the <code>App</code>
and thus increase the time 
it takes someone to
<a href="https://en.wikipedia.org/wiki/Grok">grok</a>.
The longer it takes people to <em>understand</em> the <code>App</code> code 
the less likely they are to <em>contribute</em> to the <code>App</code>.</p>
<blockquote>
<p><strong>Note</strong>: we are <em>not</em> suggesting 
that people should not <em>also</em> 
<code>try</code> to understand what <code>Auth</code> is doing. 
On the contrary we want as many people as possible 
to understand all aspects of our stack.
However we acknowledge that <code>Auth</code>
and &quot;People Management&quot; 
is not the most <em>interesting</em> part of the stack.
It's akin to the &quot;plumbing&quot; in your home.
Absolutely necessary 
and needs to function <em>flawlessly</em>.
But not something you <em>actively</em> think about
unless there's something that isn't working as expected ... </p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<p>Before you start building <code>auth</code>,
ensure that you have the following on your computer:</p>
<h2 id="latest-elixir"><a class="header" href="#latest-elixir">Latest <code>Elixir</code></a></h2>
<p>In your terminal,
run the following command:</p>
<pre><code class="language-sh">elixir -v
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">Erlang/OTP 25 [erts-13.1.4] [64-bit] [smp:10:10] [async-threads:1] [jit] [dtrace]

Elixir 1.14.3 (compiled with Erlang/OTP 25)
</code></pre>
<p>This is the latest and greatest version 
of <code>Elixir</code> and <code>OTP</code>
at the time of writing. 
<a href="https://github.com/elixir-lang/elixir/tags">github.com/elixir-lang/elixir/tags</a></p>
<blockquote>
<p><strong>Note</strong>: if you have a <em>later</em> version,
please consider creating a <code>Pull Request</code> 
to update this section of the book.</p>
</blockquote>
<h2 id="latest-phoenix"><a class="header" href="#latest-phoenix"><em>Latest</em> <code>Phoenix</code></a></h2>
<p>Visit: 
<a href="https://github.com/phoenixframework/phoenix/tags">github.com/phoenixframework/phoenix/tags</a>
to remind yourself 
of what the most recent version of <code>Phoenix</code> is.
I our case, <a href="https://phoenixframework.org/blog/phoenix-1.7-final-released"><code>v1.7.0</code></a>,
so that's what we are using.</p>
<p>Confirm that you have the latest version of <code>Phoenix</code>
by running the command:</p>
<pre><code class="language-sh">mix phx.new -v
</code></pre>
<p>You should see something similar to:</p>
<pre><code class="language-sh">Phoenix installer v1.7.0
</code></pre>
<blockquote>
<p><strong>Note</strong>: if the version of <code>Phoenix</code> you are using
is more recent than this, 
please help us to update our docs:</p>
</blockquote>
<p>If you don't already have 
the latest version of <code>Phoenix</code>,
run the command: </p>
<pre><code class="language-sh">mix archive.install hex phx_new
</code></pre>
<h2 id="postgresql-server"><a class="header" href="#postgresql-server"><code>PostgreSQL</code> Server</a></h2>
<p><em>Confirm</em> <strong>PostgreSQL</strong> is running 
(<em>so data can be stored</em>)
run the following command:</p>
<pre><code class="language-sh">lsof -i :5432
</code></pre>
<p>You should see output <em>similar</em> to the following:</p>
<pre><code class="language-sh">COMMAND  PID  USER   FD  TYPE DEVICE                  SIZE/OFF NODE NAME
postgres 529 Nelson  5u  IPv6 0xbc5d729e529f062b      0t0  TCP localhost:postgresql (LISTEN)
postgres 529 Nelson  6u  IPv4 0xbc5d729e55a89a13      0t0  TCP localhost:postgresql (LISTEN)
</code></pre>
<p>This tells us that PostgreSQL is &quot;<em>listening</em>&quot; on TCP Port <code>5432</code>
(<em>the default port</em>)</p>
<p>If the <code>lsof</code> command does not yield any result
in your terminal,
run:</p>
<pre><code class="language-sh">pg_isready
</code></pre>
<p>It should print the following:</p>
<pre><code class="language-sh">/tmp:5432 - accepting connections
</code></pre>
<p>With all those 
<a href="https://en.wikipedia.org/wiki/Preflight_checklist">&quot;pre-flight checks&quot;</a> 
performed, let's <em>fly</em>! 🚀</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-the-new-auth-phoenix-project"><a class="header" href="#create-the-new-auth-phoenix-project">Create The New <code>Auth</code> Phoenix Project</a></h1>
<p>In an empty working directory,
using the 
<a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.New.html"><code>mix phx.new</code></a>
generator,
create a new <code>Phoenix</code> project
called &quot;auth&quot;:</p>
<pre><code class="language-sh">mix phx.new auth
</code></pre>
<p>That will create a bunch of files.
Most of them are &quot;boilerplate&quot; code 
for configuring the <code>Phoenix</code> project
and a load of <code>components</code>.
We will use some of them and <code>delete</code>
the rest. </p>
<h2 id="run-the-phoenix-app"><a class="header" href="#run-the-phoenix-app">Run the <code>Phoenix</code> App</a></h2>
<p>Once the dependencies are installed,
run the following command in your terminal: </p>
<pre><code class="language-sh">mix setup
</code></pre>
<p>Once everything is setup,
run the <code>Phoenix</code> app 
with the command:</p>
<pre><code class="language-sh">mix phx.server
</code></pre>
<p>Open your web browser to: 
<code>http://localhost:4000</code></p>
<p>You should see something similar to the following: </p>
<p><img src="https://user-images.githubusercontent.com/194400/221915847-cfd297f0-52ab-46f2-8e0a-bd58abad971a.png" alt="default-phoenix-homepage" /></p>
<h2 id="run-the-tests"><a class="header" href="#run-the-tests">Run the Tests</a></h2>
<p>Just to confirm everything is working,
run the tests with the following command:</p>
<pre><code class="language-sh">mix test
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">Compiling 4 files (.ex)
Generated auth app
.....
Finished in 0.1 seconds (0.05s async, 0.05s sync)
5 tests, 0 failures

Randomized with seed 50114
</code></pre>
<p>With that out of the way,
let's build!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generate-auth-files"><a class="header" href="#generate-auth-files">Generate Auth Files</a></h1>
<p>In <code>auth v1</code> the 
<a href="https://github.com/phoenixframework/phoenix/blob/v1.7.1/guides/authentication/mix_phx_gen_auth.md#L1"><code>mix phx.gen.auth</code></a> 
generator 
<a href="https://github.com/dwyl/auth/issues/207">didn't exist</a>
so we had to hand-write all the code. 
For <code>auth v2</code><br />
we are using the <code>phx.gen.auth</code> &quot;generator&quot; 
to provide some of the scaffolding
and session management.
see:
<a href="https://hexdocs.pm/phoenix/mix_phx_gen_auth.html">hexdocs.pm/phoenix/mix_phx_gen_auth</a></p>
<p>In your terminal, run th following command: </p>
<pre><code class="language-sh">mix phx.gen.auth Accounts Person people
</code></pre>
<p>The generator prompts with the following question:</p>
<pre><code class="language-sh">An authentication system can be created in two different ways:
- Using Phoenix.LiveView (default)
- Using Phoenix.Controller only
Do you want to create a LiveView based authentication system? [Yn]
</code></pre>
<p>We answered <code>N</code> (No) 
because we will be adding more advanced <code>auth</code> </p>
<pre><code class="language-sh">* creating priv/repo/migrations/20230226095715_create_people_auth_tables.exs
* creating lib/auth/accounts/person_notifier.ex
* creating lib/auth/accounts/person.ex
* creating lib/auth/accounts/person_token.ex
* creating lib/auth_web/person_auth.ex
* creating test/auth_web/person_auth_test.exs
* creating lib/auth_web/controllers/person_session_controller.ex
* creating test/auth_web/controllers/person_session_controller_test.exs
* creating lib/auth_web/controllers/person_confirmation_html.ex
* creating lib/auth_web/controllers/person_confirmation_html/new.html.heex
* creating lib/auth_web/controllers/person_confirmation_html/edit.html.heex
* creating lib/auth_web/controllers/person_confirmation_controller.ex
* creating test/auth_web/controllers/person_confirmation_controller_test.exs
* creating lib/auth_web/controllers/person_registration_html/new.html.heex
* creating lib/auth_web/controllers/person_registration_controller.ex
* creating test/auth_web/controllers/person_registration_controller_test.exs
* creating lib/auth_web/controllers/person_registration_html.ex
* creating lib/auth_web/controllers/person_reset_password_html.ex
* creating lib/auth_web/controllers/person_reset_password_controller.ex
* creating test/auth_web/controllers/person_reset_password_controller_test.exs
* creating lib/auth_web/controllers/person_reset_password_html/edit.html.heex
* creating lib/auth_web/controllers/person_reset_password_html/new.html.heex
* creating lib/auth_web/controllers/person_session_html.ex
* creating lib/auth_web/controllers/person_session_html/new.html.heex
* creating lib/auth_web/controllers/person_settings_html.ex
* creating lib/auth_web/controllers/person_settings_controller.ex
* creating lib/auth_web/controllers/person_settings_html/edit.html.heex
* creating test/auth_web/controllers/person_settings_controller_test.exs
* creating lib/auth/accounts.ex
* injecting lib/auth/accounts.ex
* creating test/auth/accounts_test.exs
* injecting test/auth/accounts_test.exs
* creating test/support/fixtures/accounts_fixtures.ex
* injecting test/support/fixtures/accounts_fixtures.ex
* injecting test/support/conn_case.ex
* injecting config/test.exs
* injecting mix.exs
* injecting lib/auth_web/router.ex
* injecting lib/auth_web/router.ex - imports
* injecting lib/auth_web/router.ex - plug
* injecting lib/auth_web/components/layouts/root.html.heex

Please re-fetch your dependencies with the following command:

    $ mix deps.get

Remember to update your repository by running migrations:

    $ mix ecto.migrate

Once you are ready, visit &quot;/people/register&quot;
to create your account and then access &quot;/dev/mailbox&quot; to
see the account confirmation email.
</code></pre>
<p>That's a <em>lot</em> of code. 
See the <code>git</code> commit:
<a href="https://github.com/dwyl/auth/commit/90086a83c6968573f7d4c72b3882a247ac30112d"><code>90086a8</code></a>.
We will use the session management 
in our <code>auth</code> system
and <code>delete</code> some of the unused code along the way. </p>
<h2 id="migrate-the-schema"><a class="header" href="#migrate-the-schema">Migrate the Schema</a></h2>
<p>When you run:</p>
<pre><code class="language-sh">mix ecto.migrate
</code></pre>
<p>You will see the following output:</p>
<pre><code class="language-sh">Generated auth app

15:04:11.168 [info] == Running 20230226095715 Auth.Repo.Migrations.CreatePeopleAuthTables.change/0 forward

15:04:11.173 [info] execute &quot;CREATE EXTENSION IF NOT EXISTS citext&quot;

15:04:11.285 [info] create table people

15:04:11.296 [info] create index people_email_index

15:04:11.297 [info] create table people_tokens

15:04:11.302 [info] create index people_tokens_person_id_index

15:04:11.307 [info] create index people_tokens_context_token_index

15:04:11.310 [info] == Migrated 20230226095715 in 0.1s
</code></pre>
<h2 id="schema"><a class="header" href="#schema">Schema</a></h2>
<p>Let's take a quick look
at the created database tables.</p>
<p>If you open the <code>auth_dev</code> 
database in your Postgres GUI,
e.g:
<a href="https://github.com/dwyl/learn-postgresql/issues/43"><code>DBEaver</code></a> <br />
and view the 
<a href="https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model">ERD</a>
there are only two tables:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223881258-be77ebdc-0114-4606-aac1-065f172b6727.png" alt="mix-phx-gen-auth-erd" /></p>
<h3 id="data-in-people-and-people_tokens-tables"><a class="header" href="#data-in-people-and-people_tokens-tables">Data in <code>people</code> and <code>people_tokens</code> tables</a></h3>
<p>By default,
<code>mix phx.gen.auth</code> 
does not setup any <em>protection</em> 
for personal data in the database.
Email addresses are stored in-the-clear: 🙄 </p>
<p><img src="https://user-images.githubusercontent.com/194400/223880353-98597d83-cb9c-424d-bcb0-2121ecd743c0.png" alt="mix-phx-gen-auth-people-table-email-plaintext" /></p>
<p>Similarly the <code>people_tokens</code> table stores <code>email</code> addresses as <strong><code>plaintext</code></strong> in the <code>sent_to</code> column:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223948397-6984b456-8612-492b-bb79-84442c8b4241.png" alt="people_token-email-plaintext" /></p>
<p>This is <strong><em>obviously</em> undesirable</strong>. 🙃 
This is a privacy/security issue
waiting to become a scandal!
We will address this <em>swiftly</em>
in the following pages.</p>
<p>But first, tests!</p>
<h2 id="run-the-tests-1"><a class="header" href="#run-the-tests-1">Run The Tests</a></h2>
<p>Sadly, the <code>phx.gen.auth</code> 
there to be a bunch of routes 
hard-coded with the &quot;/user&quot; prefix in the tests
e.g: 
<a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/test/auth_web/controllers/person_session_controller_test.exs#L15"><code>test/auth_web/controllers/person_session_controller_test.exs#L15</code></a></p>
<p>The generator doesn't respect 
the fact that we call them <strong><code>people</code></strong>
when we invoked the command above. 
so if you run the tests:</p>
<pre><code class="language-sh">mix test
</code></pre>
<p>You will see several warnings:</p>
<pre><code class="language-sh">.warning: no route path for AuthWeb.Router matches &quot;/users/log_out&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:40: AuthWeb.PersonRegistrationControllerTest.&quot;test POST /people/register creates account and logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/log_out&quot;
  test/auth_web/controllers/person_session_controller_test.exs:40: AuthWeb.PersonSessionControllerTest.&quot;test POST /people/log_in logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/settings&quot;
  test/auth_web/controllers/person_session_controller_test.exs:39: AuthWeb.PersonSessionControllerTest.&quot;test POST /people/log_in logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/settings&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:39: AuthWeb.PersonRegistrationControllerTest.&quot;test POST /people/register creates account and logs the person in&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/register&quot;
  test/auth_web/controllers/person_session_controller_test.exs:15: AuthWeb.PersonSessionControllerTest.&quot;test GET /people/log_in renders log in page&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/register&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:12: AuthWeb.PersonRegistrationControllerTest.&quot;test GET /people/register renders registration page&quot;/1

warning: no route path for AuthWeb.Router matches &quot;/users/log_in&quot;
  test/auth_web/controllers/person_registration_controller_test.exs:11: AuthWeb.PersonRegistrationControllerTest.&quot;test GET /people/register renders registration page&quot;/1
</code></pre>
<p>And ultimately the tests fail: </p>
<pre><code class="language-sh">...............................................................................
Finished in 0.6 seconds (0.4s async, 0.2s sync)
115 tests, 5 failures
</code></pre>
<p>This should be a easy to fix.</p>
<p>Perform a find-and-replace for &quot;/users/&quot; to &quot;/people/&quot;</p>
<p><img src="https://user-images.githubusercontent.com/194400/223720287-98435204-8189-4baf-ab7b-a2a3f506b6dd.png" alt="replace-users-with-people" /></p>
<p>Attempt to re-run the tests:</p>
<pre><code class="language-sh">mix test
</code></pre>
<p>Sadly, 4 tests still fail:</p>
<pre><code class="language-sh">  1) test POST /people/register creates account and logs the person in (AuthWeb.PersonRegistrationControllerTest)
     test/auth_web/controllers/person_registration_controller_test.exs:24
     Assertion with =~ failed
     code:  assert response =~ email
     left:  &quot;&lt;!DOCTYPE html&gt;\n&lt;html lang=\&quot;en\&quot; style=\&quot;scrollbar-gutter: stable;\&quot;&gt;\n  &lt;head&gt;\n etc.

etc.

.......................................................................
Finished in 0.5 seconds (0.4s async, 0.1s sync)
115 tests, 4 failures
</code></pre>
<p>We're going to have to investigate/update these tests <em>manually</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notes-on-naming-conventions"><a class="header" href="#notes-on-naming-conventions">Notes on Naming Conventions</a></h1>
<p>The words we use matter.
To some people they matter <em>more</em> 
than the <em>message</em> we are trying to convey.
For some, if you speak or write
a word that offends them (or <em>anyone</em> else),
what you have to say is no longer relevant.</p>
<p>There are <em>many</em> words we avoid using
in polite company such as 
<a href="https://en.wikipedia.org/wiki/Profanity">profanity</a>
and others we attempt to eliminate completely such as 
<a href="https://en.wikipedia.org/wiki/Pejorative">pejorative</a> terms
or 
<a href="https://en.wikipedia.org/wiki/List_of_ethnic_slurs">ethnic slurs</a>.</p>
<h2 id="user---person"><a class="header" href="#user---person"><del>User</del> -&gt; <code>Person</code></a></h2>
<p>The word &quot;<strong>user</strong>&quot; is pervasive in computing:</p>
<blockquote>
<p>&quot;<em>A <strong><code>user</code></strong> is a <strong><code>person</code></strong> 
who utilizes a computer or network service.</em>&quot;
~ https://en.wikipedia.org/wiki/User_(computing)#Terminology</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/194400/223142338-11395ebc-2506-4114-895e-2051dcf8031f.png" alt="wikipedia-user-computer" /></p>
<p>Right there in the <em>definition</em>
they clarify that a &quot;user&quot; is a &quot;person&quot; ...
so why not just call them a <code>person</code>? </p>
<p>The fact that the term &quot;<strong>user</strong>&quot; is widely used
doesn't make it <em>right</em>; 
it's just the <code>default</code> word
many people have become accustomed to.</p>
<p>Mega tech companies like Apple, Microsoft, Google and Facebook
regularly use the word &quot;user&quot; or &quot;users&quot;
to describe the <strong><code>people</code></strong> that use their products and services.</p>
<h2 id="personalization"><a class="header" href="#personalization">Personalization?</a></h2>
<p>Consider the word <strong><code>personalization</code></strong>.
&quot;<em><strong>Personalization</strong> consists of tailoring 
a service or a product 
to accommodate specific individuals, 
sometimes tied to groups or segments of individuals</em>.&quot;
~ <a href="https://en.wikipedia.org/wiki/Personalization">wikipedia.org/wiki/Personalization</a></p>
<p>The word isn't &quot;userization&quot;,
because the interface for the &quot;user&quot; is always the same; generic.
Whereas the interface that is personalized 
to an individual person is <em>just</em> for them.</p>
<p>We will be doing a <em>lot</em> of <strong><code>personalization</code></strong>
in our <code>App</code>
and building tools that allow <code>people</code>
to personalize their <em>own</em> experience. </p>
<h2 id="complete-clarity"><a class="header" href="#complete-clarity">Complete Clarity</a></h2>
<p>We avoid using the word &quot;<em><strong>user</strong></em>&quot;
in the <code>auth</code> system and our <code>App</code>
because we consider it reductive
and distances the <code>people</code> creating the <code>code</code>
from the <code>people</code> <em>using</em> the product.</p>
<p>Instead we refer to <code>people</code> using the <code>App</code>
as <code>people</code> because it helps us 
to <em>think</em> of them as <strong><em>real</em> <code>people</code></strong>.</p>
<p>We cannot <em>force</em> anyone <code>else</code>
to stop using the word &quot;user&quot;.
It will still be the <code>default</code> for many companies.
Especially the company who 
treat their &quot;users&quot; as the <code>product</code>.</p>
<h2 id="the-product-facebook-sells-is-you"><a class="header" href="#the-product-facebook-sells-is-you">The Product <code>Facebook</code> Sells is <em>You</em></a></h2>
<p><a href="https://slate.com/technology/2018/04/are-you-really-facebooks-product-the-history-of-a-dangerous-idea.html"><img src="https://user-images.githubusercontent.com/194400/223942613-bbc5ea60-2ff4-4751-9dad-11e151ca5248.png" alt="facebook-users-for-sale" /></a></p>
<blockquote>
<p>&quot;<em>You may think Facebook is the product 
and you’re the client, 
but that’s not entirely true. 
There’s a reason tech companies 
call us <strong>users</strong> and not customers. 
It’s because we’re just people 
who come and use the interface. 
The <strong>product</strong> <code>Facebook</code> sells is <strong><code>you</code></strong>. 
The advertisers are the customers. 
That goes for all tech companies 
that make most of their money from ads.</em>&quot;
~ <a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-1461358970">Ben Wolford</a></p>
</blockquote>
<h2 id="daus-maus"><a class="header" href="#daus-maus"><code>DAUs</code>, <code>MAUs</code></a></h2>
<p><a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-406784935"><code>Facebook</code></a>
will continue referring to <code>people</code> as &quot;users&quot;
and more specifically 
&quot;<a href="https://en.wikipedia.org/wiki/Active_users"><strong>DAUs</strong></a>&quot; 
(<em>Daily</em> Active Users)
and 
&quot;<a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-1458429682"><strong>MAUs</strong></a>&quot;
(<em>Monthly</em> Active Users).
They don't <em>want</em> to think about the 
<code>people</code> whose lives they are 
<a href="https://github.com/dwyl/home/issues/29">wasting</a>
and in many cases
<a href="https://github.com/dwyl/learn-react/issues/23#issuecomment-1350769626">destroying</a>.</p>
<p>We want to do the <em>exact</em> opposite 
of <code>Facebook</code> with our <code>App</code>;
we want to <strong>help <code>people</code> <em>save</em> time</strong>!
So we are using the word &quot;people&quot;
and avoiding &quot;users&quot; wherever we can.</p>
<h2 id="not-just-facebook"><a class="header" href="#not-just-facebook">Not Just <code>Facebook</code></a></h2>
<p>Facebook is just the most obvious
and <em>egregious</em> example.
All the top tech companies
harvest your personal data 
and sell it to advertisers.
<a href="https://www.wired.co.uk/article/apple-is-an-ad-company-now"><code>Apple</code></a>, 
<a href="https://www.ben-evans.com/benedictevans/2023/3/6/ways-to-think-about-amazon-advertising"><code>Amazon</code></a>, 
<a href="https://www.reuters.com/business/media-telecom/disney-secures-9-billion-upfront-ad-sales-2022-07-18/"><code>Disney</code></a>,
<a href="https://www.statista.com/statistics/266249/advertising-revenue-of-google/"><code>Google</code></a>, 
<a href="https://en.wikipedia.org/wiki/Microsoft_Advertising"><code>Microsoft</code></a>, 
<a href="https://www.statista.com/statistics/1361989/netflix-ad-revenue"><code>NetFlix</code></a>,
<a href="https://www.businessofapps.com/data/twitter-statistics/"><code>Twitter</code></a>,
<a href="https://www.reuters.com/technology/uber-looks-boost-digital-ad-revenue-with-new-advertising-division-2022-10-19/"><code>Uber</code></a> 
are all in the <code>advertising</code> business
whether you realize it or not.
They are all &quot;attention merchants&quot;.</p>
<blockquote>
<p>&quot;<em>Simply put, the U-words have their origin in a more sanguine, naïve era. 
As terms, I find them unethical and outdated, 
and so I have doubts they can usher in 
the kind of improvements to technology we desperately need.</em>&quot;
~ <a href="https://medium.com/s/user-friendly/why-im-done-saying-user-user-experience-and-ux-in-2019-4fdfc6b7de23">Adam Lefton</a></p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/194400/223168289-b44149c8-56da-4348-8561-4f9904007f72.png" alt="iamnotauser" /></p>
<h2 id="recommended-reading"><a class="header" href="#recommended-reading">Recommended Reading</a></h2>
<ul>
<li>Words Matter. Talk About People: 
Not Customers, Not Consumers, Not Users:
<a href="https://jnd.org/words_matter_talk_about_people_not_customers_not_consumers_not_users">jnd.org/words_matter_talk_about_people_not_customers_not_consumers_not_users</a></li>
<li>Refuse to Call People ‘Users’:
<a href="https://medium.com/s/user-friendly/why-im-done-saying-user-user-experience-and-ux-in-2019-4fdfc6b7de23">medium.com/s/user-friendly/why-im-done-saying-user-user-experience-and-ux-in-2019-4fdfc6b7de23</a></li>
<li>Is Your Life Really Yours? 
How ‘The Attention Merchants’ Got Inside Our Heads:
<a href="https://bigthink.com/high-culture/tim-wu-on-the-attention-merchants-2/">bigthink.com/high-culture/tim-wu-on-the-attention-merchants-2</a></li>
<li>The words you choose within your app 
are an essential part of its experience:
<a href="https://developer.apple.com/design/human-interface-guidelines/foundations/writing">developer.apple.com/design/human-interface-guidelines/foundations/writing</a></li>
</ul>
<blockquote>
<p><strong>Note</strong>: <strong><code>Apple**</code></strong> while a proponent
of carefully selecting words,
often refer to the <code>people</code> 
that buy and use 
their products and services
as &quot;users&quot;. 
This is a legacy of their <em>age</em> as a company -
they have been around since 
<a href="https://en.wikipedia.org/wiki/Apple_Inc">1976</a> -
and their <em>scale</em>;
they have more than 
<a href="https://www.macrumors.com/2023/02/02/apple-two-billion-active-devices"><strong>2 billion active devices</strong></a>.
At that scale it's about numbers and &quot;users&quot;
not individual <code>people</code>. 
There are many great <code>people</code> at <code>Apple</code>
who understand that words matter. 
If the company was started today perhaps
they would think twice about the &quot;users&quot; word.
But sadly, even Apple are now in the advertising
business:
<a href="https://www.wired.co.uk/article/apple-is-an-ad-company-now">wired.co.uk/article/apple-is-an-ad-company-now</a>
So they aren't likely to update 
the word they use to describe us.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modals-are-an-experience-antipattern"><a class="header" href="#modals-are-an-experience-antipattern">Modals Are An Experience <em>Antipattern</em></a></h1>
<p>&quot;<em>An <strong>antipattern</strong> is just like a pattern, except that instead of a solution it gives something that looks superficially like a solution, but <strong>isn't one</strong>.</em>&quot;
~ Linda Rising - The Patterns Handbook
<a href="https://en.wikipedia.org/wiki/Anti-pattern#:~:text=An%20antipattern%20is%20just%20like,%2C%20but%20isn&#x27;t%20one.">wikipedia.org/wiki/Anti-pattern</a></p>
<p>9 times out of 10 
when designers/egineers 
employ a <code>modal</code> in an App.
they are doing so inappropriately
and inadvertently making 
the experience/interface <em>worse</em>
for the <code>person</code>.</p>
<p>If you are unfamiliar with them,
a good place to learn is:
<a href="https://getbootstrap.com/docs/4.0/components/modal/">bootstrap.com/modal</a></p>
<p><img src="https://user-images.githubusercontent.com/194400/224336299-9d22426a-5efd-4cb4-8ee5-9d565f9f5a9c.png" alt="bootstrap-modal" /></p>
<p>A <code>modal</code> overlays information 
on top of what is already displayed on the page.
It hijacks the person's focus 
to what the dev wants them to see
and requires the person
to <em>manually</em> dismiss it 
before being <em>allowed</em> to resume what they were doing.
This is an unwelcome interruption
to the flow and a generally <strong><em>horrible</em> experience</strong>.</p>
<p><code>Modals</code> are a relic of the old web
where ads hijacked people's screens with pop-ups:</p>
<p><img src="https://user-images.githubusercontent.com/194400/224343020-c1e0fc9c-7850-44e9-8df7-c5a5bdff8bfc.jpg" alt="pop-up-ads-90s" /></p>
<p>See:
<a href="https://en.wikipedia.org/wiki/Pop-up_ad">wikipedia.org/Pop-up_ad</a></p>
<p>The situation got completely out-of-hand
and made browsing the web a <em>horrible</em> experience.
All modern browsers block pop-ups by default now
but designers/devs who don't respect 
the <code>people</code> using their site/app
still reach for <code>modals</code> for hijacking attention.</p>
<p><img src="https://user-images.githubusercontent.com/194400/208245674-cabc63f7-3975-4590-bc0d-b80e8823e200.png" alt="modal-ad" /></p>
<p>Modals are almost <em>never</em>
a good way of displaying information.</p>
<h2 id="modals-in-phoenix"><a class="header" href="#modals-in-phoenix">Modals in <code>Phoenix</code>?</a></h2>
<p><code>Phoenix 1.7</code> added the new 
<a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/lib/auth_web/components/core_components.ex#L48"><code>modal</code></a> 
component.</p>
<p>We <em>really wish</em> the creators of <code>Phoenix</code> 
had not done it
because it will <em>inevitably</em> be misused.
Naive devs who mean well 
but haven't studied UX,
will use a <code>modal</code>
when a basic <code>&lt;div&gt;</code>
would be considerably better.</p>
<p>It is used by <code>default</code> for inserting new content:</p>
<p><img src="https://user-images.githubusercontent.com/194400/199604980-3a7d8c6a-82e3-488b-aebf-e3c6c28d9e1d.png" alt="phoenix-modal-new-item" /></p>
<p>This is a <em>horrible</em> experience.
The <code>New Item</code> <code>modal</code> overlays the <code>Listing Items</code> page
instead of just showing a <code>New Item</code> <em>page</em>. 
This adds absolutely no value to the <code>person</code>
inputing the <code>item</code>; 
it's just a distraction.
This shows that the devs building
<code>Phoenix</code> have not done very much UX/Usability testing
because this would <em>immediately</em> confuse
an older less tech-savvy person.
They would ask is this page &quot;Listing Items&quot;
or is it allowing me to create a &quot;New Item&quot;?
And if they accidentally clicked/tapped
on the &quot;X&quot; they would lose the text they inputted.
Horrible.</p>
<h2 id="quick-example"><a class="header" href="#quick-example">Quick Example</a></h2>
<p>After executing the <code>mix phx.gen.auth</code> command
and then running the project with:</p>
<pre><code class="language-sh">mix phx.server
</code></pre>
<p>The following 2 links 
are added to the header 
of home page: 
<img width="1159" alt="phoenix-homepage-with-register-login-links" src="https://user-images.githubusercontent.com/194400/223761934-73e848c8-4ccd-44b3-ae8c-9376cd10fafb.png"></p>
<p>The code that creates these links is: <a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/lib/auth_web/components/layouts/root.html.heex#L15-L55"><code>/lib/auth_web/components/layouts/root.html.heex#L15-L55</code></a></p>
<p>Clicking on the <code>register</code> link we navigate to: http://localhost:4000/people/register
<img width="771" alt="image" src="https://user-images.githubusercontent.com/194400/223764612-8cdae223-49f3-43ae-9e24-c22a4e2caada.png"></p>
<p>Here we can enter an <code>Email</code> and <code>Password</code> to and click on the <code>Create an account</code> button:
<img width="771" alt="phoenix-auth-register-account" src="https://user-images.githubusercontent.com/194400/223766668-b0dcab60-be53-480e-9e4d-d1795ae57bdb.png"></p>
<p>This redirects us back to the homepage <code>http://localhost:4000/</code> and we see the following <code>modal</code>:
<img width="801" alt="phoenix-auth-register-success-modal" src="https://user-images.githubusercontent.com/194400/223767398-b1ac4510-a941-4d23-a748-1da6946cdd41.png"></p>
<p>The person viewing this screen 
has to <em>manually</em> dismiss
the <code>modal</code> in order to see 
the content that is <em>relevant</em> to them: </p>
<p><img src="https://user-images.githubusercontent.com/194400/223803237-55458f41-1456-4981-b531-3fdafb6b74ba.png" alt="phoenix-auth-email-in-header" /></p>
<p>Inspecting the <code>DOM</code> of the page in our browser:
<img width="1297" alt="image" src="https://user-images.githubusercontent.com/194400/223771234-b839c8fe-feb9-481c-ba66-40dabba374fc.png"></p>
<p>We see that the <code>&lt;div id=&quot;flash&quot;</code> 
has the following <code>HTML</code>: </p>
<pre><code class="language-html">&lt;div id=&quot;flash&quot; phx-mounted=&quot;[[&amp;quot;show&amp;quot;,{&amp;quot;display&amp;quot;:null,&amp;quot;time&amp;quot;:200,&amp;quot;to&amp;quot;:&amp;quot;#flash&amp;quot;,&amp;quot;transition&amp;quot;:[[&amp;quot;transition-all&amp;quot;,&amp;quot;transform&amp;quot;,&amp;quot;ease-out&amp;quot;,&amp;quot;duration-300&amp;quot;],[&amp;quot;opacity-0&amp;quot;,&amp;quot;translate-y-4&amp;quot;,&amp;quot;sm:translate-y-0&amp;quot;,&amp;quot;sm:scale-95&amp;quot;],[&amp;quot;opacity-100&amp;quot;,&amp;quot;translate-y-0&amp;quot;,&amp;quot;sm:scale-100&amp;quot;]]}]]&quot; phx-click=&quot;[[&amp;quot;push&amp;quot;,{&amp;quot;event&amp;quot;:&amp;quot;lv:clear-flash&amp;quot;,&amp;quot;value&amp;quot;:{&amp;quot;key&amp;quot;:&amp;quot;info&amp;quot;}}],[&amp;quot;hide&amp;quot;,{&amp;quot;time&amp;quot;:200,&amp;quot;to&amp;quot;:&amp;quot;#flash&amp;quot;,&amp;quot;transition&amp;quot;:[[&amp;quot;transition-all&amp;quot;,&amp;quot;transform&amp;quot;,&amp;quot;ease-in&amp;quot;,&amp;quot;duration-200&amp;quot;],[&amp;quot;opacity-100&amp;quot;,&amp;quot;translate-y-0&amp;quot;,&amp;quot;sm:scale-100&amp;quot;],[&amp;quot;opacity-0&amp;quot;,&amp;quot;translate-y-4&amp;quot;,&amp;quot;sm:translate-y-0&amp;quot;,&amp;quot;sm:scale-95&amp;quot;]]}]]&quot; role=&quot;alert&quot; class=&quot;fixed hidden top-2 right-2 w-80 sm:w-96 z-50 rounded-lg p-3 shadow-md shadow-zinc-900/5 ring-1 bg-emerald-50 text-emerald-800 ring-emerald-500 fill-cyan-900&quot; style=&quot;display: block;&quot;&gt;
  &lt;p class=&quot;flex items-center gap-1.5 text-[0.8125rem] font-semibold leading-6&quot;&gt;
    &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; aria-hidden=&quot;true&quot; class=&quot;h-4 w-4&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&gt;
        &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z&quot; clip-rule=&quot;evenodd&quot;&gt;&lt;/path&gt;
    &lt;/svg&gt;
    Success!
  &lt;/p&gt;
  &lt;p class=&quot;mt-2 text-[0.8125rem] leading-5&quot;&gt;Person created successfully.&lt;/p&gt;
  &lt;button type=&quot;button&quot; class=&quot;group absolute top-2 right-1 p-2&quot; aria-label=&quot;close&quot;&gt;
    &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; aria-hidden=&quot;true&quot; class=&quot;h-5 w-5 stroke-current opacity-40 group-hover:opacity-70&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&gt;
        &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z&quot; clip-rule=&quot;evenodd&quot;&gt;&lt;/path&gt;
    &lt;/svg&gt;
  &lt;/button&gt;
&lt;/div&gt;
</code></pre>
<p>This is a <em>lot</em> of code 
just to inform the <code>person</code>
that the successfully registered.</p>
<p>We <em>know</em> there's a <em>much</em> better way.
We will be <em>demonstrating</em> it 
in the next few pages.</p>
<p>For now, we're just going to 
remove the line:</p>
<pre><code class="language-html">&lt;.flash_group flash={@flash} /&gt;
</code></pre>
<p>From the file:
<a href="https://github.com/dwyl/auth/blob/90086a83c6968573f7d4c72b3882a247ac30112d/lib/auth_web/components/layouts/app.html.heex#L40"><code>/lib/auth_web/components/layouts/app.html.heex#L40</code></a></p>
<p>To remove all <code>flash</code> modals.</p>
<p>And just like magic,
the tests that were failing previously,
because the <code>modal</code> (noise)
was covering the <code>email</code> address,
now pass: </p>
<pre><code class="language-sh">mix test 

Compiling 2 files (.ex)
The database for Auth.Repo has already been created

19:08:47.892 [info] Migrations already up
..........................................................
.........................................................
Finished in 0.5 seconds (0.3s async, 0.1s sync)
115 tests, 0 failures
</code></pre>
<p>With all tests passing,
we can <em>finally</em> get on 
with building <code>Auth</code>! </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="encrypt-personal-data"><a class="header" href="#encrypt-personal-data">Encrypt Personal Data</a></h1>
<p>As previously noted
the schema created by the 
<code>phx.gen.auth</code> generator
leaves <strong><code>email</code></strong> addresses stored 
as 
<a href="https://en.wikipedia.org/wiki/Plaintext"><strong><code>plaintext</code></strong></a>:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223880353-98597d83-cb9c-424d-bcb0-2121ecd743c0.png" alt="mix-phx-gen-auth-people-table-email-plaintext" /></p>
<p>It's disappointing to us 
that this is the <code>default</code>
and many devs
will <em>naively</em> think this is &quot;OK&quot;.</p>
<h2 id="its-never-ok-to-store-personal-data-as-plaintext"><a class="header" href="#its-never-ok-to-store-personal-data-as-plaintext">It's <em>Never</em> &quot;OK&quot; to Store Personal Data as <code>plaintext</code></a></h2>
<p>It might be <em>tempting</em> 
to store personal data as 
human-readable text
during development
to make it easier to debug,
but we urge <em>everyone</em>
to resist this temptation!
<a href="https://en.wikipedia.org/wiki/Data_breach">Data breaches</a>
happen <em>every</em> day.
Breaches can <em>destroy</em> the reputation
of a company.
Thankfully,
the EU now has stronger laws
in the form of the
<a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">General Data Protection Regulation</a>
(GDPR),
which carry heavy fines
for companies
that improperly store personal data.</p>
<p>Most software engineers don't consider
the law(s) around data protection
but none of us have <em>any</em> excuse 
to ignore them even in basic projects.
The good news is:
protecting personal data
is quite straightforward.</p>
<h2 id="why-encrypt-now"><a class="header" href="#why-encrypt-now">Why Encrypt <em>Now</em>?</a></h2>
<p>We <em>know</em> this might feel like a deeply technical
step to have so early on in 
the creation of the <code>auth</code> App.
Why don't we just <em>skip</em> this 
and focus on the interface <code>people</code> will <em>see</em>?
We feel that getting the data privacy/security
right from the <em>start</em>
is essential for building a robust
and therefore trustworthy app. 
We will get to the interface design 
in the next chapter
so if you prefer that part,
feel free to speed-read/run this
and only return to it when you 
need a deeper understanding.</p>
<h2 id="how-to-encrypt-sensitive-data"><a class="header" href="#how-to-encrypt-sensitive-data">How To Encrypt Sensitive Data?</a></h2>
<p>When we first started using <code>Elixir</code> in 2016
we explored the topic of 
encrypting personal data in <em>depth</em>
and wrote a comprehensive guide:
<a href="https://github.com/dwyl/phoenix-ecto-encryption-example"><code>dwyl/phoenix-ecto-encryption-example</code></a>
We <em>highly</em> recommend following step-by-step guide
to understand this in detail.
We aren't going to duplicate/repeat 
any of the <em>theory</em> here. 
Rather we are going to focus on 
the <em>practice</em> using
the 
<a href="https://github.com/dwyl/fields"><code>fields</code></a>
package we created
to implement transparent encryption.</p>
<h2 id="using-fields-to-automatically-encrypt-personal-data"><a class="header" href="#using-fields-to-automatically-encrypt-personal-data">Using <code>Fields</code> to <em>Automatically</em> Encrypt Personal Data</a></h2>
<p>Following the instructions in the 
<a href="https://github.com/dwyl/fields"><code>fields</code></a>
repo, open the <code>mix.exs</code> file
and locate the <code>defp deps do</code> section
and add <code>fields</code> to the list:</p>
<pre><code class="language-elixir">{:fields, &quot;~&gt; 2.10.3&quot;},
</code></pre>
<p>Save the <code>mix.exs</code> file and run:</p>
<pre><code class="language-sh">mix deps.get
</code></pre>
<h3 id="create-environment-variables"><a class="header" href="#create-environment-variables">Create Environment Variables</a></h3>
<p><code>fields</code> expects an `environment variable</p>
<p>e.g. using the <a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Secret.html"><code>phx.gen.secret</code></a> command:</p>
<pre><code class="language-sh">mix phx.gen.secret
</code></pre>
<p>You should see output similar to:</p>
<pre><code class="language-sh">XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
</code></pre>
<p>Export this key in your terminal with the following command:</p>
<pre><code class="language-sh">export ENCRYPTION_KEYS=XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
</code></pre>
<p>Run the <code>phx.gen.secret</code> command again 
and export it as <code>SECRET_KEY_BASE</code>, e.g:</p>
<pre><code class="language-sh">export SECRET_KEY_BASE=GLH2S6EU0eZt+GSEmb5wEtonWO847hsQ9fck0APr4VgXEdp9EKfni2WO61z0DMOF
</code></pre>
<p>We use an <code>.env</code> file on <code>localhost</code>:</p>
<pre><code class="language-sh">export ENCRYPTION_KEYS=XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
export SECRET_KEY_BASE=GLH2S6EU0eZt+GSEmb5wEtonWO847hsQ9fck0APr4VgXEdp9EKfni2WO61z0DMOF
</code></pre>
<p>See:
<a href="https://github.com/dwyl/auth/blob/main/.env_sample"><code>.env_sample</code></a> 
for a sample including 
all the recommended/required environment variables
for running the <code>auth</code> app.</p>
<p>Now to the <em>interesting</em> part!</p>
<h2 id="update-peopleemail-data-type"><a class="header" href="#update-peopleemail-data-type">Update <code>people.email</code> Data Type</a></h2>
<p>The <code>phx.gen.auth</code> generator
created the <code>people</code> schema
with the <code>:email</code> field defined as a <code>:string</code>:</p>
<pre><code class="language-sh">field :email, :string
</code></pre>
<p>See: 
<a href="https://github.com/dwyl/auth/blob/da0af7ee702c278714b47f92045edce4adad542a/lib/auth/accounts/person.ex#L6"><code>lib/auth/accounts/person.ex#L6</code></a></p>
<h3 id="create-migration-file"><a class="header" href="#create-migration-file">Create Migration File</a></h3>
<p>Using <a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html#module-creating-your-first-migration"><code>Ecto.Migration</code></a>
run the following command 
to create a migration file 
with a descriptive name:</p>
<pre><code class="language-sh">mix ecto.gen.migration modify_people_email_string_binary
</code></pre>
<p>You should see output similar to:</p>
<pre><code class="language-sh">* creating priv/repo/migrations/20230309145958_modify_people_email_string_binary.exs
</code></pre>
<p>Open the file in your editor. You should see:</p>
<pre><code class="language-elixir">defmodule Auth.Repo.Migrations.ModifyPeopleEmailStringBinary do
  use Ecto.Migration

  def change do

  end
end
</code></pre>
<p>Update it to include the <code>alter</code> statement:</p>
<pre><code class="language-elixir">defmodule Auth.Repo.Migrations.ModifyPeopleEmailStringBinary do
  use Ecto.Migration

  def change do
    alter table(:people) do
      remove :email
      add :email, :binary
      add ...
    end

    alter table(:people_tokens) do
      remove :sent_to
      add :sent_to, :binary
    end
  end
end
</code></pre>
<blockquote>
<p><strong>Note</strong>: we tried using 
<a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html#modify/3"><code>Ecto.Migration.modify/3</code></a>
to modify the field type
but got the error:</p>
</blockquote>
<pre><code class="language-sh">15:06:13.691 [info] alter table people
** (Postgrex.Error) ERROR 42804 (datatype_mismatch) column &quot;email&quot; cannot be cast automatically to type bytea

    hint: You might need to specify &quot;USING email::bytea&quot;.
</code></pre>
<p>Given that this is a new project 
and there is no data in the DB,
we decided it was easier 
to remove and re-add the <code>email</code> column/field.</p>
<p>Save the migration file and run:</p>
<pre><code class="language-sh">mix ecto.reset
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">15:13:29.989 [info] == Migrated 20230226095715 in 0.0s

15:13:30.057 [info] == Running 20230309145958 Auth.Repo.Migrations.ModifyPeopleEmailStringBinary.change/0 forward

15:13:30.058 [info] alter table people

15:13:30.059 [info] alter table people_tokens

15:13:30.059 [info] == Migrated 20230309145958 in 0.0s
</code></pre>
<p>### Update <code>person.email</code></p>
<p>Open 
<code>lib/auth/accounts/person.ex</code>
and replace the line:</p>
<pre><code class="language-elixir">field :email, :string
</code></pre>
<p>With:</p>
<pre><code class="language-elixir">field :email, Fields.EmailEncrypted
field :email_hash, Fields.EmailHash
</code></pre>
<p>Sadly, this <em>essential</em> privacy/security enhancement 
was not quite as straightforward as we had hoped 
and had quite a few ramifications.
The boilerplate code 
generated by <code>phx.gen.auth</code>
was relying on <code>person.email</code> being <code>plaintext</code>
so we ended up having to make several changes.</p>
<p>Rather than repeating all of these here
which will take up a <em>lot</em> of space
and duplicate the code unessessarily,
we recommend you read through the git commit:
<a href="https://github.com/dwyl/auth/pull/231/commits/2bbba99c7057f0d2943dd8327be52ccf1a1bd58c"><code>#2bbba99</code></a></p>
<p>In a follow-up section 
we will be removing most of this code
because we don't <em>want</em> to
use links in emails to verify <code>people</code>.
Instead we will be using one-time-numeric codes.</p>
<p>Following the changes made in: 
<a href="https://github.com/dwyl/auth/pull/231/commits/2bbba99c7057f0d2943dd8327be52ccf1a1bd58c"><code>#2bbba99</code></a></p>
<p>If we now run a query to view the data in the <code>people</code> table:</p>
<pre><code class="language-sql">SELECT id, email, inserted_at FROM people;
</code></pre>
<p>We see that the <code>email</code> is now a binary blob, 
i.e: <em>encrypted</em>:</p>
<img width="1096" alt="image" src="https://user-images.githubusercontent.com/194400/224109679-0084ae9d-a1e8-48f2-a083-94aff46d7137.png">
<p>This cannot be read by anyone 
who does not have the encryption key.
So if the database is somehow compromised,
it's <em>useless</em> to the attacker. </p>
<p>Registration and Login still works as expected:</p>
<img width="1159" alt="image" src="https://user-images.githubusercontent.com/194400/224111036-7a4e5764-8966-4b97-aaea-515c8e3b7fd4.png">
<p>But now the personal data 
captured in registration is stored 
<strong><code>encrypted</code></strong> at rest 
the way it should be. 🔐 </p>
<p>Now we can get on with <em>building</em> <code>auth</code>!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-build-an-metrics-dashboard"><a class="header" href="#how-to-build-an-metrics-dashboard">How to Build an Metrics Dashboard</a></h1>
<pre><code class="language-sh">mix phx.new atm --no-mailer
</code></pre>
<p>We won't send <code>email</code> from this app.
But we want everything <code>else</code> 
<code>Phoenix</code> has to offer. 🚀</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parse-and-store-browser-user-agent-string"><a class="header" href="#parse-and-store-browser-user-agent-string">Parse and Store Browser User Agent String</a></h1>
<p>The <em>first</em> data we want to parse and store 
is the Web Browser 
<a href="https://en.wikipedia.org/wiki/User_agent">User Agent</a>
so that we know what devices and browsers are visiting.</p>
<p>There is a lot of info about User Agents on <strong>MDN</strong>:
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent">developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent</a>
recommended reading for the curious.</p>
<p>For our purposes 
we only need to extract the <code>user_agent</code> data that interest us
and thankfully, 
<a href="https://github.com/mneudert"><code>@mneudert</code></a>
has created a handy library we can use:
<a href="https://github.com/elixir-inspector/ua_inspector"><strong><code>ua_inspector</code></strong></a></p>
<h2 id="ua_inspector-usage-example"><a class="header" href="#ua_inspector-usage-example"><code>ua_inspector</code> Usage Example</a></h2>
<p>From the <code>ua_inspector</code> docs we get the following sample code/output:</p>
<pre><code class="language-elixir">iex&gt; UAInspector.parse(&quot;Mozilla/5.0 (iPad; CPU OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&quot;)
%UAInspector.Result{
  client: %UAInspector.Result.Client{
    engine: &quot;WebKit&quot;,
    engine_version: &quot;537.51.1&quot;,
    name: &quot;Mobile Safari&quot;,
    type: &quot;browser&quot;,
    version: &quot;7.0&quot;
  },
  device: %UAInspector.Result.Device{
    brand: &quot;Apple&quot;,
    model: &quot;iPad&quot;,
    type: &quot;tablet&quot;
  },
  os: %UAInspector.Result.OS{
    name: &quot;iOS&quot;,
    platform: :unknown,
    version: &quot;7.0.4&quot;
  },
  user_agent: &quot;Mozilla/5.0 (iPad; CPU OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&quot;
}
</code></pre>
<p>Additionally there is following sample output for a non-browser agent (<code>Google Bot</code>):</p>
<pre><code class="language-elixir">iex&gt; UAInspector.parse(&quot;Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Safari/537.36&quot;)
%UAInspector.Result.Bot{
  category: &quot;Search bot&quot;,
  name: &quot;Googlebot&quot;,
  producer: %UAInspector.Result.BotProducer{
    name: &quot;Google Inc.&quot;,
    url: &quot;http://www.google.com&quot;
  },
  url: &quot;http://www.google.com/bot.html&quot;,
  user_agent: &quot;Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Safari/537.36&quot;
}
</code></pre>
<p>From this sample output 
we can extract the following fields:</p>
<ul>
<li><code>engine</code>: <code>String</code> e.g: &quot;WebKit&quot;</li>
<li><code>engine_version</code>: <code>String</code> e.g: &quot;537.51.1&quot; - sadly we can't store this as <code>float</code> unless we lose the last digit ...</li>
<li><code>name</code>: <code>String</code> e.g: &quot;Mobile Safari&quot;</li>
<li><code>version</code>: <code>Float</code> e.g: &quot;7.0&quot; - we will <em>parse</em> this <code>float</code> so that we can run queries on it.</li>
<li><code>brand</code>: <code>String</code> e.g: &quot;Apple&quot;</li>
<li><code>model</code>: <code>String</code> e.g: &quot;iPad&quot;</li>
<li><code>device_type</code>: <code>String</code> e.g: &quot;tablet&quot;</li>
<li><code>os_name</code>: <code>String</code> e.g: &quot;iOS&quot;</li>
<li><code>platform</code>: <code>String</code> e.g: &quot;unknown&quot; - <code>Atom.to_string(:unknown)</code></li>
<li><code>os_version</code>: <code>String</code> e.g: &quot;7.0.4&quot;</li>
<li><code>url</code>: <code>String</code> e.g: &quot;http://www.google.com/bot.html&quot; - used by non-human agents; blank if null.</li>
<li><code>user_agent</code>: <code>String</code>, the <em>full</em> agent string.
Even though <code>ua_inspector</code> does a good job of parsing the <code>user_agent</code>,
we are storing the <em>full</em> <code>user_agent</code> string 
so that we can sense-check the parsed data when needed.</li>
</ul>
<p>Fields we will ignore:</p>
<ul>
<li><code>type</code>: <code>String</code> e.g: &quot;browser&quot; - we will skip this field as it's implied. </li>
<li></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="minimum-viable-product-mvp"><a class="header" href="#minimum-viable-product-mvp">Minimum Viable Product (MVP)</a></h1>
<p><em>All</em> Apps start with an MVP. 
In our case we created a <em>separate</em> repository:
<a href="https://github.com/dwyl/mvp">github.com/dwyl/<strong>mvp</strong></a>
so that the most <em>basic</em> version of our <code>App</code> 
could be used as a reference by other people building MVPs.</p>
<h1 id="todo"><a class="header" href="#todo">TODO:</a></h1>
<p>Lift the contents of 
<a href="https://github.com/dwyl/mvp/blob/7c0a29cfe71582a9aada531af339afdd2734b809/BUILDIT.md?plain=1">github.com/dwyl/mvp/BUILDIT.md</a>
and split it into separate files here in <code>book</code>.
See: 
<a href="https://github.com/dwyl/mvp/issues/350">dwyl/mvp/<strong>issues/350</strong></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lists"><a class="header" href="#lists">Lists</a></h1>
<p>Our <strong>MVP App</strong> already has 
much of the basic functionality we need/want 
but is sorely lacking 
a way to <strong><em>organize</em> <code>items</code></strong> 
into distinct projects/areas.
Let's fix that by introducing <code>lists</code>!</p>
<h2 id="quick-recap"><a class="header" href="#quick-recap">Quick Recap</a></h2>
<p>Up till this point we've <em>deliberately</em> kept the <code>MVP</code>
as lean as possible to avoid complexity. <br />
The 
<a href="https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model">Entity Relationship Diagram</a>
(ERD) is currently:</p>
<p><img src="https://user-images.githubusercontent.com/194400/233317695-3e036f1f-db13-4697-aa49-fe767a86a773.png" alt="mvp-erd-before-lists" /></p>
<p>Just the four tables
you've already seen 
in the previous sections.</p>
<p>Our reasons for adding <code>lists</code> <em>now</em> are: <br /></p>
<p><strong>a)</strong> Separate <code>lists</code> 
for different areas of life/work 
have been on our 
<a href="https://github.com/dwyl/product-roadmap">product roadmap</a> for a while ... <br />
<em>specifically</em>:
<a href="https://github.com/dwyl/app/issues/271">dwyl/app#<strong>271</strong></a>
<br /></p>
<p><strong>b)</strong> We want to use <code>lists</code> 
as the basis for organizing 
and 
<a href="https://github.com/dwyl/mvp/issues/145"><strong>re-ordering <code>items</code></strong></a>. <br /></p>
<p><strong>c)</strong> <code>lists</code> will unlock other functionality we have planned
that will make the <code>App</code> more <em>useful</em> both to individuals and teams.</p>
<h2 id="create-lists-and-list_items-schemas"><a class="header" href="#create-lists-and-list_items-schemas">Create <code>lists</code> and <code>list_items</code> Schemas</a></h2>
<p>Create the <code>lists</code> and <code>list_items</code> tables
with the following 
<a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Schema.html"><code>mix phx.gen.schema</code></a>
commands:</p>
<pre><code class="language-sh">mix phx.gen.schema List lists person_id:integer status:integer text:string
mix phx.gen.schema ListItems list_items item_id:references:items list_id:references:lists person_id:integer position:float
</code></pre>
<p>Those two commands will create the following migrations:</p>
<p><a href="https://github.com/dwyl/mvp/blob/fa0b79eebbe582e3b24213a2c657d0fc343782c9/priv/repo/migrations/20230416001029_create_lists.exs"><code>20230416001029_create_lists.exs</code></a></p>
<pre><code class="language-elixir">defmodule App.Repo.Migrations.CreateLists do
  use Ecto.Migration

  def change do
    create table(:lists) do
      add :text, :string
      add :person_id, :integer
      add :status, :integer

      timestamps()
    end
  end
end
</code></pre>
<p><a href="https://github.com/dwyl/mvp/blob/54aff67d172ad372c5ee1ffd9c41f24b093b78d4/priv/repo/migrations/20230416001045_create_list_items.exs"><code>20230416001045_create_list_items.exs</code></a></p>
<pre><code class="language-elixir">defmodule App.Repo.Migrations.CreateListItems do
  use Ecto.Migration

  def change do
    create table(:list_items) do
      add :person_id, :integer
      add :position, :float
      add :item_id, references(:items, on_delete: :nothing)
      add :list_id, references(:lists, on_delete: :nothing)

      timestamps()
    end

    create index(:list_items, [:item_id])
    create index(:list_items, [:list_id])
  end
end
</code></pre>
<p>The Database tables these migrations create 
are very simple.</p>
<p>Once we run <code>mix ecto.migrate</code>,
we have the following database
ERD:</p>
<p><img src="https://user-images.githubusercontent.com/194400/233316755-96fb001d-ac16-4cad-99b0-b562c0128c1f.png" alt="mvp-erd-with-lists-and-list_items" /></p>
<p>These two new database tables
are everything we need 
to build the <code>lists</code> features. 🎉</p>
<p>## Create Tests (TDD)</p>
<p>The <code>gen.schema</code> command only creates the migration files
and the corresponding schema files in the 
<a href="https://github.com/dwyl/mvp/tree/main/lib/app"><code>lib/app</code></a> 
directory of our <code>Phoenix App</code>.
It does not create any <code>CRUD</code> functions or tests.
This is fine because <em>most</em> of what we need is bespoke.</p>
<p>We <em>manually</em> created the following test files:</p>
<ul>
<li>test/app/list_test.exs</li>
<li>test/app/list_items_test.exs</li>
</ul>
<p>Inside the test files we have all the tests necessary 
to build the <em>baseline</em> <code>lists</code> features. 
e.g:</p>
<pre><code class="language-elixir">
</code></pre>
<blockquote>
<p><strong>TODO</strong>: hyperlink these two files, once they are merged into <code>main</code>.</p>
</blockquote>
<p>Rather than <em>duplicating</em> large blocks of test code here,
we refer readers to the source (hyperlinked above).
The tests were written in the order they appear in the files
and the corresponding functions to make the tests pass
were created as needed.
Thus ensuring we only have code that is required
to deliver the features.</p>
<p>The main functions to pay attention to 
in the newly created files are:
<code>create_list/1</code> 
that creates a new <code>list</code>
and
<code>add_list_item/4</code> 
which adds an <code>item</code> to a <code>list</code>.
Both are dead simple and well-documented.</p>
<h3 id="create_list1"><a class="header" href="#create_list1"><code>create_list/1</code></a></h3>
<p><code>create_list/1</code> receives a <code>Map</code> of <code>attrs</code> (attributes)
which it validates using <code>changeset/2</code> function
and then inserts into the <code>lists</code> table
via the <code>PaperTrail.insert()</code> function:</p>
<pre><code class="language-elixir">def create_list(attrs) do
  %List{}
  |&gt; changeset(attrs)
  |&gt; PaperTrail.insert()
end
</code></pre>
<p>The <code>attrs</code> are just
<code>person_id</code> the <code>id</code> of the <code>person</code> creating the list, 
<code>text</code> the name/description of the list 
and <code>status</code> (optional).</p>
<p>If you are new to the <code>PaperTrail</code> package and the benefits it offers,
we wrote a quick intro:
<a href="https://github.com/dwyl/phoenix-papertrail-demo">dwyl/phoenix-papertrail-demo</a></p>
<p>The gist is this: it gives us version history for records in our database
without any query overhead. </p>
<h2 id="add_list_item4"><a class="header" href="#add_list_item4"><code>add_list_item/4</code></a></h2>
<p><code>add_list_item/4</code> as you would expect,
adds an <code>item</code> to a <code>list</code> for the given <code>person_id</code></p>
<pre><code class="language-elixir">def add_list_item(item, list, person_id, position) do
  %ListItem{
    item: item,
    list: list,
    person_id: person_id,
    position: position
  }
  |&gt; changeset()
  |&gt; Repo.insert()
end
</code></pre>
<p>The first 3 arguments are self-explanatory;
the final one, <code>position</code> is there to help us <em>order</em> the <code>list</code>!
As you may have noticed in the <code>mix gen.schema</code> command above
for the <code>list_items</code> table, the <code>position</code> field is a <code>Float</code>. 
e.g: <code>1.0</code>. 
We have very deliberately chosen a <code>Float</code> not an <code>Integer</code>
so that we can use this for easy append-only positional sorting. 
More on this later in the &quot;Reordering&quot; chapter. 
But if you want to see the discussion/history 
of how we arrived at this,
see: 
<a href="https://github.com/dwyl/mvp/issues/145#issuecomment-1492132575">dwyl/mvp#145</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
