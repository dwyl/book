<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Reordering - dwyl book</title>


        <!-- Custom HTML head -->
        <script defer data-domain="dwyl.github.io" src="https://plausible.io/js/script.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        
        <!-- additional languages -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/elixir.min.js"></script>
        
        <script>hljs.highlightAll();</script>

        <meta name="description" content="The @dwyl book on Web &amp; Mobile Application Development">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../fields/index.html"><strong aria-hidden="true">1.</strong> Fields</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fields/01-setup.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../fields/02-schema.html"><strong aria-hidden="true">1.2.</strong> Schema</a></li></ol></li><li class="chapter-item expanded "><a href="../auth/index.html"><strong aria-hidden="true">2.</strong> Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../auth/00-why.html"><strong aria-hidden="true">2.1.</strong> Why build Auth?</a></li><li class="chapter-item expanded "><a href="../auth/01-what.html"><strong aria-hidden="true">2.2.</strong> What are we building?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../auth/02-database-schema-review.html"><strong aria-hidden="true">2.2.1.</strong> Quick Review of Old Database Schema</a></li></ol></li><li class="chapter-item expanded "><a href="../auth/03-how.html"><strong aria-hidden="true">2.3.</strong> How?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../auth/04-prerequisites.html"><strong aria-hidden="true">2.3.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="../auth/05-mix-phx-new.html"><strong aria-hidden="true">2.3.2.</strong> Create New Phoenix Project</a></li><li class="chapter-item expanded "><a href="../auth/06-mix-gen-auth.html"><strong aria-hidden="true">2.3.3.</strong> Generate Auth Schema</a></li><li class="chapter-item expanded "><a href="../auth/07-notes-on-naming.html"><strong aria-hidden="true">2.3.4.</strong> Notes on Naming</a></li><li class="chapter-item expanded "><a href="../auth/08-modals-antipattern.html"><strong aria-hidden="true">2.3.5.</strong> Modals Are An Antipattern</a></li><li class="chapter-item expanded "><a href="../auth/09-encrypt-data.html"><strong aria-hidden="true">2.3.6.</strong> Encrypt Personal Data</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../atm/index.html"><strong aria-hidden="true">3.</strong> ATM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../atm/01-browser-agent.html"><strong aria-hidden="true">3.1.</strong> Parse User Agent</a></li><li class="chapter-item expanded "><a href="../atm/02-gen-schema-user_agents.html"><strong aria-hidden="true">3.2.</strong> User Agent Schema</a></li></ol></li><li class="chapter-item expanded "><a href="../mvp/index.html"><strong aria-hidden="true">4.</strong> MVP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../mvp/15-item-cid.html"><strong aria-hidden="true">4.1.</strong> Content IDs</a></li><li class="chapter-item expanded "><a href="../mvp/16-lists.html"><strong aria-hidden="true">4.2.</strong> Lists</a></li><li class="chapter-item expanded "><a href="../mvp/18-reordering.html" class="active"><strong aria-hidden="true">4.3.</strong> Reordering</a></li><li class="chapter-item expanded "><a href="../mvp/19-add-item-to-list.html"><strong aria-hidden="true">4.4.</strong> Add item to list</a></li><li class="chapter-item expanded "><a href="../mvp/20-stats.html"><strong aria-hidden="true">4.5.</strong> Stats</a></li><li class="chapter-item expanded "><a href="../mvp/22-enhance-tags-page.html"><strong aria-hidden="true">4.6.</strong> Tags Page Enhanced</a></li></ol></li><li class="chapter-item expanded "><a href="../tidy/index.html"><strong aria-hidden="true">5.</strong> Tidy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tidy/01-setup.html"><strong aria-hidden="true">5.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../tidy/02-schema.html"><strong aria-hidden="true">5.2.</strong> Schema</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dwyl book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dwyl/book/tree/main/src" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/dwyl/book/edit/main/src/mvp/18-reordering.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="reordering-items-in-a-list"><a class="header" href="#reordering-items-in-a-list">Reordering <code>items</code> in a <code>list</code></a></h1>
<p>The <code>people</code> who
<a href="https://github.com/dwyl/mvp/issues/140">tested</a>
the <code>MVP</code>
noted that the ability to <strong><em>organise</em> their <code>items</code></strong>
as an <strong><em>essential</em> feature</strong>:
<a href="https://github.com/dwyl/mvp/issues/145">dwyl/mvp#145</a></p>
<p>With the addition of <code>lists</code>
we now have a way of <em>organising</em> our <code>items</code>
using the <code>list.seq</code> or <code>sequence</code>.</p>
<p>This chapter will take you through how we implented reordering
in the <code>MVP</code> from first principals.</p>
<blockquote>
<p><strong>Note</strong>: There is quite a lot to cover in this chapter,
so we have created two <em>standalone</em>
tutorials:
<a href="https://github.com/dwyl/learn-alpine.js/blob/main/drag-and-drop.md">drag-and-drop</a>
and
<a href="https://github.com/dwyl/phoenix-liveview-realtime-cursor-tracking-tutorial">cursor-tracking</a>
which detail the mechanics of dragging and dropping <code>items</code>
and cursor tracking across browsers/devices.
If you are totally new to drag-and-drop,
we suggest following at least that one for full context.</p>
</blockquote>
<p>At the end of this chapter you will be able to reorder the <code>items</code> in a <code>list</code>
with cursor tracking and <code>item</code> highlighting:</p>
<p><img width="1728" alt="mvp-reordering-hero-screenshot" 
    src="https://github.com/dwyl/mvp/assets/194400/13753b38-2553-4d59-beb9-54bb9d16e0e0"></p>
<h2 id="getset-listcid-in-mount3"><a class="header" href="#getset-listcid-in-mount3">Get/Set <code>list.cid</code> in <code>mount/3</code></a></h2>
<p>In order for us to know which <code>list</code>
the <code>person</code> is viewing - and thus reordering -
we need to add it to the <code>socket.assigns</code> in the <code>mount/3</code> function.
Open the <code>lib/app_web/live/app_live.ex</code> file
and locate the <code>mount/3</code> function.</p>
<p>Add the following lines to the body:</p>
<pre><code class="language-elixir"># Create or Get the "all" list for the person_id
all_list = App.List.get_all_list_for_person(person_id)
# Temporary function to add All *existing* items to the "All" list:
App.List.add_all_items_to_all_list_for_person_id(person_id)
</code></pre>
<p>This is invoking two functions we previously created in <code>lists</code>.</p>
<p>Then in the returned tuple:</p>
<pre><code class="language-elixir">{:ok,
     assign(socket,
       items: items,
       etc.
</code></pre>
<p>Make sure to add the line:</p>
<pre><code class="language-elixir">       list_cid: all_list.cid,
</code></pre>
<p>That will ensure that we know the <code>list.cid</code>
later when the <code>person</code> reorders their <code>items</code>.</p>
<h2 id="moving-items-in-the-interface"><a class="header" href="#moving-items-in-the-interface">Moving <code>items</code> in the interface</a></h2>
<p>There is quite a lot of code required
to move <code>items</code> in the interface,
we need to update 4 files.</p>
<h3 id="update-the-li"><a class="header" href="#update-the-li">Update the <code>&lt;li&gt;</code></a></h3>
<p>In the <code>lib/app_web/live/app_live.html.heex</code> file,
locate the <code>&lt;ul&gt;</code> (unordered list) defintion:</p>
<pre><code class="language-html">  &lt;!-- List of items with inline buttons and controls --&gt;
  &lt;ul class="w-full"&gt;
    &lt;%= for item &lt;- filter_items(@items, @filter, @filter_tag) do %&gt;
      &lt;li
        data-id={item.id}
        class="mt-2 flex w-full border-t border-slate-200 py-2"
      &gt;
</code></pre>
<p>Replace it with the following:</p>
<pre><code class="language-html">  &lt;!-- List of items with inline buttons and controls --&gt;
  &lt;ul id="items" phx-hook="Items" x-data="{selectedItem: null}" class="w-full"&gt;
    &lt;%= for item &lt;- filter_items(@items, @filter, @filter_tag) do %&gt;
      &lt;li
        id={"item-#{item.id}"}
        data-id={item.id}
        class={"mt-2 flex flex-col w-full border-t border-slate-200 py-2 item 
            #{if item.id == @editing do 'cursor-default' else 'cursor-grab' end}"}
        draggable={"#{if item.id == @editing do 'false' else 'true' end}"}
        x-data="{selected: false}"
        x-on:dragstart="selected = true; $dispatch('highlight', {id: $el.id}); selectedItem = $el"
        x-on:dragend="selected = false; $dispatch('remove-highlight', {id: $el.id}); selectedItem = null; $dispatch('update-indexes', {fromItemId: $el.dataset.id})"
        x-bind:class="selected ?? 'cursor-grabbing'"
        x-on:dragover.throttle="$dispatch('dragoverItem', {selectedItemId: selectedItem.id, currentItem: $el})"
        data-highlight={JS.add_class("bg-teal-300")}
        data-remove-highlight={JS.remove_class("bg-teal-300")}
      &gt;
</code></pre>
<p>There's a <em>lot</em> going on in this definition.
But it's all related to 5 key areas:</p>
<ol>
<li><em>Select</em> an <code>item</code> to be moved/reordered</li>
<li><em>Add</em> a highlight when an <code>item</code> is selected</li>
<li>_Display) the appropriate <code>cursor-grabbing</code> class when the <code>item</code> is selected.</li>
<li><em>Dispatch</em> the <code>dragoverItem</code> event so that other connected clients can see the <code>item</code> being moved</li>
<li><em>Remove</em> the <code>highlight</code> when the <code>item</code> is no longer selected.</li>
</ol>
<blockquote>
<p><strong>Note</strong>: if you feel this section could benefit from further explanation,
please <em>first</em> read:
<a href="https://github.com/dwyl/learn-alpine.js/blob/main/drag-and-drop.md">drag-and-drop</a>
and
<a href="https://github.com/dwyl/phoenix-liveview-realtime-cursor-tracking-tutorial">cursor-tracking</a>
And if anything is still unclear,
please open an issue:
<a href="https://github.com/dwyl/book/issues">dwyl/book/issues</a></p>
</blockquote>
<h2 id="add-js-event-handling-code"><a class="header" href="#add-js-event-handling-code">Add <code>JS</code> event handling code:</a></h2>
<p>In the <code>assets/js/app.js</code> file,
add the following code:</p>
<pre><code class="language-js">// Drag and drop highlight handlers
window.addEventListener("phx:highlight", (e) =&gt; {
  document.querySelectorAll("[data-highlight]").forEach(el =&gt; {
    if(el.id == e.detail.id) {
        liveSocket.execJS(el, el.getAttribute("data-highlight"))
    }
  })
})

// Item id of the destination in the DOM
let itemId_to;

let Hooks = {}
Hooks.Items = {
  mounted() {
    const hook = this

    this.el.addEventListener("highlight", e =&gt; {
      hook.pushEventTo("#items", "highlight", {id: e.detail.id})
      // console.log('highlight', e.detail.id)
    })

    this.el.addEventListener("remove-highlight", e =&gt; {
      hook.pushEventTo("#items", "removeHighlight", {id: e.detail.id})
      // console.log('remove-highlight', e.detail.id)
    })

    this.el.addEventListener("dragoverItem", e =&gt; {
      // console.log("dragoverItem", e.detail)
      const currentItemId = e.detail.currentItem.id
      const selectedItemId = e.detail.selectedItemId
      if( currentItemId != selectedItemId) {
        hook.pushEventTo("#items", "dragoverItem", {currentItemId: currentItemId, selectedItemId: selectedItemId})
        itemId_to = e.detail.currentItem.dataset.id
      }
    })

    this.el.addEventListener("update-indexes", e =&gt; {
      const item_id = e.detail.fromItemId 
      const list_ids = get_list_item_cids()
      console.log("update-indexes", e.detail, "list: ", list_ids)
      // Check if both "from" and "to" are defined
      if(item_id &amp;&amp; itemId_to &amp;&amp; item_id != itemId_to) {
        hook.pushEventTo("#items", "update_list_seq", 
          {seq: list_ids})
      }
      
      itemId_to = null;
    })
  }
}

/**
 * `get_list_item_ids/0` retrieves the full `list` of visible `items` form the DOM
 * and returns a String containing the IDs as a space-separated list e.g: "1 2 3 42 71 93"
 * This is used to determine the `position` of the `item` that has been moved.
 */
function get_list_item_cids() {
  console.log("invoke get_list_item_ids")
  const lis = document.querySelectorAll("label[phx-value-cid]");
  return Object.values(lis).map(li =&gt; {
    return li.attributes["phx-value-cid"].nodeValue
  }).join(",")
}

window.addEventListener("phx:remove-highlight", (e) =&gt; {
  document.querySelectorAll("[data-highlight]").forEach(el =&gt; {
    if(el.id == e.detail.id) {
        liveSocket.execJS(el, el.getAttribute("data-remove-highlight"))
    }
  })
})

window.addEventListener("phx:dragover-item", (e) =&gt; {
  console.log("phx:dragover-item", e.detail)
  const selectedItem = document.querySelector(`#${e.detail.selected_item_id}`)
  const currentItem = document.querySelector(`#${e.detail.current_item_id}`)

  const items = document.querySelector('#items')
  const listItems = [...document.querySelectorAll('.item')]

  if(listItems.indexOf(selectedItem) &lt; listItems.indexOf(currentItem)){
    items.insertBefore(selectedItem, currentItem.nextSibling)
  }

  if(listItems.indexOf(selectedItem) &gt; listItems.indexOf(currentItem)){
    items.insertBefore(selectedItem, currentItem)
  }
})
</code></pre>
<p>Again, there's a fair amount of code there
so take a moment to step through it
and understand what each event listener does.</p>
<h2 id="handle-event-in-liveview"><a class="header" href="#handle-event-in-liveview">Handle event in <code>LiveView</code></a></h2>
<p>Back in the <code>LiveView</code> file,
<code>lib/app_web/live/app_live.ex</code>
add the following event handlers:</p>
<pre><code class="language-elixir"> @impl true
  def handle_event("highlight", %{"id" =&gt; id}, socket) do
    # IO.puts("highlight: #{id}")
    AppWeb.Endpoint.broadcast(@topic, "move_items", {:drag_item, id})
    {:noreply, socket}
  end

  @impl true
  def handle_event("removeHighlight", %{"id" =&gt; id}, socket) do
    # IO.puts("removeHighlight: #{id}")
    AppWeb.Endpoint.broadcast(@topic, "move_items", {:drop_item, id})
    {:noreply, socket}
  end

  @impl true
  def handle_event(
        "dragoverItem",
        %{
          "currentItemId" =&gt; current_item_id,
          "selectedItemId" =&gt; selected_item_id
        },
        socket
      ) do
    # IO.puts("285: current_item_id: #{current_item_id}, selected_item_id: #{selected_item_id} | #{Useful.typeof(selected_item_id)}")
    AppWeb.Endpoint.broadcast(
      @topic,
      "move_items",
      {:dragover_item, {current_item_id, selected_item_id}}
    )

    {:noreply, socket}
  end

  @impl true
  def handle_info(
        %Broadcast{
          event: "move_items",
          payload: {:dragover_item, {current_item_id, selected_item_id}}
        },
        socket
      ) do
    # IO.puts(
    #   "cur_item_id: #{current_item_id}, selected_item_id: #{selected_item_id}"
    # )

    {:noreply,
     push_event(socket, "dragover-item", %{
       current_item_id: current_item_id,
       selected_item_id: selected_item_id
     })}
  end

  @impl true
  def handle_info(
        %Broadcast{event: "move_items", payload: {:drag_item, item_id}},
        socket
      ) do
    {:noreply, push_event(socket, "highlight", %{id: item_id})}
  end

  @impl true
  def handle_info(
        %Broadcast{event: "move_items", payload: {:drop_item, item_id}},
        socket
      ) do
    {:noreply, push_event(socket, "remove-highlight", %{id: item_id})}
  end


  @impl true
  def handle_event(
        "update_list_seq",
        %{"seq" =&gt; seq},
        socket
      ) do
    list_cid = get_list_cid(socket.assigns)
    person_id = get_person_id(socket.assigns)
    App.List.update_list_seq(list_cid, person_id, seq)
    {:noreply, socket}
  end
</code></pre>
<h3 id="handle-the-update_list_seq-event"><a class="header" href="#handle-the-update_list_seq-event">Handle the <code>update_list_seq</code> event</a></h3>
<p>All the <code>highlight</code>, <code>remove-highlight</code> and <code>move_items</code>
handlers are for presentation and synching between clients.
The handler that performs the actual <code>list</code> updating is:</p>
<pre><code class="language-elixir">  @impl true
  def handle_event(
        "update_list_seq",
        %{"seq" =&gt; seq},
        socket
      ) do
    list_cid = get_list_cid(socket.assigns)
    person_id = get_person_id(socket.assigns)
    App.List.update_list_seq(list_cid, person_id, seq)
    {:noreply, socket}
  end
</code></pre>
<p>This receives the <code>seq</code> (sequence of <code>item.cid</code>)
from the client and and updates the <code>list.seq</code>
using the previously defined <code>update_list_seq/3</code> function.</p>
<p>With this code in place we now have everything we need for reordering <code>items</code> on a <em>single</em> <code>list</code>.
Try it!</p>
<h2 id="add-a-test"><a class="header" href="#add-a-test">Add a Test!</a></h2>
<p>To ensure this feature is tested,
open the
<code>test/app_web/live/app_live_test.exs</code>
file and add the following test:</p>
<pre><code class="language-elixir">  test "Drag and Drop item", %{conn: conn} do
    person_id = 0
    # Creating Three items
    {:ok, %{model: item}} =
      Item.create_item(%{text: "Learn Elixir", person_id: person_id, status: 2})

    {:ok, %{model: item2}} =
      Item.create_item(%{ text: "Build Awesome App", person_id: person_id, status: 2})

    {:ok, %{model: item3}} =
      Item.create_item(%{ text: "Profit", person_id: person_id, status: 2})

    # Create "all" list for this person_id:
    list = App.List.get_all_list_for_person(person_id)

    # Add all items to "all" list:
    App.List.add_all_items_to_all_list_for_person_id(person_id)

    # Render LiveView
    {:ok, view, _html} = live(conn, "/")

    # Highlight broadcast should have occurred
    assert render_hook(view, "highlight", %{"id" =&gt; item.id})
      |&gt; String.split("bg-teal-300")
      |&gt; Enum.drop(1)
      |&gt; length() &gt; 0

    # Dragover and remove highlight
    render_hook(view, "dragoverItem", %{
      "currentItemId" =&gt; item2.id,
      "selectedItemId" =&gt; item.id
    })

    assert render_hook(view, "removeHighlight", %{"id" =&gt; item.id})

    # reorder items:
    render_hook(view, "updateIndexes", %{
      "seq" =&gt; "#{item.cid},#{item2.cid},#{item3.cid}"
    })

    all_list = App.List.get_all_list_for_person(person_id)
    seq = App.List.get_list_seq(all_list)
    pos1 = Enum.find_index(seq, fn x -&gt; x == "#{item.cid}" end)
    pos2 = Enum.find_index(seq, fn x -&gt; x == "#{item2.cid}" end)
    # IO.puts("#{pos1}: #{item.cid}")
    # IO.puts("#{pos2}: #{item2.cid}")

    assert pos1 &lt; pos2

    # Update list_item.seq:
    {:ok, %{model: list}} = App.List.update_list_seq(list.cid, person_id, 
        "#{item.cid},#{item3.cid},#{item2.cid}")
    new_seq = list.seq |&gt; String.split(",")
    # dbg(new_seq)
    pos2 = Enum.find_index(new_seq, fn x -&gt; x == "#{item2.cid}" end)
    pos3 = Enum.find_index(new_seq, fn x -&gt; x == "#{item3.cid}" end)
    assert pos3 &lt; pos2
  end
</code></pre>
<p>Again, there's a <em>lot</em> going on in this test
because it's testing for
both the <code>highlight</code>
<em>and</em> the update of the <code>seq</code> (sequence of <code>item.cid</code>) in the <code>list</code>.
Take a momemnt to step through it and if you have any questions, ask!</p>
<p>A good place to read all the code for this in one place is:
https://github.com/dwyl/mvp/pull/345/files</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../mvp/16-lists.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../mvp/19-add-item-to-list.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../mvp/16-lists.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../mvp/19-add-item-to-list.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
