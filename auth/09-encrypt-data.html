<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encrypt Personal Data - dwyl book</title>


        <!-- Custom HTML head -->
        <script defer data-domain="dwyl.github.io" src="https://plausible.io/js/script.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        
        <!-- additional languages -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/elixir.min.js"></script>
        
        <script>hljs.highlightAll();</script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../auth/index.html"><strong aria-hidden="true">1.</strong> Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../auth/00-why.html"><strong aria-hidden="true">1.1.</strong> Why build Auth?</a></li><li class="chapter-item expanded "><a href="../auth/01-what.html"><strong aria-hidden="true">1.2.</strong> What are we building?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../auth/02-database-schema-review.html"><strong aria-hidden="true">1.2.1.</strong> Quick Review of Old Database Schema</a></li></ol></li><li class="chapter-item expanded "><a href="../auth/03-how.html"><strong aria-hidden="true">1.3.</strong> How?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../auth/04-prerequisites.html"><strong aria-hidden="true">1.3.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="../auth/05-mix-phx-new.html"><strong aria-hidden="true">1.3.2.</strong> Create New Phoenix Project</a></li><li class="chapter-item expanded "><a href="../auth/06-mix-gen-auth.html"><strong aria-hidden="true">1.3.3.</strong> Generate Auth Schema</a></li><li class="chapter-item expanded "><a href="../auth/07-notes-on-naming.html"><strong aria-hidden="true">1.3.4.</strong> Notes on Naming</a></li><li class="chapter-item expanded "><a href="../auth/08-modals-antipattern.html"><strong aria-hidden="true">1.3.5.</strong> Modals Are An Antipattern</a></li><li class="chapter-item expanded "><a href="../auth/09-encrypt-data.html" class="active"><strong aria-hidden="true">1.3.6.</strong> Encrypt Personal Data</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../atm/index.html"><strong aria-hidden="true">2.</strong> ATM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../atm/01-browser-agent.html"><strong aria-hidden="true">2.1.</strong> Parse User Agent</a></li><li class="chapter-item expanded "><a href="../atm/02-gen-schema-user_agents.html"><strong aria-hidden="true">2.2.</strong> User Agent Schema</a></li></ol></li><li class="chapter-item expanded "><a href="../mvp/index.html"><strong aria-hidden="true">3.</strong> MVP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../mvp/16-lists.html"><strong aria-hidden="true">3.1.</strong> Lists</a></li><li class="chapter-item expanded "><a href="../mvp/17-list_items.html"><strong aria-hidden="true">3.2.</strong> Lists Items</a></li><li class="chapter-item expanded "><a href="../mvp/18-reordering.html"><strong aria-hidden="true">3.3.</strong> Reordering</a></li><li class="chapter-item expanded "><a href="../mvp/20-stats.html"><strong aria-hidden="true">3.4.</strong> Stats</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dwyl book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dwyl/book/tree/main/src" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/dwyl/book/edit/main/src/auth/09-encrypt-data.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="encrypt-personal-data"><a class="header" href="#encrypt-personal-data">Encrypt Personal Data</a></h1>
<p>As previously noted
the schema created by the 
<code>phx.gen.auth</code> generator
leaves <strong><code>email</code></strong> addresses stored 
as 
<a href="https://en.wikipedia.org/wiki/Plaintext"><strong><code>plaintext</code></strong></a>:</p>
<p><img src="https://user-images.githubusercontent.com/194400/223880353-98597d83-cb9c-424d-bcb0-2121ecd743c0.png" alt="mix-phx-gen-auth-people-table-email-plaintext" /></p>
<p>It's disappointing to us 
that this is the <code>default</code>
and many devs
will <em>naively</em> think this is &quot;OK&quot;.</p>
<h2 id="its-never-ok-to-store-personal-data-as-plaintext"><a class="header" href="#its-never-ok-to-store-personal-data-as-plaintext">It's <em>Never</em> &quot;OK&quot; to Store Personal Data as <code>plaintext</code></a></h2>
<p>It might be <em>tempting</em> 
to store personal data as 
human-readable text
during development
to make it easier to debug,
but we urge <em>everyone</em>
to resist this temptation!
<a href="https://en.wikipedia.org/wiki/Data_breach">Data breaches</a>
happen <em>every</em> day.
Breaches can <em>destroy</em> the reputation
of a company.
Thankfully,
the EU now has stronger laws
in the form of the
<a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">General Data Protection Regulation</a>
(GDPR),
which carry heavy fines
for companies
that improperly store personal data.</p>
<p>Most software engineers don't consider
the law(s) around data protection
but none of us have <em>any</em> excuse 
to ignore them even in basic projects.
The good news is:
protecting personal data
is quite straightforward.</p>
<h2 id="why-encrypt-now"><a class="header" href="#why-encrypt-now">Why Encrypt <em>Now</em>?</a></h2>
<p>We <em>know</em> this might feel like a deeply technical
step to have so early on in 
the creation of the <code>auth</code> App.
Why don't we just <em>skip</em> this 
and focus on the interface <code>people</code> will <em>see</em>?
We feel that getting the data privacy/security
right from the <em>start</em>
is essential for building a robust
and therefore trustworthy app. 
We will get to the interface design 
in the next chapter
so if you prefer that part,
feel free to speed-read/run this
and only return to it when you 
need a deeper understanding.</p>
<h2 id="how-to-encrypt-sensitive-data"><a class="header" href="#how-to-encrypt-sensitive-data">How To Encrypt Sensitive Data?</a></h2>
<p>When we first started using <code>Elixir</code> in 2016
we explored the topic of 
encrypting personal data in <em>depth</em>
and wrote a comprehensive guide:
<a href="https://github.com/dwyl/phoenix-ecto-encryption-example"><code>dwyl/phoenix-ecto-encryption-example</code></a>
We <em>highly</em> recommend following step-by-step guide
to understand this in detail.
We aren't going to duplicate/repeat 
any of the <em>theory</em> here. 
Rather we are going to focus on 
the <em>practice</em> using
the 
<a href="https://github.com/dwyl/fields"><code>fields</code></a>
package we created
to implement transparent encryption.</p>
<h2 id="using-fields-to-automatically-encrypt-personal-data"><a class="header" href="#using-fields-to-automatically-encrypt-personal-data">Using <code>Fields</code> to <em>Automatically</em> Encrypt Personal Data</a></h2>
<p>Following the instructions in the 
<a href="https://github.com/dwyl/fields"><code>fields</code></a>
repo, open the <code>mix.exs</code> file
and locate the <code>defp deps do</code> section
and add <code>fields</code> to the list:</p>
<pre><code class="language-elixir">{:fields, &quot;~&gt; 2.10.3&quot;},
</code></pre>
<p>Save the <code>mix.exs</code> file and run:</p>
<pre><code class="language-sh">mix deps.get
</code></pre>
<h3 id="create-environment-variables"><a class="header" href="#create-environment-variables">Create Environment Variables</a></h3>
<p><code>fields</code> expects an `environment variable</p>
<p>e.g. using the <a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Secret.html"><code>phx.gen.secret</code></a> command:</p>
<pre><code class="language-sh">mix phx.gen.secret
</code></pre>
<p>You should see output similar to:</p>
<pre><code class="language-sh">XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
</code></pre>
<p>Export this key in your terminal with the following command:</p>
<pre><code class="language-sh">export ENCRYPTION_KEYS=XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
</code></pre>
<p>Run the <code>phx.gen.secret</code> command again 
and export it as <code>SECRET_KEY_BASE</code>, e.g:</p>
<pre><code class="language-sh">export SECRET_KEY_BASE=GLH2S6EU0eZt+GSEmb5wEtonWO847hsQ9fck0APr4VgXEdp9EKfni2WO61z0DMOF
</code></pre>
<p>We use an <code>.env</code> file on <code>localhost</code>:</p>
<pre><code class="language-sh">export ENCRYPTION_KEYS=XGYVueuky4DT0s0ks2MPzHpucyl+9e/uY4UusEfgyR2qeNApzoYGSH+Y55cfDj1Y
export SECRET_KEY_BASE=GLH2S6EU0eZt+GSEmb5wEtonWO847hsQ9fck0APr4VgXEdp9EKfni2WO61z0DMOF
</code></pre>
<p>See:
<a href="https://github.com/dwyl/auth/blob/main/.env_sample"><code>.env_sample</code></a> 
for a sample including 
all the recommended/required environment variables
for running the <code>auth</code> app.</p>
<p>Now to the <em>interesting</em> part!</p>
<h2 id="update-peopleemail-data-type"><a class="header" href="#update-peopleemail-data-type">Update <code>people.email</code> Data Type</a></h2>
<p>The <code>phx.gen.auth</code> generator
created the <code>people</code> schema
with the <code>:email</code> field defined as a <code>:string</code>:</p>
<pre><code class="language-sh">field :email, :string
</code></pre>
<p>See: 
<a href="https://github.com/dwyl/auth/blob/da0af7ee702c278714b47f92045edce4adad542a/lib/auth/accounts/person.ex#L6"><code>lib/auth/accounts/person.ex#L6</code></a></p>
<h3 id="create-migration-file"><a class="header" href="#create-migration-file">Create Migration File</a></h3>
<p>Using <a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html#module-creating-your-first-migration"><code>Ecto.Migration</code></a>
run the following command 
to create a migration file 
with a descriptive name:</p>
<pre><code class="language-sh">mix ecto.gen.migration modify_people_email_string_binary
</code></pre>
<p>You should see output similar to:</p>
<pre><code class="language-sh">* creating priv/repo/migrations/20230309145958_modify_people_email_string_binary.exs
</code></pre>
<p>Open the file in your editor. You should see:</p>
<pre><code class="language-elixir">defmodule Auth.Repo.Migrations.ModifyPeopleEmailStringBinary do
  use Ecto.Migration

  def change do

  end
end
</code></pre>
<p>Update it to include the <code>alter</code> statement:</p>
<pre><code class="language-elixir">defmodule Auth.Repo.Migrations.ModifyPeopleEmailStringBinary do
  use Ecto.Migration

  def change do
    alter table(:people) do
      remove :email
      add :email, :binary
      add ...
    end

    alter table(:people_tokens) do
      remove :sent_to
      add :sent_to, :binary
    end
  end
end
</code></pre>
<blockquote>
<p><strong>Note</strong>: we tried using 
<a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html#modify/3"><code>Ecto.Migration.modify/3</code></a>
to modify the field type
but got the error:</p>
</blockquote>
<pre><code class="language-sh">15:06:13.691 [info] alter table people
** (Postgrex.Error) ERROR 42804 (datatype_mismatch) column &quot;email&quot; cannot be cast automatically to type bytea

    hint: You might need to specify &quot;USING email::bytea&quot;.
</code></pre>
<p>Given that this is a new project 
and there is no data in the DB,
we decided it was easier 
to remove and re-add the <code>email</code> column/field.</p>
<p>Save the migration file and run:</p>
<pre><code class="language-sh">mix ecto.reset
</code></pre>
<p>You should see output similar to the following:</p>
<pre><code class="language-sh">15:13:29.989 [info] == Migrated 20230226095715 in 0.0s

15:13:30.057 [info] == Running 20230309145958 Auth.Repo.Migrations.ModifyPeopleEmailStringBinary.change/0 forward

15:13:30.058 [info] alter table people

15:13:30.059 [info] alter table people_tokens

15:13:30.059 [info] == Migrated 20230309145958 in 0.0s
</code></pre>
<p>###¬†Update <code>person.email</code></p>
<p>Open 
<code>lib/auth/accounts/person.ex</code>
and replace the line:</p>
<pre><code class="language-elixir">field :email, :string
</code></pre>
<p>With:</p>
<pre><code class="language-elixir">field :email, Fields.EmailEncrypted
field :email_hash, Fields.EmailHash
</code></pre>
<p>Sadly, this <em>essential</em> privacy/security enhancement 
was not quite as straightforward as we had hoped 
and had quite a few ramifications.
The boilerplate code 
generated by <code>phx.gen.auth</code>
was relying on <code>person.email</code> being <code>plaintext</code>
so we ended up having to make several changes.</p>
<p>Rather than repeating all of these here
which will take up a <em>lot</em> of space
and duplicate the code unessessarily,
we recommend you read through the git commit:
<a href="https://github.com/dwyl/auth/pull/231/commits/2bbba99c7057f0d2943dd8327be52ccf1a1bd58c"><code>#2bbba99</code></a></p>
<p>In a follow-up section 
we will be removing most of this code
because we don't <em>want</em> to
use links in emails to verify <code>people</code>.
Instead we will be using one-time-numeric codes.</p>
<p>Following the changes made in: 
<a href="https://github.com/dwyl/auth/pull/231/commits/2bbba99c7057f0d2943dd8327be52ccf1a1bd58c"><code>#2bbba99</code></a></p>
<p>If we now run a query to view the data in the <code>people</code> table:</p>
<pre><code class="language-sql">SELECT id, email, inserted_at FROM people;
</code></pre>
<p>We see that the <code>email</code> is now a binary blob, 
i.e: <em>encrypted</em>:</p>
<img width="1096" alt="image" src="https://user-images.githubusercontent.com/194400/224109679-0084ae9d-a1e8-48f2-a083-94aff46d7137.png">
<p>This cannot be read by anyone 
who does not have the encryption key.
So if the database is somehow compromised,
it's <em>useless</em> to the attacker. </p>
<p>Registration and Login still works as expected:</p>
<img width="1159" alt="image" src="https://user-images.githubusercontent.com/194400/224111036-7a4e5764-8966-4b97-aaea-515c8e3b7fd4.png">
<p>But now the personal data 
captured in registration is stored 
<strong><code>encrypted</code></strong> at rest 
the way it should be. üîê </p>
<p>Now we can get on with <em>building</em> <code>auth</code>!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../auth/08-modals-antipattern.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../atm/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../auth/08-modals-antipattern.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../atm/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
